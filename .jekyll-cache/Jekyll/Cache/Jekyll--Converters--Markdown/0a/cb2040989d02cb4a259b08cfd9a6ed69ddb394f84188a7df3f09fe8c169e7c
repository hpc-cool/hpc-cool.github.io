I"Ş<p>æœ¬æ–‡å‘Šè¯‰å¤§å®¶å¦‚ä½•åœ¨ Jenkins é…ç½®åˆå¹¶åˆ° release çš„å†…å®¹è‡ªåŠ¨åˆå¹¶åˆ° gitlab çš„ master åˆ†æ”¯</p>

<!--more-->

<!-- CreateTime:2019/8/30 8:54:58 -->

<!-- æ ‡ç­¾ï¼šJenkins -->

<p>é¦–å…ˆéœ€è¦ä¸¤ä¸ªä»“åº“ï¼Œä¸€ä¸ªæ˜¯ gitlab çš„ä»“åº“ï¼Œå¦ä¸€ä¸ªæ˜¯ Jenkins çš„ä»“åº“</p>

<p>å…ˆåœ¨ Jenkins ä»“åº“åšé…ç½®ï¼Œé¦–å…ˆè®¾ç½® Source Code Management é€‰æ‹©è‡ªå·±éœ€è¦çš„ä»“åº“å’Œè®¾ç½®å¥½çš„è´¦å·</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯0.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2018913184226191" alt="" /></p>

<p>ç„¶ååœ¨ Branches to build æ·»åŠ åˆ†æ”¯ï¼Œè¿™é‡Œéœ€è¦å°† release åˆ master æ‰€ä»¥å°±å¡«å†™ release å°±å¯ä»¥</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯1.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2018913184557380" alt="" /></p>

<p>åœ¨ Additional Behaviours æ·»åŠ ä¸‰ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯ Clean before checkout è¿™æ ·å¯ä»¥æ¸…ç©ºä»“åº“ï¼Œç¬¬äºŒä¸ªæ˜¯ Prune stale remote-tracking branches è®©æœ¬åœ°å’Œè¿œç¨‹åŒæ­¥ã€‚</p>

<p>æ³¨æ„ï¼Œç¬¬äºŒä¸ª Prune stale remote-tracking branches å¾ˆé‡è¦ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´ä¸Šä¼ äº†è¿™æ ·ä¸¤ä¸ªåˆ†æ”¯</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t</span><span class="p">/</span><span class="n">lindexi</span>
<span class="n">t</span><span class="p">/</span><span class="n">lindexi</span><span class="p">/</span><span class="n">github</span>
</code></pre></div></div>

<p>é‚£ä¹ˆå³ä½¿å°ä¼™ä¼´åœ¨ä¸Šä¼ ç¬¬ä¸€ä¸ªåˆ†æ”¯ä¹‹åï¼Œåˆ é™¤äº†ç¬¬ä¸€ä¸ªåˆ†æ”¯å†ä¸Šä¼ ç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œå¯èƒ½ Jenkins ä¹Ÿæ— æ³•åŠ è½½</p>

<p>ç¬¬ä¸‰ä¸ªå°±æ˜¯ Merge before build è¯·çœ‹å›¾ç‰‡ï¼Œè®¾ç½®ä»“åº“æ˜¯å“ªä¸ªï¼Œè®¾ç½®æ¨é€çš„åˆ†æ”¯</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯2.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F201891318473954" alt="" /></p>

<p>ä¸ºäº†åœ¨ç”¨æˆ·æ¨é€çš„æ—¶å€™åˆå¹¶ï¼Œå°±éœ€è¦åœ¨ Build Triggers æ·»åŠ  Build when a change is pushed to GitLab. è¿™æ ·å°±å¯ä»¥æ·»åŠ  web hook åœ¨æ‰“é’©ä¹‹åå¯ä»¥çœ‹åˆ°ä¸‹é¢æœ‰ä¸€ä¸ªé“¾æ¥ï¼Œå¦‚ä¸‹é¢æ˜¯æˆ‘çš„é“¾æ¥ï¼Œè¿™ä¸ªé“¾æ¥ä¼šåœ¨ä¹‹åè®¾ç½®åˆ° gitlab æ‰€ä»¥æš‚æ—¶éœ€è¦è®°ä¸‹</p>

<p>https://newci.gz.lindexi.cn/project/lindexi/github_merge_release_to_dev</p>

<p>è¿™é‡Œå¯ä»¥é€šè¿‡å¾ˆå¤šä¸ªè®¾ç½®ï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">Push Events</code> æ‰§è¡Œè¿™ä¸ªä»“åº“æˆ–è€…åœ¨ <code class="language-plaintext highlighter-rouge">Accepted Merge Request Events</code> æ‰§è¡Œï¼Œå¯ä»¥å…¨éƒ¨æ‰“é’©</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯3.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F201891318535709" alt="" /></p>

<p>ä¸‹é¢å°±æ˜¯ Build è¿™é‡Œå¯ä»¥å†™ç¼–è¯‘çš„å†…å®¹ï¼Œæˆ‘ä¸‹é¢æ‰§è¡Œäº†ä¸€äº›ä»£ç </p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯4.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2018913185454746" alt="" /></p>

<p>åªæœ‰åœ¨ç¼–è¯‘æˆåŠŸæˆ‘æ‰å¯ä»¥è®© release åˆå¹¶åˆ° master åˆ†æ”¯ï¼Œå¦‚æœç¼–è¯‘ä¸æˆåŠŸå°±ä¸èƒ½åˆå¹¶</p>

<p>åœ¨ Post-build Actions æ·»åŠ  Git Publisher åŠŸèƒ½ï¼Œç¬¬ä¸€ä¸ªæ˜¯ Push Only If Build Succeeds ä¹Ÿå°±æ˜¯åœ¨ä¸Šé¢çš„ Build ç¼–è¯‘æˆåŠŸä¹‹åæ‰ä¼šæ‰§è¡Œ</p>

<p>ç‚¹å‡» Add Branch æ·»åŠ ä¸€ä¸ªæ–°çš„åˆå¹¶åˆ†æ”¯ï¼Œéœ€è¦ä» release åˆå¹¶åˆ° master å°±å¯ä»¥å’Œæˆ‘ä¸‹é¢ä¸€æ ·å†™ï¼Œå¦‚æœæ˜¯ä» release åˆå¹¶åˆ° dev åˆ†æ”¯å°±è‡ªå·±åœ¨ä¸‹é¢å†™ dev å°±å¯ä»¥</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯5.png)  -->

<p><img src="http://image.acmx.xyz/lindexi%2F2018913185852214" alt="" /></p>

<p>ç‚¹å‡»ä¿å­˜å°±è®¾ç½®å®Œæˆï¼Œä¸‹é¢å°±æ˜¯è®¾ç½® gitlab è®© gitlab å¯ä»¥æ”¯æŒ Jenkins æ¨é€</p>

<p>ç‚¹å‡»è®¾ç½®æˆå‘˜ï¼Œæ·»åŠ  Jenkins æˆå‘˜</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯6.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F201891319125120" alt="" /></p>

<p>ç‚¹å‡» Integrations æ·»åŠ  webhook è¿™é‡Œéœ€è¦å¡«å†™åˆšæ‰ Jenkins çš„é“¾æ¥ï¼Œæˆ‘çš„é“¾æ¥æ˜¯ https://newci.gz.lindexi.cn/project/lindexi/github_merge_release_to_dev å¤§å®¶å¯ä¸è¦æ²¡äº‹å°±æ¥æ”»å‡»æˆ‘çš„æœåŠ¡å™¨</p>

<p>å¡«å†™ä¹‹åéœ€è¦å‹¾é€‰ Push events è¿™æ ·æœ‰äººä¸Šä¼ å°±å¯ä»¥è‡ªåŠ¨åˆå¹¶ release åˆ° master è€Œä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨åˆå¹¶</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯7.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F201891319342834" alt="" /></p>

<p>åœ¨æ·»åŠ ä¹‹åå¯ä»¥çœ‹åˆ°æœ‰ Test æŒ‰é’®ï¼Œç‚¹å‡»å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ª push çš„æµ‹è¯•</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯8.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F201891319515759" alt="" /></p>

<p>ç‚¹å‡»æµ‹è¯•çœ‹ Jenkins æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œï¼Œå¦‚æœæœ‰å°±æ˜¯è®¾ç½®æˆåŠŸ</p>

<p>å¯èƒ½å› ä¸ºåˆå¹¶çš„ master åˆ†æ”¯æ²¡æœ‰æ¨é€ï¼Œéœ€è¦ç‚¹å‡» repository è®¾ç½® Protected Branches å…è®¸ maintainers æ¨é€ï¼Œè®¾ç½® Jenkins çš„è´¦å·æ˜¯ maintainers è¿™æ ·å°±å¯ä»¥æ¨é€</p>

<p>å¯èƒ½è¿™æ—¶ä¼šå‘ç°æ²¡æœ‰ <code class="language-plaintext highlighter-rouge">GitLab: This deploy key does not have write access to this project</code> å¯ä»¥åœ¨ repository è®¾ç½® Deploy Keys è¯·çœ‹ä¸‹é¢</p>

<!-- ![](image/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯/Jenkins é…ç½®è‡ªåŠ¨åˆå¹¶ release åˆ†æ”¯åˆ° master åˆ†æ”¯9.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2018913191115860" alt="" /></p>

<p>å…·ä½“è®¾ç½®è¯·çœ‹ <a href="https://blogs.perficient.com/2014/03/26/using-git-deploy-key-in-jenkins-written-by-tom-tang/">Using GIT deploy key in Jenkins</a></p>

<p><a href="https://huangtengxiao.gitee.io/post/%E4%BD%BF%E7%94%A8jenkins+gitlab%E8%BF%9B%E8%A1%8CCI.html">ä½¿ç”¨jenkins+gitlabè¿›è¡ŒCI - haungtengxiao</a></p>

<p><img src="https://i.loli.net/2018/09/13/5b9a46e200df2.jpg" alt="" /></p>

:ET