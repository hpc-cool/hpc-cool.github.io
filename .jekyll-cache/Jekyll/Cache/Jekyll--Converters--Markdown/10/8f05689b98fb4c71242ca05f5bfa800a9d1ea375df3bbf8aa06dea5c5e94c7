I"Š¤<p>æœ¬æ–‡æ¥å‘Šè¯‰å¤§å®¶ä¸€ä¸ªæ–°çš„æŠ€æœ¯<a href="https://msdn.microsoft.com/zh-cn/library/windows/desktop/hh437376.aspx">DirectComposition</a>ï¼Œåœ¨ win7 ä¹‹åï¼ˆå®é™…ä¸Šæ˜¯ vistaï¼‰ï¼Œå¾®è½¯æ­£åœ¨è€ƒè™‘ä¸€ä¸ªæ–°çš„æ¸²æŸ“æœºåˆ¶ã€‚</p>

<!--more-->

<!-- CreateTime:2019/3/8 9:18:16 -->

<div id="toc"></div>

<!-- æ ‡ç­¾ï¼šuwp,DirectCompositionï¼Œwin2d,æ¸²æŸ“ -->

<p>åœ¨ Windows  Vista å°±å¼•å…¥äº†ä¸€ä¸ªæœåŠ¡ï¼Œæ¡Œé¢çª—å£ç®¡ç†å™¨<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa969540(v=vs.85).aspx">Desktop Window Manager</a>ï¼Œè™½ç„¶ä»<a href="https://msdn.microsoft.com/magazine/dn745861">å€ŸåŠ© C++ è¿›è¡Œ Windows å¼€å‘</a>åšå®¢å¯ä»¥çœ‹åˆ° DWM ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ³•ï¼Œä½†æ˜¯æ¯”ä¹‹å‰å¥½ã€‚</p>

<p>åœ¨ win8 çš„æ—¶å€™ï¼Œå¾®è½¯æå‡ºäº† DirectComposition ï¼Œè¿™æ˜¯ä¸€ä¸ªæ–°çš„æ–¹æ³•ã€‚</p>

<p>åœ¨è½¯ä»¶çš„æ¸²æŸ“ä¸€ç›´éƒ½æ˜¯ä¸¤ä¸ªé˜µè¥ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨ç›´æ¥æ¸²æŸ“æ¨¡å¼ã€‚ç›´æ¥æ¸²æŸ“çš„ä¾‹å­æ˜¯ä½¿ç”¨ Direct2D å’Œ Direct3D ï¼Œè€Œç›´æ¥é€šè¿‡ Dx api çš„æ–¹å¼å½“ç„¶éœ€è¦ä½¿ç”¨ C++ å’Œåº•å±‚çš„ API ï¼Œè¿™å¼€å‘æ•ˆç‡æ¯”è¾ƒå·®ã€‚</p>

<p>åœ¨ 1511 å‘å¸ƒï¼Œå¾®è½¯å‘Šè¯‰å¤§å®¶å¯ä»¥ä½¿ç”¨åº•å±‚çš„ DirectComposition æ¥å£ï¼Œè¿™æ ·å¤§å®¶å°±å¯ä»¥é€šè¿‡ DirectComposition åšå‡ºå¥½çœ‹çš„æ•ˆæœ</p>

<p>åœ¨åŸæ¥çš„ UWP åº”ç”¨ï¼Œå¤§å®¶å¾ˆå®¹æ˜“ä½¿ç”¨ xaml æ¥å†™ä¸€ä¸ªç•Œé¢ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ xaml é‚£ä¹ˆå¦‚ä½•åˆ›å»ºä¸€ä¸ªç•Œé¢ã€‚</p>

<p>æˆ‘ä¸ä¼šå‘Šè¯‰å¤§å®¶å» new ä¸€ä¸ªæ§ä»¶ï¼Œå› ä¸ºè¿™æ ·å’Œä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•å·®ä¸å¤šã€‚æˆ‘ä¼šå‘Šè¯‰å¤§å®¶å¦‚ä½•ä»ä¸€ä¸ª Visual å¼€å§‹ç”»ã€‚</p>

<p>åœ¨ UWP å¯ä»¥é€šè¿‡ä¸‹é¢å‡ ä¸ªæ–¹å¼æ˜¾ç¤ºç•Œé¢</p>

<ul>
  <li>
    <p>é€šè¿‡ xaml æˆ–è€…åå°æ–°å»ºæ§ä»¶æ˜¾ç¤ºã€‚è¿™æ˜¯æœ€æ¨èçš„æ–¹æ³•ï¼Œæœ¬æ–‡ä¸‹é¢çš„æ–¹æ³•æ˜¯ä¸æ¨èçš„ï¼Œä½†æ˜¯å¯ä»¥è®©å¤§å®¶çŸ¥é“åŸç†ã€‚ä½¿ç”¨ xaml æ˜¾ç¤ºçš„å…ƒç´ ä¸€èˆ¬éƒ½æ˜¯ç»§æ‰¿ UIElement ï¼Œåˆ›å»ºå‡ºæ¥çš„å…ƒç´ å¯ä»¥å¸¦äº¤äº’ã€‚</p>
  </li>
  <li>
    <p>å¦‚æœéœ€è¦é«˜æ€§èƒ½çš„ç”»å›¾ï¼Œé€šè¿‡ win2d æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ã€‚å¤§å®¶ä¹ŸçŸ¥é“åˆ›å»ºçš„win2dåªæ˜¯æ˜¾ç¤ºï¼Œä¸ä¼šæœ‰äº¤äº’ï¼Œå¦‚æœéœ€è¦äº¤äº’éœ€è¦è‡ªå·±å†™ã€‚è™½ç„¶å†™ä¸€ä¸ªäº¤äº’å¾ˆç®€å•ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ä½¿ç”¨æ¡†æ¶ï¼Œé‡å¤ä»£ç å¾ˆå¤šã€‚</p>
  </li>
  <li>
    <p>ä½¿ç”¨ DirectX APIs æ¥ç”» 3d çš„å›¾ç‰‡ï¼Œä½†æ˜¯ç°åœ¨éœ€è¦ä¸€äº› C++ ä»£ç ã€‚</p>
  </li>
</ul>

<p>åœ¨ UWP çš„æ˜¾ç¤ºï¼Œæ¨èä½¿ç”¨ xaml æ¥å†™ç•Œé¢ï¼ŒåŸå› æ˜¯ xaml æ˜¯ä¸€ä¸ªç•Œé¢æ— å…³çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æ— è®ºæ˜¯ C# å’Œ C++ éƒ½å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä½¿ç”¨ C# æ¥å†™ç•Œé¢ï¼Œé‚£ä¹ˆä»£ç å°±å’Œ C# åˆåœ¨ä¸€èµ·ï¼Œä¸èƒ½å¾ˆå¥½åœ¨ C++ è¿è¡Œã€‚è€Œä¸”ä½¿ç”¨xaml å†™ç®€å•æ¯”ä½¿ç”¨C#æ›´ç®€å•ï¼Œåœ¨ vs å®æ—¶ç¼–è¯‘å™¨å¯ä»¥çœ‹åˆ°ç•Œé¢æ•ˆæœã€‚</p>

<p>ä¹Ÿè®¸å¤§å®¶ä¼šå…³ç³» fds æ˜¯å¦‚ä½•åšå‡ºæ¥çš„ï¼Œå¯¹äºå¾®è½¯çš„è®¾è®¡ï¼Œæ‰€æœ‰çš„ xaml æˆ–è€… win2d çš„æ˜¾ç¤ºéƒ½æ˜¯ä½å›¾ã€‚è¿™é‡Œçš„ä½å›¾ä¸æ˜¯å¤§å®¶æƒ³çš„ bitmapImage è€Œæ˜¯æ˜¾ç¤ºçš„ä¸€ä¸ªè¯´æ³•ï¼Œå¾®è½¯å¯¹æ‰€æœ‰çš„ä½å›¾è¾“å‡ºåˆ° DirectComposition ã€‚å¾®è½¯çš„ DirectComposition åœ¨å®˜æ–¹æ˜¯è¿™æ ·è¯´ â€œDirectComposition ç»„ä»¶ä½¿å¼€å‘è€…èƒ½å¤Ÿè¿›è¡Œé«˜æ€§èƒ½çš„ä½å›¾åˆæˆï¼Œå¹¶é™„åŠ å˜æ¢ã€ç‰¹æ•ˆä»¥åŠåŠ¨ç”»ç­‰å„ç§æ•ˆæœï¼Œä»¥æ­¤æ‰“é€ å‡ºæ›´ä¸ºå¤æ‚ã€ç”ŸåŠ¨ã€æµç•…çš„ç”¨æˆ·ç•Œé¢ã€‚DirectComposition åˆ©ç”¨å›¾å½¢ç¡¬ä»¶çš„åŠ é€Ÿç‰¹æ€§å¯ä»¥è¿›è¡Œä¸ UI çº¿ç¨‹æ— å…³çš„æ¸²æŸ“å¤„ç†ï¼Œæ”¯æŒ 2D ä»¿å°„å˜æ¢ã€3D é€è§†å˜æ¢ç­‰å¤šç§å˜æ¢ï¼Œä»¥åŠå‰ªåˆ‡ã€ä¸é€æ˜ç­‰åŸºæœ¬ç‰¹æ•ˆâ€ã€‚</p>

<p>ç¿»è¯‘å‚è§ <a href="https://validvoid.net/windows-composition-api-guide-introduction/">Windows Composition API æŒ‡å— - è®¤è¯† Composition API</a> æ„Ÿè°¢å¤§ç¥ã€‚</p>

<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡Compositionæ˜¾ç¤ºå…ƒç´ ï¼Œè‡ªå·±æ¥å†™ UWP æ¡†æ¶ã€‚</p>

<p>åœ¨å¼€å§‹å‘Šè¯‰å¤§å®¶å†™ UWP æ¡†æ¶ä¹‹å‰ï¼Œå…ˆç»™å¤§å®¶ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚ä½•åº”ç”¨ DirectComposition çš„ API å†™å‡ºç•Œé¢æ¡†æ¶ã€‚éœ€è¦çŸ¥é“ DirectComposition è™½ç„¶å¾ˆå¥½ç”¨ï¼Œä½†æ˜¯å¼€å‘çš„æŠ€æœ¯è¦æ±‚æ˜¯ C++ å’Œ COM å¼€å‘éš¾åº¦å¾ˆé«˜ï¼Œåœ¨ fall creators update 16299 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ Windows.UI.Composition çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥åœ¨ xaml ä¸­å†™å‡ºè°ƒç”¨ DirectComposition çš„æ–¹æ³•ï¼ŒåŒæ—¶åå°ä»£ç å¯ä»¥ä½¿ç”¨ C# å†™</p>

<p>è™½ç„¶æœ¬æ–‡æƒ³ç›´æ¥å‘Šè¯‰å°ä¼™ä¼´å¦‚ä½•ä½¿ç”¨ C++ å’Œ COM å†™ä¸€ä¸ª DirectComposition çš„åº”ç”¨ï¼Œä½†æ˜¯å› ä¸ºå‘ç°éš¾åº¦å¤ªå¤§äº†ï¼ŒåŒæ—¶å¾®è½¯ä¹Ÿå»ºè®®å°ä¼™ä¼´ä½¿ç”¨ Windows.UI.Composition è€Œä¸æ˜¯ä½¿ç”¨ DirectComposition å†™åº”ç”¨ï¼Œæ‰€ä»¥ä¸‹é¢å°†å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨ Windows.UI.Composition ä»é›¶å¼€å§‹å†™ä¸€ä¸ªåº”ç”¨</p>

<h2 id="ä¾‹å­">ä¾‹å­</h2>

<p>ä¹‹å‰å†™çš„ä¸€ä¸ªç®€å•çš„åŠ¨ç”»æ˜¯ä¸€ä¸ªå¥½çœ‹æ•ˆæœï¼Œè¯·çœ‹ <a href="https://lindexi.gitee.io/post/win10-uwp-%E8%BF%9B%E5%BA%A6%E6%9D%A1-WaveProgressControl.html">win10 uwp è¿›åº¦æ¡ WaveProgressControl</a></p>

<p>ä¸‹é¢æ¥é€šè¿‡åˆ é™¤æ‰€æœ‰ xaml æ–‡ä»¶ï¼Œä»å¤´è‡ªå·±å†™ã€‚</p>

<h2 id="åˆ›å»ºå·¥ç¨‹">åˆ›å»ºå·¥ç¨‹</h2>

<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª UWP é¡¹ç›®ï¼Œæ³¨æ„é€‰æ‹©æ¯”è¾ƒé«˜çš„ç›®æ ‡ã€‚æœ€ä½æ”¯æŒè¦æ±‚æ˜¯ 16299 çš„ç³»ç»Ÿï¼Œè¿™é‡Œçš„ 16299 æŒ‡çš„æ˜¯ç³»ç»Ÿç‰ˆæœ¬</p>

<p><img src="http://image.acmx.xyz/lindexi%2F20184221150375871.jpg" alt="" /></p>

<h2 id="å¦‚ä½•å†™æ˜¾ç¤º">å¦‚ä½•å†™æ˜¾ç¤º</h2>

<p>ç°åœ¨åˆ›å»ºé¡¹ç›®ï¼Œåˆ é™¤æ‰€æœ‰çš„ app å’Œ mainpage ç±»ã€‚é‡æ–°åˆ›å»ºä¸€ä¸ªç±»ã€‚</p>

<p>åªè¦æ”¯æŒæ˜¾ç¤ºï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆä¸€åŠäº†ï¼Œå› ä¸º UWP çš„å…ƒç´ æ˜¾ç¤ºéƒ½æ˜¯é€šè¿‡å¸ƒå±€æ‰¾åˆ°å…ƒç´ æ˜¾ç¤ºçš„ä½ç½®ã€‚å½“ç„¶è¿™é‡Œä¸ä¼šæåˆ° Translate ç­‰ã€‚ç„¶åå…ƒç´ é€šè¿‡è°ƒç”¨DrawContexå‘Šè¯‰æ˜¾å¡éœ€è¦æ˜¾ç„¶çš„å›¾å½¢ã€‚ç„¶ååœ¨åŠ ä¸Šç”¨æˆ·çš„è¾“å…¥ï¼Œå°±æ„æˆäº†æ¡†æ¶ã€‚</p>

<p>è™½ç„¶ä¸€ä¸ªæ¡†æ¶æ¯”ä¸Šé¢è¯´çš„å¤æ‚å¾ˆå¤šï¼Œä½†æ˜¯åœ¨å†™ Avalonial çš„æ—¶å€™ï¼Œå¤§ç¥å‘Šè¯‰æˆ‘ï¼Œå®é™…ä¸Šä¸€ä¸ªç•Œé¢æ¡†æ¶ä¸»è¦çš„å°±æ˜¯æ˜¾ç¤ºå’Œäº¤äº’ã€‚æœ¬æ–‡ä¸ä¼šå‘Šè¯‰å¤§å®¶å¦‚ä½•å†™äº¤äº’ï¼Œåªæ˜¯å‘Šè¯‰å¤§å®¶å¦‚ä½•æ˜¾ç¤ºã€‚</p>

<p>åˆ é™¤äº†æ‰€æœ‰çš„è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œç°åœ¨åˆ›å»ºä¸€ä¸ªç±» View ï¼Œç”¨æ¥æ˜¾ç¤ºã€‚</p>

<p>ä¸‹é¢ä»£ç çš„æ„æ€è¯·çœ‹ <a href="http://www.cnblogs.com/tcjiaan/p/7765444.html">ã€Win 10 åº”ç”¨å¼€å‘ã€‘UI Composition æœ­è®°ï¼ˆä¸€ï¼‰ï¼šè§†å›¾æ¡†æ¶çš„å®ç° - ä¸œé‚ªç‹¬å­¤ - åšå®¢å›­</a></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Numerics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Windows.ApplicationModel.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Windows.UI</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Windows.UI.Composition</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Windows.UI.Core</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">HmeucHsvv</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">View</span> <span class="p">:</span> <span class="n">IFrameworkView</span><span class="p">,</span> <span class="n">IFrameworkViewSource</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">SetWindow</span><span class="p">(</span><span class="n">CoreWindow</span> <span class="n">window</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_compositor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Compositor</span><span class="p">();</span>

            <span class="n">_compositionTarget</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateTargetForCurrentView</span><span class="p">();</span>

            <span class="c1">// åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œç”¨æ¥å‘ä»–çš„ Children æ·»åŠ  Visual æ˜¾ç¤ºå¤æ‚çš„å…ƒç´ </span>
            <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateContainerVisual</span><span class="p">();</span>
            <span class="n">_compositionTarget</span><span class="p">.</span><span class="n">Root</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>

            <span class="c1">// åˆ›å»º SpriteVisual ï¼Œè¿™ä¸ªç±»ä¸ä»…æ˜¯ä¸€ä¸ªå®¹å™¨ï¼ŒåŒæ—¶æœ¬èº«ä¹Ÿæ˜¯å¯ä»¥ç”»å‡ºæ¥</span>
            <span class="kt">var</span> <span class="n">visual</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSpriteVisual</span><span class="p">();</span>

            <span class="c1">// å‘Šè¯‰è¿™ä¸ªå…ƒç´ çš„å¤§å°å’Œå·¦ä¸Šè§’ï¼Œæ‰€ä»¥è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªçŸ©å½¢ï¼Œè€Œä¸”è®¾ç½®é¢œè‰²</span>
            <span class="n">visual</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">);</span>
            <span class="n">visual</span><span class="p">.</span><span class="n">Offset</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

            <span class="n">visual</span><span class="p">.</span><span class="n">Brush</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateColorBrush</span><span class="p">(</span><span class="n">Colors</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

            <span class="c1">// æ·»åŠ å…ƒç´ ï¼Œæ·»åŠ è¿›å»çš„å…ƒç´ å°±ä¼šè¢«æ˜¾ç¤º</span>
            <span class="n">container</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">InsertAtTop</span><span class="p">(</span><span class="n">visual</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//å¯åŠ¨çª—å£éœ€è¦æ¿€æ´»</span>
            <span class="kt">var</span> <span class="n">window</span> <span class="p">=</span> <span class="n">CoreWindow</span><span class="p">.</span><span class="nf">GetForCurrentThread</span><span class="p">();</span>
            <span class="n">window</span><span class="p">.</span><span class="nf">Activate</span><span class="p">();</span>
            <span class="c1">//è°ƒåº¦æ–¹å¼ä½¿ç”¨ Dispatcher é€šè¿‡è¿™ä¸ªå°±å¯ä»¥è·å¾—æ¶ˆæ¯</span>
            <span class="n">window</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">ProcessEvents</span><span class="p">(</span><span class="n">CoreProcessEventsOption</span><span class="p">.</span><span class="n">ProcessUntilQuit</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">CoreApplicationView</span> <span class="n">applicationView</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">(</span><span class="kt">string</span> <span class="n">entryPoint</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Uninitialize</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IFrameworkView</span> <span class="nf">CreateView</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CompositionTarget</span> <span class="n">_compositionTarget</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Compositor</span> <span class="n">_compositor</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">CoreApplication</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">new</span> <span class="nf">View</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç æœ‰ä¸€äº›æ³¨é‡Šï¼Œé€šè¿‡è¿™ä¸ªæ–¹å¼å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ˜¾ç¤ºçŸ©å½¢</p>

<p><img src="http://image.acmx.xyz/lindexi%2F20184222018324337.jpg" alt="" /></p>

<p>å®é™…ä¸Šä»ä¸Šé¢ä»£ç å¾ˆå®¹æ˜“å°±çŸ¥é“ï¼Œåªéœ€è¦ä¸€ä¸ªç±»ç»§æ‰¿<code class="language-plaintext highlighter-rouge">IFrameworkView, IFrameworkViewSource</code>ï¼Œç„¶åä½¿ç”¨<code class="language-plaintext highlighter-rouge">CreateView</code>è¿”å›ä»–è‡ªå·±ï¼Œè¿™æ—¶è¿™ä¸ªç±»å°±å¯ä»¥æ˜¾ç¤ºã€‚</p>

<p>ä½†æ˜¯è¿˜éœ€è¦ä½¿ç”¨ä¸»å‡½æ•°å‘Šè¯‰è½¯ä»¶å¯åŠ¨çš„ç±»æ˜¯å“ªä¸ªï¼Œåœ¨è¿è¡Œå¯åŠ¨çª—å£ï¼Œå¦‚æœæ³¨é‡Šæ‰<code class="language-plaintext highlighter-rouge">window.Activate</code>é‚£ä¹ˆå°±ä¼šçœ‹åˆ°åªæœ‰ä¸€ä¸ªæ¬¢è¿çš„å›¾ç‰‡ä¸ä¼šæ˜¾ç¤ºçŸ©å½¢ã€‚</p>

<p>é‚£ä¹ˆæ˜¯ä»€ä¹ˆæ—¶å€™çª—å£æ”¯æŒæ¸²æŸ“çš„ï¼Ÿ</p>

<p>æ ¸å¿ƒä»£ç æ˜¯<code class="language-plaintext highlighter-rouge">CreateTargetForCurrentView</code>è¿™ä¸ªå‡½æ•°åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœä½ å°è¯•è°ƒç”¨ä»–ä¸¤æ¬¡ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¼‚å¸¸ã€‚å› ä¸ºè°ƒç”¨è¿™ä¸ªå‡½æ•°å°±ä¼šå‘Šè¯‰ DirectComposition åˆ›å»ºå…ƒç´ ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>           <span class="n">_compositor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Compositor</span><span class="p">();</span>

            <span class="n">_compositionTarget</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateTargetForCurrentView</span><span class="p">();</span>
</code></pre></div></div>

<p>æ˜¾ç¤ºçš„çŸ©å½¢æ˜¯é€šè¿‡åˆ›å»º SpriteVisual æ¥æ˜¾ç¤ºã€‚é‚£ä¹ˆä¸‹é¢å†å†™ä¸€ä¸ª SpriteVisual ï¼Œè®©ä¸¤ä¸ªåŠ èµ·æ¥ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">public</span> <span class="k">void</span> <span class="nf">SetWindow</span><span class="p">(</span><span class="n">CoreWindow</span> <span class="n">window</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_compositor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Compositor</span><span class="p">();</span>

            <span class="n">_compositionTarget</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateTargetForCurrentView</span><span class="p">();</span>

            <span class="c1">// åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œç”¨æ¥å‘ä»–çš„ Children æ·»åŠ  Visual æ˜¾ç¤ºå¤æ‚çš„å…ƒç´ </span>
            <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateContainerVisual</span><span class="p">();</span>
            <span class="n">_compositionTarget</span><span class="p">.</span><span class="n">Root</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>

            <span class="c1">// åˆ›å»º SpriteVisual ï¼Œè¿™ä¸ªç±»ä¸ä»…æ˜¯ä¸€ä¸ªå®¹å™¨ï¼ŒåŒæ—¶æœ¬èº«ä¹Ÿæ˜¯å¯ä»¥ç”»å‡ºæ¥</span>
            <span class="kt">var</span> <span class="n">visual</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSpriteVisual</span><span class="p">();</span>

            <span class="c1">// å‘Šè¯‰è¿™ä¸ªå…ƒç´ çš„å¤§å°å’Œå·¦ä¸Šè§’ï¼Œæ‰€ä»¥è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªçŸ©å½¢ï¼Œè€Œä¸”è®¾ç½®é¢œè‰²</span>
            <span class="n">visual</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">);</span>
            <span class="n">visual</span><span class="p">.</span><span class="n">Offset</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

            <span class="n">visual</span><span class="p">.</span><span class="n">Brush</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateColorBrush</span><span class="p">(</span><span class="n">Colors</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

            <span class="c1">// æ·»åŠ å…ƒç´ ï¼Œæ·»åŠ è¿›å»çš„å…ƒç´ å°±ä¼šè¢«æ˜¾ç¤º</span>
            <span class="n">container</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">InsertAtTop</span><span class="p">(</span><span class="n">visual</span><span class="p">);</span>

            
            <span class="kt">var</span> <span class="n">visual1</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSpriteVisual</span><span class="p">();</span>

            <span class="c1">// åˆ›å»ºä¸€ä¸ªé‡å å…ƒç´ </span>
            <span class="n">visual1</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">);</span>
            <span class="n">visual1</span><span class="p">.</span><span class="n">Offset</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="m">20</span><span class="p">,</span> <span class="m">20</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

            <span class="n">visual1</span><span class="p">.</span><span class="n">Brush</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateColorBrush</span><span class="p">(</span>
                <span class="n">Color</span><span class="p">.</span><span class="nf">FromArgb</span><span class="p">(</span><span class="m">128</span> <span class="cm">/*é€æ˜*/</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">255</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
            <span class="n">container</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">InsertAtTop</span><span class="p">(</span><span class="n">visual1</span><span class="p">);</span>
        <span class="p">}</span>

</code></pre></div></div>

<p>ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥åˆ›å»ºå¤šä¸ªçŸ©å½¢ï¼Œè€Œä¸”é€šè¿‡æŒ‡å®šä½ç½®å°±å’Œå¤§å°å°±å¯ä»¥å†³å®šä»–åœ¨å“ªæ˜¾ç¤ºã€‚</p>

<p>ä¸Šé¢ç”¨åˆ°äº†ä¸‰ä¸ªä¸œè¥¿ç¬¬ä¸€ä¸ªæ˜¯ Visual ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„ç±»ã€‚æœ‰ ContainerVisual ç»§æ‰¿ Visual ï¼Œå®é™…ä¸Šä»–åªæ˜¯å¯ä»¥å­˜åœ¨å­å…ƒç´ ã€‚æœ€åä¸€ä¸ªæ˜¯ SpriteVisual ï¼Œè¿™ä¸ªç±»å’Œ ContainerVisual ä¸€æ ·ï¼Œä½†æ˜¯ä»–å¯ä»¥ä½¿ç”¨ç¬”åˆ·ã€‚</p>

<p>é‚£ä¹ˆ SpriteVisual è®¾ç½®çš„ç¬”åˆ·æ˜¯ä»€ä¹ˆï¼Œä»–å¯ä»¥è®¾ç½®ä¸‰ä¸ªä¸åŒçš„ç¬”åˆ·ã€‚ç¬¬ä¸€ä¸ªå°±æ˜¯åˆšæ‰ç»™å¤§å®¶çœ‹çš„ CompositionColorBrush ï¼Œè¿™æ˜¯ä¸€ä¸ªçº¯è‰²ç¬”åˆ·ã€‚ ç¬¬äºŒä¸ªæ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ•ˆçš„ CompositionEffectBrush ç¬”åˆ·ï¼Œæœ€åä¸€ä¸ªæ˜¯ CompositionSurfaceBrush å¯ä»¥å’Œ dx äº¤äº’æ•°æ®ã€‚</p>

<p><img src="http://image.acmx.xyz/lindexi%2F20184222024298849.jpg" alt="" /></p>

<p>ä»ä¸Šé¢ä»£ç å®é™…åªæ˜¯ç”»äº†æ™®é€šçš„çŸ©å½¢ï¼Œå¦‚æœè¦å†™æ–‡å­—ï¼Œç”»çº¿ï¼Œé‚£ä¹ˆæ€ä¹ˆåŠã€‚è¿™æ—¶å°±éœ€è¦ä½¿ç”¨ CompositionSurfaceBrush ï¼Œè¿™æ˜¯æœ€å¤æ‚çš„ã€‚é€šè¿‡è¿™ä¸ªç±»å¯ä»¥ä½¿ç”¨ d2d æ¥ç”»ï¼Œåœ¨ UWP ç®€å•ä½¿ç”¨çš„æ–¹æ³•æ˜¯ win2d æ‰€ä»¥ä¸‹é¢å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨ win2d æ¥ç”»ã€‚</p>

<p>ä½†æ˜¯ UWP åº•å±‚æ˜¯ç›´æ¥ä½¿ç”¨d2dæ²¡æœ‰ç»è¿‡ win2d çš„å°è£…ã€‚ä»æˆ‘çš„åšå®¢<a href="https://lindexi.gitee.io/post/WPF-%E4%BD%BF%E7%94%A8-SharpDX-%E5%9C%A8-D3DImage-%E6%98%BE%E7%A4%BA.html">WPF ä½¿ç”¨ SharpDX åœ¨ D3DImage æ˜¾ç¤º</a>å¯ä»¥çŸ¥é“ï¼Œåœ¨ WPF ä½¿ç”¨ d2d æ˜¯æ¯”è¾ƒéš¾çš„ï¼Œå› ä¸ºå¾ˆéš¾é›†åˆä¸¤ä¸ªåœ¨ä¸€ä¸ªç•Œé¢ã€‚ä½†æ˜¯ UWP é€šè¿‡è¿™ä¸ªç±»å°±å¯ä»¥æŠŠåº•å±‚æ¸²æŸ“æ”¾åœ¨æŒ‡å®šå±‚çº§ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ UWP å¯ä»¥åšå‡ºæ¯”è¾ƒé«˜æ€§èƒ½ï¼Œå› ä¸º WPF æ˜¯å¾ˆéš¾ä¿®æ”¹ä»–çš„æ¸²æŸ“ï¼Œå³ä½¿ä½¿ç”¨D3DImageä¹Ÿæ˜¯æŠŠæ¸²æŸ“ä½å›¾ä½œä¸ºå›¾ç‰‡æ˜¾ç¤ºï¼Œéœ€è¦å…ˆåœ¨æ˜¾å¡æ¸²æŸ“ç„¶åæŠŠä½å›¾å¤åˆ¶åˆ°å†…å­˜ï¼Œè®©WPFç”»å‡ºå›¾ç‰‡ã€‚ä½†æ˜¯ UWP å¯ä»¥ç›´æ¥ç”»å‡ºï¼Œä¸éœ€è¦ä½¿ç”¨ WPF è¿™æ ·çš„æ–¹æ³•ã€‚æˆ‘çœ‹æ¥ UWP åœ¨è¿™é‡Œæ˜¯å¾ˆå¤§æå‡ï¼Œè¿™å°±æ˜¯æˆ‘çœ‹åˆ°å¾ˆå¤šå¤§ç¥è¯´ä¸åœ¨ WPF æ·»åŠ  win2d ï¼Œä»åº•å±‚æŠ€æœ¯å®ç°æ˜¯ä¸ç›¸åŒã€‚</p>

<h2 id="compositionsurfacebrush">CompositionSurfaceBrush</h2>

<p>é¦–å…ˆéœ€è¦å®‰è£… win2d ï¼Œç„¶ååœ¨ SetWindow ä½¿ç”¨ CompositionSurfaceBrush ã€‚è¿˜æ˜¯å’Œä¸Šé¢ä»£ç ä¸€æ ·ï¼Œä½†æ˜¯éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åˆ›å»º win2d ï¼Œè¯·çœ‹ä¸‹é¢</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">GetCanvasAndGraphicsDevices</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">canvasDevice</span> <span class="p">=</span> <span class="n">CanvasDevice</span><span class="p">.</span><span class="nf">GetSharedDevice</span><span class="p">();</span>

            <span class="n">_graphicsDevice</span> <span class="p">=</span> <span class="n">CanvasComposition</span><span class="p">.</span><span class="nf">CreateCompositionGraphicsDevice</span><span class="p">(</span>
                <span class="n">_compositor</span><span class="p">,</span> <span class="n">canvasDevice</span><span class="p">);</span>

            <span class="n">_graphicsDevice</span><span class="p">.</span><span class="n">RenderingDeviceReplaced</span> <span class="p">+=</span> <span class="n">OnRenderingDeviceReplaced</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥æ‹¿åˆ° graphicsDevice ï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥åš CompositionSurfaceBrush ã€‚</p>

<p>å¦‚æœéœ€è¦åˆ›å»º CompositionSurfaceBrush é‚£ä¹ˆå°±éœ€è¦ä¸€ä¸ª CompositionDrawingSurface ï¼Œè€Œ CompositionDrawingSurface å¯ä»¥é€šè¿‡ graphicsDevice åˆ›å»ºï¼Œä»£ç å¾ˆç®€å•</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">_compositor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Compositor</span><span class="p">();</span>

            <span class="n">_compositionTarget</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateTargetForCurrentView</span><span class="p">();</span>

            <span class="c1">// åˆ›å»º win2d ç”¨äºæ¸²æŸ“</span>
            <span class="nf">GetCanvasAndGraphicsDevices</span><span class="p">();</span>

            <span class="n">_drawingSurface</span> <span class="p">=</span> <span class="n">_graphicsDevice</span><span class="p">.</span><span class="nf">CreateDrawingSurface</span><span class="p">(</span>
                <span class="k">new</span> <span class="nf">Size</span><span class="p">(</span><span class="m">600</span><span class="p">,</span> <span class="m">600</span><span class="p">),</span>
                <span class="n">DirectXPixelFormat</span><span class="p">.</span><span class="n">B8G8R8A8UIntNormalized</span><span class="p">,</span>
                <span class="n">DirectXAlphaMode</span><span class="p">.</span><span class="n">Premultiplied</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSurfaceBrush</span><span class="p">(</span>
                <span class="n">_drawingSurface</span><span class="p">);</span>
</code></pre></div></div>

<p>é‚£ä¹ˆåˆ›å»ºçš„ CompositionSurfaceBrush å¦‚ä½•æ˜¾ç¤ºï¼Ÿåˆšæ‰è®²åˆ°SpriteVisualå¯ä»¥æ˜¾ç¤ºç¬”åˆ·ï¼Œé‚£ä¹ˆå°±åˆ›å»ºè¿™ä¸ªç±»æ¥æ˜¾ç¤ºã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
            <span class="kt">var</span> <span class="n">drawingVisual</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSpriteVisual</span><span class="p">();</span>
            <span class="n">drawingVisual</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">600</span><span class="p">,</span> <span class="m">600</span><span class="p">);</span>

            <span class="n">drawingVisual</span><span class="p">.</span><span class="n">Brush</span> <span class="p">=</span> <span class="n">brush</span><span class="p">;</span>
</code></pre></div></div>

<p>ç„¶åæŠŠä»–åŠ å…¥è§†è§‰ï¼Œå’Œä¸Šé¢çš„ä»£ç ä¸€æ ·ï¼Œåªæ˜¯æŠŠ Brush çš„åˆ›å»ºå†™äº†å…¶ä»–çš„ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">containerVisual</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateContainerVisual</span><span class="p">();</span>
            <span class="n">_compositionTarget</span><span class="p">.</span><span class="n">Root</span> <span class="p">=</span> <span class="n">containerVisual</span><span class="p">;</span>

            <span class="n">containerVisual</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">InsertAtTop</span><span class="p">(</span><span class="n">drawingVisual</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸‹é¢å°±æ˜¯è®© win2d ç”»å‡ºçŸ©å½¢ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">Redraw</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">drawingSession</span> <span class="p">=</span> <span class="n">CanvasComposition</span><span class="p">.</span><span class="nf">CreateDrawingSession</span><span class="p">(</span>
                <span class="n">_drawingSurface</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">drawingSession</span><span class="p">.</span><span class="nf">FillRectangle</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">200</span><span class="p">),</span>
                    <span class="n">Colors</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

                <span class="n">drawingSession</span><span class="p">.</span><span class="nf">FillRectangle</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">300</span><span class="p">,</span> <span class="m">300</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">200</span><span class="p">),</span>
                    <span class="n">Color</span><span class="p">.</span><span class="nf">FromArgb</span><span class="p">(</span><span class="m">255</span><span class="p">,</span><span class="m">126</span><span class="p">,</span><span class="m">50</span><span class="p">,</span><span class="m">50</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>ä»€ä¹ˆæ—¶å€™å¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Ÿå®é™…ä¸Šåœ¨åˆšæ‰çš„å‡½æ•°æœ€åè°ƒç”¨å°±å¯ä»¥äº†ã€‚</p>

<p>ç°åœ¨çš„ç•Œé¢å°±æ˜¯ä¸¤ä¸ªçŸ©å½¢</p>

<p><img src="http://image.acmx.xyz/lindexi%2F20184222047529494.jpg" alt="" /></p>

<p>æ‰€æœ‰çš„ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">internal</span> <span class="k">class</span> <span class="nc">View</span> <span class="p">:</span> <span class="n">IFrameworkView</span><span class="p">,</span> <span class="n">IFrameworkViewSource</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">SetWindow</span><span class="p">(</span><span class="n">CoreWindow</span> <span class="n">window</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_compositor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Compositor</span><span class="p">();</span>

            <span class="n">_compositionTarget</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateTargetForCurrentView</span><span class="p">();</span>

            <span class="c1">// åˆ›å»º win2d ç”¨äºæ¸²æŸ“</span>
            <span class="nf">GetCanvasAndGraphicsDevices</span><span class="p">();</span>

            <span class="n">_drawingSurface</span> <span class="p">=</span> <span class="n">_graphicsDevice</span><span class="p">.</span><span class="nf">CreateDrawingSurface</span><span class="p">(</span>
                <span class="k">new</span> <span class="nf">Size</span><span class="p">(</span><span class="m">600</span><span class="p">,</span> <span class="m">600</span><span class="p">),</span>
                <span class="n">DirectXPixelFormat</span><span class="p">.</span><span class="n">B8G8R8A8UIntNormalized</span><span class="p">,</span>
                <span class="n">DirectXAlphaMode</span><span class="p">.</span><span class="n">Premultiplied</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSurfaceBrush</span><span class="p">(</span>
                <span class="n">_drawingSurface</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">drawingVisual</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateSpriteVisual</span><span class="p">();</span>
            <span class="n">drawingVisual</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">600</span><span class="p">,</span> <span class="m">600</span><span class="p">);</span>

            <span class="n">drawingVisual</span><span class="p">.</span><span class="n">Brush</span> <span class="p">=</span> <span class="n">brush</span><span class="p">;</span>


            <span class="kt">var</span> <span class="n">containerVisual</span> <span class="p">=</span> <span class="n">_compositor</span><span class="p">.</span><span class="nf">CreateContainerVisual</span><span class="p">();</span>
            <span class="n">_compositionTarget</span><span class="p">.</span><span class="n">Root</span> <span class="p">=</span> <span class="n">containerVisual</span><span class="p">;</span>

            <span class="n">containerVisual</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">InsertAtTop</span><span class="p">(</span><span class="n">drawingVisual</span><span class="p">);</span>

            <span class="nf">Redraw</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//å¯åŠ¨çª—å£éœ€è¦æ¿€æ´»</span>
            <span class="kt">var</span> <span class="n">window</span> <span class="p">=</span> <span class="n">CoreWindow</span><span class="p">.</span><span class="nf">GetForCurrentThread</span><span class="p">();</span>
            <span class="n">window</span><span class="p">.</span><span class="nf">Activate</span><span class="p">();</span>
            <span class="c1">//è°ƒåº¦æ–¹å¼ä½¿ç”¨ Dispatcher é€šè¿‡è¿™ä¸ªå°±å¯ä»¥è·å¾—æ¶ˆæ¯</span>
            <span class="n">window</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">ProcessEvents</span><span class="p">(</span><span class="n">CoreProcessEventsOption</span><span class="p">.</span><span class="n">ProcessUntilQuit</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">CoreApplicationView</span> <span class="n">applicationView</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">(</span><span class="kt">string</span> <span class="n">entryPoint</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Uninitialize</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IFrameworkView</span> <span class="nf">CreateView</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CompositionTarget</span> <span class="n">_compositionTarget</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Compositor</span> <span class="n">_compositor</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">CompositionGraphicsDevice</span> <span class="n">_graphicsDevice</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">CompositionDrawingSurface</span> <span class="n">_drawingSurface</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">CoreApplication</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">new</span> <span class="nf">View</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">GetCanvasAndGraphicsDevices</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">canvasDevice</span> <span class="p">=</span> <span class="n">CanvasDevice</span><span class="p">.</span><span class="nf">GetSharedDevice</span><span class="p">();</span>

            <span class="n">_graphicsDevice</span> <span class="p">=</span> <span class="n">CanvasComposition</span><span class="p">.</span><span class="nf">CreateCompositionGraphicsDevice</span><span class="p">(</span>
                <span class="n">_compositor</span><span class="p">,</span> <span class="n">canvasDevice</span><span class="p">);</span>

            <span class="c1">//_graphicsDevice.RenderingDeviceReplaced += OnRenderingDeviceReplaced;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">OnRenderingDeviceReplaced</span><span class="p">(</span>
            <span class="n">CompositionGraphicsDevice</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RenderingDeviceReplacedEventArgs</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">Redraw</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Redraw</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">drawingSession</span> <span class="p">=</span> <span class="n">CanvasComposition</span><span class="p">.</span><span class="nf">CreateDrawingSession</span><span class="p">(</span>
                <span class="n">_drawingSurface</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">drawingSession</span><span class="p">.</span><span class="nf">FillRectangle</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">200</span><span class="p">),</span>
                    <span class="n">Colors</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

                <span class="n">drawingSession</span><span class="p">.</span><span class="nf">FillRectangle</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">300</span><span class="p">,</span> <span class="m">300</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">200</span><span class="p">),</span>
                    <span class="n">Color</span><span class="p">.</span><span class="nf">FromArgb</span><span class="p">(</span><span class="m">255</span><span class="p">,</span><span class="m">126</span><span class="p">,</span><span class="m">50</span><span class="p">,</span><span class="m">50</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>é‚£ä¹ˆå°è¯•ä½¿ç”¨ win2d å†™æ–‡å­—å°±è¯·çœ‹<a href="https://lindexi.gitee.io/post/win10-uwp-win2d-%E5%85%A5%E9%97%A8-%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86.html">win10 uwp win2d å…¥é—¨ çœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†</a></p>

<p>ä¿®æ”¹å‡½æ•°å’Œæ™®é€šä½¿ç”¨ win2d æ²¡æœ‰ä¸åŒ</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">drawingSession</span> <span class="p">=</span> <span class="n">CanvasComposition</span><span class="p">.</span><span class="nf">CreateDrawingSession</span><span class="p">(</span>
                <span class="n">_drawingSurface</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">drawingSession</span><span class="p">.</span><span class="nf">Clear</span><span class="p">(</span><span class="n">Colors</span><span class="p">.</span><span class="n">White</span><span class="p">);</span>
                <span class="n">drawingSession</span><span class="p">.</span><span class="nf">DrawText</span><span class="p">(</span><span class="s">"lindexi"</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">),</span> <span class="n">Color</span><span class="p">.</span><span class="nf">FromArgb</span><span class="p">(</span><span class="m">0xFF</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">));</span>
            <span class="p">}</span>
</code></pre></div></div>

<p><img src="http://image.acmx.xyz/lindexi%2F20184222056348323.jpg" alt="" /></p>

<p>è¿˜æœ‰å¦‚ä½•ä½¿ç”¨åŠ¨ç”»å’Œç‰¹æ•ˆï¼Œæˆ‘è¿™é‡Œå°±ä¸è¯´äº†ã€‚</p>

<p>ä»£ç å‚è€ƒ <a href="https://msdn.microsoft.com/zh-CN/magazine/mt590968">å›¾å½¢å’ŒåŠ¨ç”» - Windows ç»„åˆæ”¯æŒ 10 å€ç¼©æ”¾</a></p>

<p>å‚è€ƒï¼š</p>

<p><a href="https://msdn.microsoft.com/zh-CN/magazine/mt590968">å›¾å½¢å’ŒåŠ¨ç”» - Windows ç»„åˆæ”¯æŒ 10 å€ç¼©æ”¾</a></p>

<p><a href="http://www.cnblogs.com/tcjiaan/p/7765444.html">ã€Win 10 åº”ç”¨å¼€å‘ã€‘UI Composition æœ­è®°ï¼ˆä¸€ï¼‰ï¼šè§†å›¾æ¡†æ¶çš„å®ç° - ä¸œé‚ªç‹¬å­¤ - åšå®¢å›­</a></p>

<p><a href="https://msdn.microsoft.com/magazine/dn745861">å€ŸåŠ© C++ è¿›è¡Œ Windows å¼€å‘ - ä½¿ç”¨ Windows ç»„åˆå¼•æ“å®ç°é«˜æ€§èƒ½çª—å£åˆ†å±‚</a></p>

<p><a href="https://msdn.microsoft.com/magazine/dn786854">å€ŸåŠ© C++ è¿›è¡Œ Windows å¼€å‘ - ä½¿ç”¨ Windows ç»„åˆå¼•æ“</a></p>

<p><a href="https://mtaulty.com/2015/12/17/m_15996/">Windows, UI and Composition (the Visual Layer) â€“ Mike Taulty</a></p>

<p><a href="https://msdn.microsoft.com/en-us/magazine/dn759437.aspx">Windows with C++ - DirectComposition: A Retained-Mode API to Rule Them All</a></p>

:ET