I"À<p>åœ¨ MAC ç³»ç»Ÿä¸‹ï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºçš„æ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœåº”ç”¨ç¨‹åºæ‰§è¡Œäº† Process.Start æ–¹æ³•æ—¶ï¼Œå°†ä¼šæŠ›å‡º Win32Exception å¼‚å¸¸</p>

<!--more-->

<!-- CreateTime:2020/8/13 9:38:41 -->

<p>æˆ‘å†™äº†ä¸€ä¸ªå·¥å…· <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools">dotnetCampus.UpdateAllDotNetTools</a> ç”¨æ¥æ›´æ–°æ‰€æœ‰çš„ dotnet tool å·¥å…·ã€‚å› ä¸º <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools">dotnetCampus.UpdateAllDotNetTools</a> ä¹Ÿæ˜¯ä¸€ä¸ª dotnet tool å·¥å…·ï¼Œå› æ­¤ä¹Ÿä¼šæ›´æ–°è‡ªèº«</p>

<p>ä½†æ˜¯æœ‰å°ä¼™ä¼´å‘Šè¯‰æˆ‘ï¼Œåœ¨ä½¿ç”¨ <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools">dotnetCampus.UpdateAllDotNetTools</a> æ›´æ–° <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools">dotnetCampus.UpdateAllDotNetTools</a> åˆ°æœ€æ–°ç‰ˆæœ¬ä¹‹åï¼Œå…¶ä»–çš„ dotnet tool å°±éƒ½ä¸èƒ½æ›´æ–°äº†ï¼Œå°†ä¼šæŠ›å‡º Win32Exception å¼‚å¸¸ï¼Œå¦‚ä¸‹å›¾</p>

<!-- ![](image/dotnet core åœ¨ MAC ç³»ç»Ÿä¸‹åˆ é™¤åº”ç”¨ç¨‹åºè‡ªå·±åè°ƒ Process Start æ–¹æ³•å°†ä¼šæŠ›å‡º Win32 å¼‚å¸¸/dotnet core åœ¨ MAC ç³»ç»Ÿä¸‹åˆ é™¤åº”ç”¨ç¨‹åºè‡ªå·±åè°ƒ Process Start æ–¹æ³•å°†ä¼šæŠ›å‡º Win32 å¼‚å¸¸0.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2020813938278627.jpg" alt="" /></p>

<p>åœ¨æ›´æ–° <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools">dotnetCampus.UpdateAllDotNetTools</a> å°†ä¼šåˆ é™¤å½“å‰è¿è¡Œçš„ <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools">dotnetCampus.UpdateAllDotNetTools</a> è¿›ç¨‹çš„æ–‡ä»¶ï¼Œåœ¨ MAC ä¸‹æ˜¯å¯ä»¥åˆ é™¤æ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨ .NET Core çš„ Process.Start æ–¹æ³•é‡Œé¢çš„é€»è¾‘æ˜¯éœ€è¦å…ˆè·å–å½“å‰è¿›ç¨‹æ‰€åœ¨çš„æ–‡ä»¶ï¼Œè·å–å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œç”¨äºæ‰¾åˆ°å‘½ä»¤</p>

<p>ä¾‹å¦‚æˆ‘è¾“å…¥äº† <code class="language-plaintext highlighter-rouge">dotnet</code> å‘½ä»¤ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">Process.Start("dotnet")</code> é‚£ä¹ˆ .NET å°†å…ˆå°è¯•åœ¨ç¨‹åºæ‰€åœ¨çš„æ–‡ä»¶å¤¹å¯»æ‰¾æ˜¯å¦å­˜åœ¨ â€œdotnetâ€ è¿™ä¸ªç¨‹åºï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆæ‰§è¡Œã€‚å› æ­¤ç¬¬ä¸€æ­¥å°±æ˜¯è·å–å½“å‰è¿›ç¨‹æ‰€åœ¨çš„æ–‡ä»¶</p>

<p>åœ¨ .NET å¼€æºä»£ç é‡Œé¢ï¼Œå¯ä»¥åœ¨ <code class="language-plaintext highlighter-rouge">src\libraries\System.Diagnostics.Process\src\System\Diagnostics\Process.Unix.cs</code> æ‰¾åˆ°å®é™…çš„ Process Start é€»è¾‘</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// Starts the process using the supplied start info.</span>
        <span class="c1">/// With UseShellExecute option, we'll try the shell tools to launch it(e.g. "open fileName")</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="startInfo"&gt;The start info with which to start the process.&lt;/param&gt;</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">StartCore</span><span class="p">(</span><span class="n">ProcessStartInfo</span> <span class="n">startInfo</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="c1">// å¿½ç•¥ä»£ç </span>
                <span class="n">filename</span> <span class="p">=</span> <span class="nf">ResolvePath</span><span class="p">(</span><span class="n">startInfo</span><span class="p">.</span><span class="n">FileName</span><span class="p">);</span>
                <span class="n">argv</span> <span class="p">=</span> <span class="nf">ParseArgv</span><span class="p">(</span><span class="n">startInfo</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Win32Exception</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">DirectoryNotValidAsInput</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nf">ForkAndExecProcess</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span>
                    <span class="n">startInfo</span><span class="p">.</span><span class="n">RedirectStandardInput</span><span class="p">,</span> <span class="n">startInfo</span><span class="p">.</span><span class="n">RedirectStandardOutput</span><span class="p">,</span> <span class="n">startInfo</span><span class="p">.</span><span class="n">RedirectStandardError</span><span class="p">,</span>
                    <span class="n">setCredentials</span><span class="p">,</span> <span class="n">userId</span><span class="p">,</span> <span class="n">groupId</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span>
                    <span class="k">out</span> <span class="n">stdinFd</span><span class="p">,</span> <span class="k">out</span> <span class="n">stdoutFd</span><span class="p">,</span> <span class="k">out</span> <span class="n">stderrFd</span><span class="p">,</span> <span class="n">usesTerminal</span><span class="p">);</span>

                <span class="c1">// å¿½ç•¥ä»£ç </span>
        <span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ ResolvePath æ–¹æ³•å°†ä¼šå…ˆå°è¯•è·å–å½“å‰çš„æ–‡ä»¶å¤¹ï¼Œå…·ä½“çš„å®ç°å°†ä¼šåœ¨ <code class="language-plaintext highlighter-rouge">src\libraries\System.Diagnostics.Process\src\System\Diagnostics\Process.OSX.cs</code> æ–‡ä»¶é‡Œ</p>

<p>åœ¨ MAC ç³»ç»Ÿçš„ä»£å·é‡Œé¢ï¼Œä¸Šå¤ç‰ˆæœ¬å°±æ˜¯ OSX ä¹Ÿå°±æ˜¯ OSX å°±æ˜¯ MAC ç³»ç»Ÿï¼Œä¸Šé¢è¿™ä¸ªä»£ç æ–‡ä»¶å°±æ˜¯ç‰¹åˆ«ç»™ MAC ç³»ç»Ÿä½¿ç”¨çš„</p>

<p>é‚£ä¹ˆè·å–å½“å‰æ–‡ä»¶ç”¨çš„æ˜¯ä»€ä¹ˆæ–¹æ³•ï¼Ÿè°ƒç”¨ä¸€ä¸ªå’Œ Windows çš„ P/Invoke æ–¹æ³•å·®ä¸å¤šçš„æ–¹æ³•</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">/// &lt;summary&gt;Gets the path to the current executable, or null if it could not be retrieved.&lt;/summary&gt;</span>
        <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetExePath</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">Interop</span><span class="p">.</span><span class="n">libproc</span><span class="p">.</span><span class="nf">proc_pidpath</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">ProcessId</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ª <code class="language-plaintext highlighter-rouge">proc_pidpath</code> æ˜¯ä»€ä¹ˆæ–¹æ³•ï¼Ÿè¿™æ˜¯ä¸€ä¸ªè·å–ä¼ å…¥çš„è¿›ç¨‹å·æ‹¿åˆ°å¯¹åº”çš„æ–‡ä»¶è·¯å¾„çš„æ–¹æ³•ï¼Œå¦‚æœä¼ å…¥çš„è¿›ç¨‹å·å¯¹åº”çš„æ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆå°†ä¼šæŠ›å‡º Win32Exception å¼‚å¸¸</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System.ComponentModel.Win32Exception (2): No such file or Directory
at Interop.libproc.proc_pidpath(Int32 pid)
at System.Diagnostics.Process.ResolvePath(string filename)
at System.Diagnostics.Process.StartCore(ProcessStartInfo startInfo)
at System.Diagnostics.Process.Start()
</code></pre></div></div>

<p>è¿™å°±æ˜¯åœ¨ <a href="https://github.com/dotnet-campus/dotnetCampus.UpdateAllDotNetTools/issues/4">Unhandled exception on Mac Â· Issue #4 Â· dotnet-campus/dotnetCampus.UpdateAllDotNetTools</a> çš„é—®é¢˜</p>

<p>æˆ‘å°è¯•åœ¨ dotnet runtime ä¿®å¤è¿™ä¸ªå‘ <a href="https://github.com/dotnet/runtime/pull/40748">Ignore the executable file be deleted in Process Start by lindexi Â· Pull Request #40748 Â· dotnet/runtime</a></p>

:ET