I"ó<p>åœ¨ C# åå°„è°ƒç”¨ç§æœ‰äº‹ä»¶ç»å¸¸ä¼šä¸çŸ¥é“å¦‚ä½•å†™ï¼Œæœ¬æ–‡å‘Šè¯‰å¤§å®¶å¦‚ä½•è°ƒç”¨</p>

<!--more-->

<!-- CreateTime:2019/11/29 8:51:13 -->

<!-- æ ‡ç­¾ï¼šC#ï¼Œåå°„ -->

<p>å‡è®¾æœ‰ A ç±»çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ªç§æœ‰çš„äº‹ä»¶</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">class</span> <span class="nc">A</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">event</span> <span class="n">EventHandler</span> <span class="n">Fx</span>
        <span class="p">{</span>
            <span class="k">add</span> <span class="p">{</span> <span class="p">}</span>
            <span class="k">remove</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡åå°„å¯ä»¥æ‹¿åˆ° A çš„äº‹ä»¶ Fx ä½†æ˜¯æ— æ³•ç›´æ¥æ·»åŠ äº‹ä»¶</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">eventInfo</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">A</span><span class="p">).</span><span class="nf">GetEvent</span><span class="p">(</span><span class="s">"Fx"</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">);</span>
</code></pre></div></div>

<p>å¦‚æœè¿™æ—¶ç›´æ¥è°ƒç”¨ AddEventHandler å°±ä¼šå‡ºç°ä¸‹é¢å¼‚å¸¸</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">eventInfo</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">A</span><span class="p">).</span><span class="nf">GetEvent</span><span class="p">(</span><span class="s">"Fx"</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">A</span><span class="p">();</span>

            <span class="n">eventInfo</span><span class="p">.</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">new</span> <span class="nf">EventHandler</span><span class="p">(</span><span class="n">Fx</span><span class="p">));</span>

            <span class="k">void</span> <span class="nf">Fx</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
            <span class="p">}</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">System</span><span class="p">.</span><span class="n">InvalidOperationException</span><span class="p">:</span><span class="err">â€œç”±äºä¸å­˜åœ¨æ­¤äº‹ä»¶çš„å…¬å…±æ·»åŠ æ–¹æ³•ï¼Œå› æ­¤æ— æ³•æ·»åŠ è¯¥äº‹ä»¶å¤„ç†ç¨‹åºã€‚â€</span>
</code></pre></div></div>

<p>è§£å†³çš„æ–¹æ³•æ˜¯è°ƒç”¨ GetAddMethod çš„æ–¹æ³•è¯·çœ‹ä¸‹é¢</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">eventInfo</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">A</span><span class="p">).</span><span class="nf">GetEvent</span><span class="p">(</span><span class="s">"Fx"</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">addFx</span> <span class="p">=</span> <span class="n">eventInfo</span><span class="p">.</span><span class="nf">GetAddMethod</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">removeFx</span> <span class="p">=</span> <span class="n">eventInfo</span><span class="p">.</span><span class="nf">GetRemoveMethod</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">A</span><span class="p">();</span>

            <span class="n">addFx</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="k">new</span> <span class="nf">EventHandler</span><span class="p">(</span><span class="n">Fx</span><span class="p">)});</span>
            <span class="n">removeFx</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="k">new</span> <span class="nf">EventHandler</span><span class="p">(</span><span class="n">Fx</span><span class="p">)});</span>

            <span class="k">void</span> <span class="nf">Fx</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>å‚è§ https://stackoverflow.com/a/6423886/6116637</p>

<p>å¦‚æœå¯èƒ½é‡åˆ°ç±»å‹è½¬æ¢çš„å¼‚å¸¸<code class="language-plaintext highlighter-rouge">System.ArgumanetException:'Object of type 'System.EventHandler1[System.EventArgs]' cannot be converted to type 'System.EventHandler'. </code>ï¼Œè¯·çœ‹<a href="https://blog.walterlv.com/post/add-event-handler-using-reflection.html">.NET/C# ä½¿ç”¨åå°„æ³¨å†Œäº‹ä»¶ - walterlv</a></p>

<p>æ›´å¤šåå°„è¯·çœ‹</p>

<p><a href="https://blog.lindexi.com/post/win10-uwp-%E5%8F%8D%E5%B0%84.html">win10 uwp åå°„</a></p>

<p><a href="https://blog.walterlv.com/post/create-delegate-to-improve-reflection-performance.html">.NET Core/Framework åˆ›å»ºå§”æ‰˜ä»¥å¤§å¹…åº¦æé«˜åå°„è°ƒç”¨çš„æ€§èƒ½ - walterlv</a></p>

<p><a href="https://blog.walterlv.com/uwp/2017/09/21/reflection-using-dotnet-native-runtime-directive.html">è®¾ç½® .NET Native è¿è¡Œæ—¶æŒ‡ä»¤ä»¥æ”¯æŒåå°„ï¼ˆå°¤å…¶é€‚ç”¨äº UWPï¼‰ - walterlv</a></p>

<p><a href="https://blog.walterlv.com/post/handle-ref-or-out-arguments-using-reflection.html">.NET/C# ä½¿ç”¨åå°„è°ƒç”¨å« ref æˆ– out å‚æ•°çš„æ–¹æ³• - walterlv</a></p>

<p><a href="https://blog.walterlv.com/post/design-a-cache-pool.html">.NET/C# æ¨èä¸€ä¸ªæˆ‘è®¾è®¡çš„ç¼“å­˜ç±»å‹ï¼ˆé€‚åˆç¼“å­˜åå°„ç­‰è€—æ€§èƒ½çš„æ“ä½œï¼Œé™„ç”¨æ³•ï¼‰ - walterlv</a></p>

:ET