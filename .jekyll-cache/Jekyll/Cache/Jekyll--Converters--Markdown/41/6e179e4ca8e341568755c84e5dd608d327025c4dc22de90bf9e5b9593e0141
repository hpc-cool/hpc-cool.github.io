I"‹-<p>æˆ‘ä»Šå¤©é‡åˆ°äº†ä¸€ä¸ªå‘ï¼Œæˆ‘çš„æœåŠ¡å™¨åœ¨ç»è¿‡äº† Nginx ä¹‹åï¼Œå‘é€çš„ POST è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡Œé¢æœ‰ Body å†…å®¹ï¼Œé‚£ä¹ˆ Kestrel å°†ä¼šè¿”å› 400 é”™è¯¯ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šç»è¿‡ä»»ä½•çš„ä¸­é—´ä»¶</p>

<!--more-->

<!-- CreateTime:2021/1/21 20:05:54 -->

<!-- å‘å¸ƒ -->

<p>åœ¨ HTTP çš„æ ‡å‡†é‡Œé¢ï¼Œåœ¨ HTTP åè®®æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„æœºåˆ¶ï¼Œè¿™ä¸€æœºåˆ¶å…è®¸å°†ä¸€ä¸ªå·²å»ºç«‹çš„è¿æ¥å‡çº§æˆæ–°çš„ã€ä¸ç›¸å®¹çš„åè®®ã€‚ç”±å®¢æˆ·ç«¯å‘èµ·ç»™æœåŠ¡ç«¯è¯¢é—®å¯ä»¥æœåŠ¡å™¨ç«¯é€‰æ‹©æ˜¯å¦è¦å‡çº§åˆ°æ–°åè®®ï¼Œè¿™ä¸ªæœºåˆ¶å¯ä»¥åšåˆ°å¦‚å®¢æˆ·ç«¯ä½¿ç”¨HTTP/1.1å»è¿æ¥æœåŠ¡å™¨ç«¯ï¼Œè¯¢é—®æœåŠ¡å™¨ç«¯æ˜¯å¦èƒ½å‡çº§åˆ°HTTP2ç”šè‡³æ˜¯WebSocketsåè®®ã€‚è€Œè¿™ä¸ªæœºåˆ¶çš„åšæ³•å¦‚ <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Protocol_upgrade_mechanism">mozilla åè®®å‡çº§æœºåˆ¶</a> æ–‡æ¡£æ‰€è¯´ï¼Œåœ¨å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™å°†ä¼šæ·»åŠ ä¸¤ä¸ªé¢å¤–çš„ Header å†…å®¹ï¼š</p>

<p>Connection: Upgrade    è®¾ç½® Connection å¤´çš„å€¼ä¸º â€œUpgradeâ€ æ¥æŒ‡ç¤ºè¿™æ˜¯ä¸€ä¸ªå‡çº§è¯·æ±‚</p>

<p>Upgrade: protocols     Upgrade å¤´æŒ‡å®šä¸€é¡¹æˆ–å¤šé¡¹åè®®åï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œä»¥é€—å·åˆ†éš”</p>

<p>ä¸€ä¸ªå…¸å‹çš„åŒ…å«å‡çº§è¯·æ±‚çš„ä¾‹å­å·®ä¸å¤šæ˜¯è¿™æ ·çš„ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /foo HTTP/1.1
Host: www.example.com
Connection: upgrade
Upgrade: example/1, foo/2
</code></pre></div></div>

<p>è€Œåœ¨æˆ‘è¿™è¾¹å…¶å®æ˜¯ä¸ºäº†è®© Nginx æ”¯æŒ WebSockets åè®®ï¼Œå¦‚ <a href="https://blog.sdlsj.net/archives/nginx/nginx-reverse-proxy-websocket/">nginx åå‘ä»£ç†websocket â€“ A Blog</a> æ‰€è¯´æ–¹æ³•ï¼Œé…ç½®å¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade"; 
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„é”…å°±æ˜¯ï¼Œæ— è®ºæ˜¯å¦æœ‰é…ç½® Upgrade çš„å†…å®¹ï¼Œéƒ½ç»™ Connection åŠ ä¸Šäº† upgrade çš„å†…å®¹</p>

<p>å’±å¯ä»¥æ¥å†™ä¸€ä¸ªç®€å•çš„ demo ç¨‹åºï¼Œå°è¯•åœ¨ ASP.NET Core åº”ç”¨å‘é€ä¸€ä¸ª POST è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚é‡Œé¢åŒ…å«äº†è¿™ä¸¤ä¸ª Header ä¿¡æ¯ï¼Œå¦‚ä¸‹é¢ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>

            <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Upgrade"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
            <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Connection"</span><span class="p">,</span> <span class="s">"Upgrade"</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™ä¸ª demo ä»£ç æ”¾åœ¨<a href="https://gitee.com/lindexi/lindexi_gd/tree/314e0946/HekecicalLechurlaiberlefofe">gitee</a>æ¬¢è¿å¤§å®¶è®¿é—®</p>

<p>è¿™ä¸ª demo é‡Œé¢ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰ä½¿ç”¨ UseExceptionHandler çš„å¦‚ä¸‹é‡è½½æ–¹æ³•æ‰ä¼šè¿›å…¥ï¼Œè€Œå…¶ä»–çš„é‡è½½æ–¹æ³•è¿›å…¥å¤±è´¥</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">app</span><span class="p">.</span><span class="nf">UseExceptionHandler</span><span class="p">(</span><span class="n">builder</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="c1">// è¿™æ˜¯ä¼šè¿›æ¥çš„</span>
            <span class="p">});</span>
</code></pre></div></div>

<p>ä»è¾“å‡ºçš„æ—¥å¿—é‡Œé¢å¯ä»¥çœ‹åˆ°ä¸‹é¢ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dbug: Microsoft.AspNetCore.Server.Kestrel[39]
      Connection id "0HM5U310J8F34" accepted.
dbug: Microsoft.AspNetCore.Server.Kestrel[1]
      Connection id "0HM5U310J8F34" started.
dbug: Microsoft.AspNetCore.Server.Kestrel[17]
      Connection id "0HM5U310J8F34" bad request data: "Requests with 'Connection: Upgrade' cannot have content in the request body."
Microsoft.AspNetCore.Server.Kestrel.Core.BadHttpRequestException: Requests with 'Connection: Upgrade' cannot have content in the request body.
   at Microsoft.AspNetCore.Server.Kestrel.Core.BadHttpRequestException.Throw(RequestRejectionReason reason)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1MessageBody.For(HttpVersion httpVersion, HttpRequestHeaders headers, Http1Connection context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1Connection.CreateMessageBody()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequestsAsync[TContext](IHttpApplication`1 application)
</code></pre></div></div>

<p>ä¹Ÿå°±æ˜¯è¯´å¼€å¯è°ƒè¯•æ¨¡å¼çš„æ—¥å¿—ï¼Œå¯ä»¥äº†è§£åˆ°è¾“å‡ºäº† <code class="language-plaintext highlighter-rouge">Requests with 'Connection: Upgrade' cannot have content in the request body.</code> çš„å†…å®¹ã€‚å¼€å¯æ—¥å¿—çš„æ–¹æ³•å°±æ˜¯åœ¨ appsettings.json å’Œ appsettings.Development.json è®¾ç½®æ—¥å¿—ç­‰çº§ä¸º Debug å°±å¯ä»¥</p>

<p>è€Œè¿™ä¸ªé—®é¢˜ï¼Œå®˜æ–¹ä¹Ÿæœ‰æ”¶åˆ°åé¦ˆï¼Œè¯·çœ‹ <a href="https://github.com/dotnet/aspnetcore/issues/17081">â€œConnection: upgradeâ€ causes 400 error that never reaches application code. Triggered by common nginx config. Â· Issue #17081 Â· dotnet/aspnetcore</a></p>

<p>è™½ç„¶è¿™æ ·åšæ˜¯ä¸ç¬¦åˆè§„èŒƒçš„ï¼Œä½†æ˜¯ç”¨çš„äººå¤šäº†ï¼Œä¹Ÿå°±çº¦å®šä¿—æˆäº†ã€‚è€Œ Kestrel æ¯”è¾ƒä¸¥æ ¼çš„éµå®ˆæ ‡å‡†å´åœ¨æ­¤æ—¶æŒ–äº†ä¸€ä¸ªå‘ã€‚æœ€è¿‘æœ‰ä¸€ä¸ª PR æ˜¯å…è®¸å¿½ç•¥æ‰åŠ ä¸Š upgrade åœ¨ POST å¸¦ä¸Š Body çš„é€»è¾‘åˆå…¥åˆ° dotnet core 2.1 å’Œ dotnet core 3.1 å’Œ dotnet 5.0 ç‰ˆæœ¬ï¼Œä¹Ÿè®¸åœ¨ä½ çœ‹åˆ°è¿™ä¸ªåšå®¢çš„æ—¶å€™ï¼Œå’±çš„åº”ç”¨å…¶å®èƒ½åšåˆ°é»˜è®¤æ”¯æŒçš„</p>

<p>è€Œå…¶å®åœ¨å®˜æ–¹æ–‡æ¡£é‡Œé¢ä¹Ÿç»™å‡ºäº†æ¨èçš„ Nginx çš„é…ç½®ï¼Œå¦‚ä¸‹ï¼Œä½†æ˜¯å¦‚ä¸‹é…ç½®å¯æ˜¯ä¼šç»™ websocket æŒ–å‘çš„å“¦ï¼Œè¯¦ç»†è¯·çœ‹ <a href="https://blog.sdlsj.net/archives/nginx/nginx-reverse-proxy-websocket/">nginx åå‘ä»£ç†websocket â€“ A Blog</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen        80;
    server_name   example.com *.example.com;
    location / {
        proxy_pass         http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection keep-alive;
        proxy_set_header   Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°åœ¨å®˜æ–¹çš„é…ç½®é‡Œé¢ç»™ Connection é…ç½®çš„æ˜¯ keep-alive å“ˆï¼Œä½†å¦‚æœéœ€è¦æ”¯æŒ websocket å¦‚ signalr æŠ€æœ¯ï¼Œæ­¤æ—¶çš„é…ç½®å¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
  map $http_connection $connection_upgrade {
    "~*Upgrade" $http_connection;
    default keep-alive;
}

  server {
    listen 80;
    server_name example.com *.example.com;

    # Configure the SignalR Endpoint
    location /hubroute {
      # App server url
      proxy_pass http://localhost:5000;

      # Configuration for WebSockets
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_cache off;

      # Configuration for ServerSentEvents
      proxy_buffering off;

      # Configuration for LongPolling or if your KeepAliveInterval is longer than 60 seconds
      proxy_read_timeout 100s;

      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}
</code></pre></div></div>

<p>ä¸Šé¢æ ¸å¿ƒçš„é…ç½®æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">http_connection</code> å˜é‡æ¥å†³å®š <code class="language-plaintext highlighter-rouge">connection_upgrade</code> å˜é‡çš„å†…å®¹ã€‚å¦‚æœæœ‰ Upgrade çš„ï¼Œé‚£ä¹ˆä¹Ÿåœ¨ Connection ä¸ŠåŠ ä¸Š Upgrade çš„ï¼Œå¦åˆ™å°±ä½¿ç”¨  keep-alive ä½œä¸ºå†…å®¹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  map $http_connection $connection_upgrade {
    "~*Upgrade" $http_connection;
    default keep-alive;
}
</code></pre></div></div>

<p>ç‰¹åˆ«æ„Ÿè°¢ <a href="https://blog.sdlsj.net">lsj</a> çš„ååŠ©ï¼Œä»¥åŠè¿ç»´å°ä¼Ÿå¤§ä½¬çš„æ–¹æ³•</p>

<p>è€Œæˆ‘ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘å¯ä»¥å¦‚ä½•åœ¨é‡åˆ°è¿™æ ·çš„é—®é¢˜çš„æ—¶å€™ï¼Œé€šè¿‡æˆ‘çš„åº”ç”¨çš„æ—¥å¿—äº†è§£åˆ°</p>

<p>æ›´å¤šè¯·çœ‹</p>

<p><a href="https://github.com/dotnet/aspnetcore/issues/17081">â€œConnection: upgradeâ€ causes 400 error that never reaches application code. Triggered by common nginx config. Â· Issue #17081 Â· dotnet/aspnetcore</a></p>

<p><a href="https://github.com/dotnet/aspnetcore/pull/28896">[5.0] Allow/ignore upgrades with bodies by Tratcher Â· Pull Request #28896 Â· dotnet/aspnetcore</a></p>

<p><a href="https://github.com/dotnet/aspnetcore/pull/28907">[3.1] Allow/ignore upgrades with bodies by Tratcher Â· Pull Request #28907 Â· dotnet/aspnetcore</a></p>

<p><a href="https://github.com/dotnet/aspnetcore/pull/28908">[2.1] Allow/ignore upgrades with bodies by Tratcher Â· Pull Request #28908 Â· dotnet/aspnetcore</a></p>

<p><a href="https://blog.sdlsj.net/archives/nginx/nginx-reverse-proxy-websocket/">nginx åå‘ä»£ç†websocket â€“ A Blog</a></p>

<p><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-5.0&amp;WT.mc_id=WD-MVP-5003260">Configure ASP.NET Core to work with proxy servers and load balancers</a></p>

<p><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-5.0&amp;WT.mc_id=WD-MVP-5003260">Host ASP.NET Core on Linux with Nginx</a></p>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Protocol_upgrade_mechanism">åè®®å‡çº§æœºåˆ¶ - HTTP</a></p>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Connection">Connection - HTTP</a></p>

<p><a href="https://github.com/dotnet/aspnetcore/issues/4726">Kestrel returns 400 before reaching any of my code Â· Issue #4726 Â· dotnet/aspnetcore</a></p>

<p><a href="https://github.com/dotnet/AspNetCore.Docs/issues/12157">How to log automatic 400 responses on model validation errors Â· Issue #12157 Â· dotnet/AspNetCore.Docs</a></p>

<p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel/options?view=aspnetcore-5.0&amp;WT.mc_id=WD-MVP-5003260">Configure options for the ASP.NET Core Kestrel web server</a></p>

<p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-5.0&amp;WT.mc_id=WD-MVP-5003260">Handle errors in ASP.NET Core</a></p>

<p><a href="https://stackoverflow.com/questions/45479094/how-to-auto-log-every-request-in-net-core-webapi?WT.mc_id=WD-MVP-5003260">c# - How to auto log every request in .NET Core WebAPI? - Stack Overflow</a></p>

:ET