I"•&<p>åœ¨ WPF åˆ‡æ¢å…‰æ ‡çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯é€šè¿‡æœ¬åœ°èµ„æºçš„æ–¹æ³•ä¼ å…¥ stream çš„ï¼Œéœ€è¦å…ˆå¤åˆ¶åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹é‡Œé¢çš„æ–‡ä»¶ï¼Œç„¶åè¯»å–æ–‡ä»¶æŒ‡é’ˆé‡Šæ”¾æ–‡ä»¶ã€‚å¦‚æœæ­¤æ—¶çš„ temp æ–‡ä»¶å¤¹æ»¡äº†ï¼Œé‚£ä¹ˆå¤åˆ¶æ–‡ä»¶çš„æ—¶å€™å°±æ— æ³•ç»§ç»­äº†ï¼Œäºæ˜¯å°±æ— æ³•åˆ›å»ºå®Œæˆå…‰æ ‡</p>

<!--more-->

<!-- CreateTime:2019/5/16 19:16:27 -->

<!-- csdn -->

<p>æœ€è¿‘æœ‰è€å¸ˆæ‰¾æˆ‘è¯´è½¯ä»¶æ— æ³•ä½¿ç”¨äº†ï¼Œæˆ‘å°è¯•è°ƒè¯•ä»–çš„ç”µè„‘ï¼Œå‘ç°ä»»ä½•ä¿®æ”¹å…‰æ ‡çš„ä»£ç å°±æ— æ³•ç»§ç»­ï¼Œå› ä¸ºæ— æ³•åˆ›å»ºå…‰æ ‡</p>

<p>å¤§æ¦‚çš„ä¿®æ”¹å…‰æ ‡çš„ä»£ç æ˜¯è¿™æ ·å†™çš„ï¼Œä»è§£å†³æ–¹æ¡ˆé‡Œé¢æ”¾ä¸€ä¸ªå…‰æ ‡æ–‡ä»¶ï¼Œè®¾ç½®ä¸ºèµ„æºé€šè¿‡<a href="https://blog.lindexi.com/post/win10-uwp-%E8%AE%BF%E9%97%AE%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%96%87%E4%BB%B6.html">è®¿é—®è§£å†³æ–¹æ¡ˆæ–‡ä»¶</a> æ‹¿åˆ°èµ„æº</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">uri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"pack://application:,,,/Text.cur"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">resource</span> <span class="p">=</span> <span class="n">Application</span><span class="p">.</span><span class="nf">GetResourceStream</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>
<span class="n">Cursor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Cursor</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">Stream</span><span class="p">);</span>
</code></pre></div></div>

<p>çœ‹åˆ°çš„å †æ ˆå¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   åœ¨ System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)
   åœ¨ System.IO.Directory.InternalCreateDirectory(String fullPath, String path, Object dirSecurityObj, Boolean checkHost)
   åœ¨ System.IO.Directory.InternalCreateDirectoryHelper(String path, Boolean checkHost)
   åœ¨ System.IO.Directory.CreateDirectory(String path)
   åœ¨ System.IO.FileHelper.CreateAndOpenTemporaryFile(String&amp; filePath, FileAccess fileAccess, FileOptions fileOptions, String extension, String subFolder)
   åœ¨ System.Windows.Input.Cursor.LoadFromStream(Stream cursorStream)
   åœ¨ System.Windows.Input.Cursor..ctor(Stream cursorStream, Boolean scaleWithDpi)
   åœ¨ System.Windows.Input.Cursor..ctor(Stream cursorStream)
   åœ¨ FawlalnejajerelaWhallgemcurkear.MainWindow..ctor() ä½ç½® D:\lindexi\ç¨‹åº\FawlalnejajerelaWhallgemcurkear\FawlalnejajerelaWhallgemcurkear\MainWindow.xaml.cs:è¡Œå· 32
</code></pre></div></div>

<p>é€šè¿‡è¯»æºä»£ç ï¼Œå‘ç°åœ¨ <a href="https://referencesource.microsoft.com/#PresentationCore/Core/CSharp/System/Windows/Input/Cursor.cs,090cb505b6310a4e">LoadFromStream</a> æ–¹æ³•é‡Œé¢æ˜¯è¿™æ ·å†™çš„</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">LoadFromStream</span><span class="p">(</span><span class="n">Stream</span> <span class="n">cursorStream</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">filePath</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
 
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="c1">// Generate a temporary file based on the memory stream.</span>
                <span class="c1">// ä» temp æ–‡ä»¶å¤¹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="n">FileHelper</span><span class="p">.</span><span class="nf">CreateAndOpenTemporaryFile</span><span class="p">(</span><span class="k">out</span> <span class="n">filePath</span><span class="p">))</span>
                <span class="p">{</span>
                	<span class="c1">// å¤åˆ¶åˆ°æ–‡ä»¶</span>
                    <span class="n">cursorStream</span><span class="p">.</span><span class="nf">CopyTo</span><span class="p">(</span><span class="n">fileStream</span><span class="p">);</span>
                <span class="p">}</span>
 
                <span class="c1">// ä»æ–‡ä»¶é‡Œé¢è¯»å–å…‰æ ‡</span>
                <span class="c1">// create a cursor from the temp file</span>
                <span class="n">_cursorHandle</span> <span class="p">=</span> <span class="n">UnsafeNativeMethods</span><span class="p">.</span><span class="nf">LoadImageCursor</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span>
                    <span class="n">NativeMethods</span><span class="p">.</span><span class="n">IMAGE_CURSOR</span><span class="p">,</span>
                    <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span>
                    <span class="n">NativeMethods</span><span class="p">.</span><span class="n">LR_DEFAULTCOLOR</span> <span class="p">|</span>
                    <span class="n">NativeMethods</span><span class="p">.</span><span class="n">LR_LOADFROMFILE</span> <span class="p">|</span>
                    <span class="p">(</span><span class="n">_scaleWithDpi</span><span class="p">?</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="n">LR_DEFAULTSIZE</span> <span class="p">:</span> <span class="m">0x0000</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_cursorHandle</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">_cursorHandle</span><span class="p">.</span><span class="n">IsInvalid</span><span class="p">)</span>
                <span class="p">{</span>
                     <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">SRID</span><span class="p">.</span><span class="n">Cursor_InvalidStream</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span> 
            	<span class="c1">// å°è¯•åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œå› ä¸ºå…‰æ ‡å·²ç»è¯»å–äº†</span>
                <span class="n">FileHelper</span><span class="p">.</span><span class="nf">DeleteTemporaryFile</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ FileHelper.CreateAndOpenTemporaryFile å°†ä¼šè¯»å–åˆ°ä¸€ä¸ª temp æ–‡ä»¶å¤¹é‡Œé¢çš„æ–‡ä»¶ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªæ–‡ä»¶æ— æ³•è®¿é—®ï¼Œé‚£ä¹ˆå°†ä¸èƒ½ç»§ç»­</p>

<p>åœ¨æˆ‘çš„è®¾å¤‡ä¸Šæ˜¯å¾ˆéš¾åšåˆ°è®© temp æ–‡ä»¶å¤¹æ— æ³•è®¿é—®çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡<a href="https://blog.walterlv.com/post/redirect-environment-temp-folder.html">é€šè¿‡ä¿®æ”¹ç¯å¢ƒå˜é‡ä¿®æ”¹å½“å‰è¿›ç¨‹ä½¿ç”¨çš„ç³»ç»Ÿ Temp æ–‡ä»¶å¤¹çš„è·¯å¾„</a>è®¾ç½®ä¸€ä¸ªæ— æ³•è®¿é—®çš„æ–‡ä»¶å¤¹ä½œä¸º temp æ–‡ä»¶å¤¹</p>

<p>åšä¸€ä¸ªæ— æ³•è®¿é—®çš„æ–‡ä»¶å¤¹å¾ˆç®€å•ï¼Œåªéœ€è¦å³å‡»å±æ€§å®‰è£…ï¼Œå»æ‰ç”¨æˆ·å°±å¯ä»¥äº†</p>

<p>è¿è¡Œä»£ç å°±ä¼šå‘ç°æç¤ºå¯¹è·¯å¾„è®¿é—®æ‹’ç»</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">System</span><span class="p">.</span><span class="n">UnauthorizedAccessException</span><span class="p">:</span><span class="err">â€œå¯¹è·¯å¾„â€œ</span><span class="n">D</span><span class="p">:</span><span class="err">\</span><span class="n">lindexi</span><span class="err">\æ— æ³•è®¿é—®æ–‡ä»¶å¤¹\</span><span class="n">WPF</span><span class="err">â€çš„è®¿é—®è¢«æ‹’ç»ã€‚â€</span>
</code></pre></div></div>

<p>å¯ä»¥çš„è§£å†³æ–¹æ³•æœ‰ä¸¤ä¸ª</p>

<ol>
  <li>é€šè¿‡ç¯å¢ƒå˜é‡ä¿®æ”¹ temp æ–‡ä»¶å¤¹ä½œä¸ºç¨‹åºè‡ªå·±å†…éƒ¨çš„æ•°æ®æ–‡ä»¶å¤¹ï¼Œè¿™å’Œ UWP çš„ç›¸åŒï¼Œæ¯ä¸ªç¨‹åºéƒ½å¯ä»¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ temp æ–‡ä»¶å¤¹ï¼Œå¯ä»¥è§£å†³æœ‰ä¸€äº›é€—æ¯”è½¯ä»¶ä¼šæ›´æ”¹æ•´ä¸ª temp æ–‡ä»¶å¤¹æˆ–é‡Œé¢æŸäº›æ–‡ä»¶å¤¹çš„è®¿é—®æƒé™æˆ–æœ‰é€—æ¯”åœ¨ temp æ–‡ä»¶å¤¹å†™å…¥äº† 65535 ä¸ªæ–‡ä»¶è®©å…¶ä»–ç¨‹åºæ— æ³•å†™å…¥æ–‡ä»¶ã€‚ä»å¾®è½¯å®˜æ–¹<a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-gettempfilenamea">æ–‡æ¡£</a> å¯ä»¥çŸ¥é“ temp æ–‡ä»¶å¤¹çš„æ–‡ä»¶é™åˆ¶ã€‚</li>
  <li>åªå¯¹å…‰æ ‡çš„ä¿®æ”¹å°†è§£å†³æ–¹æ¡ˆé‡Œé¢çš„æ–‡ä»¶ä¿®æ”¹ä¸ºè¾“å‡ºçš„æ–‡ä»¶ï¼Œæ­¤æ—¶å°†ä¼šè°ƒç”¨ LoadFromFile æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¯»å–æ–‡ä»¶ä¸éœ€è¦å¤åˆ¶æ–‡ä»¶ï¼Œç›¸å¯¹æ€§èƒ½æ¯”è¾ƒå¿«</li>
</ol>

<p>ä¸Šé¢æä¾›çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ–¹æ³•é™¤äº†è§£å†³å…‰æ ‡çš„é—®é¢˜ï¼Œè¿˜å¯ä»¥è§£å†³å…¶ä»–é—®é¢˜ã€‚ç¬¬äºŒä¸ªæ–¹æ³•å¯ä»¥æå‡ä¸€ç‚¹æ€§èƒ½ï¼ŒåŒæ—¶ä¸¤ä¸ªæ–¹æ³•å¯ä»¥ä¸€èµ·ä½¿ç”¨</p>

<p>è¿™ä¸ªé—®é¢˜æäº¤ç»™å¾®è½¯ï¼Œæ¬¢è¿å°ä¼™ä¼´ç‚¹å‡» <a href="https://github.com/dotnet/wpf/issues/696">Full temporary folder will crash cursor initialization</a> å¸®æˆ‘ç‚¹èµ</p>

<p><a href="https://blog.walterlv.com/post/redirect-environment-temp-folder.html">é€šè¿‡ä¿®æ”¹ç¯å¢ƒå˜é‡ä¿®æ”¹å½“å‰è¿›ç¨‹ä½¿ç”¨çš„ç³»ç»Ÿ Temp æ–‡ä»¶å¤¹çš„è·¯å¾„ - walterlv</a></p>

<p><a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-gettempfilenamea?wt.mc_id=MVP">GetTempFileNameA function (fileapi.h)</a></p>

<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.path.gettempfilename?wt.mc_id=MVP">Path.GetTempFileName Method (System.IO)</a></p>

:ET