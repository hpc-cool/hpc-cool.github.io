I"<p>我需要有两个层级最高的窗口，但是要求某个窗口在另一个的上方，同时这两个窗口在所有其他的应用程序窗口的上方</p>

<!--more-->

<!-- CreateTime:6/17/2020 8:29:09 PM -->

<p>需要用到 SetWindowLong 的 win32 方法的设置，假设我有 A 和 B 两个窗口，我需要让这两个窗口都是 Topmost 同时 A 在 B 的上方</p>

<p>大概逻辑如下</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">B</span><span class="p">.</span><span class="n">Loaded</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">A</span><span class="p">.</span><span class="n">Topmost</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="n">A</span><span class="p">.</span><span class="n">Topmost</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                <span class="n">B</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">InvokeAsync</span><span class="p">(()</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">Win32</span><span class="p">.</span><span class="n">User32</span><span class="p">.</span><span class="nf">SetWindowLongPtr</span><span class="p">(</span><span class="k">new</span> <span class="nf">WindowInteropHelper</span><span class="p">(</span><span class="n">A</span><span class="p">).</span><span class="n">Handle</span><span class="p">,</span>
                        <span class="n">Win32</span><span class="p">.</span><span class="n">GetWindowLongFields</span><span class="p">.</span><span class="n">GWL_HWNDPARENT</span><span class="p">,</span> <span class="k">new</span> <span class="nf">WindowInteropHelper</span><span class="p">(</span><span class="n">B</span><span class="p">).</span><span class="n">Handle</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">};</span>
</code></pre></div></div>

<p>为什么需要在 B 的 Loaded 之后，原因是为了窗口实际创建出来，拿到句柄</p>

<p>为什么还需要做延迟一拍设置，因为立刻设置可能和控件初始化冲突，如 Popup 刚好弹出，将不会收起。注意这是在一个特别复杂的项目里面才发现这个坑，我创建空白项目没有发现这个坑</p>

<p>这里的 SetWindowLongPtr 是 SetWindowLong 方法，只是封装了 x86 和 x64 的代码</p>

<p>关于 GWL_HWNDPARENT 的定义如下</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">enum</span> <span class="n">GetWindowLongFields</span>
    <span class="p">{</span>
      <span class="n">GWL_USERDATA</span> <span class="p">=</span> <span class="p">-</span><span class="m">21</span><span class="p">,</span> <span class="c1">// 0xFFFFFFEB</span>
      <span class="n">GWL_EXSTYLE</span> <span class="p">=</span> <span class="p">-</span><span class="m">20</span><span class="p">,</span> <span class="c1">// 0xFFFFFFEC</span>
      <span class="n">GWL_STYLE</span> <span class="p">=</span> <span class="p">-</span><span class="m">16</span><span class="p">,</span> <span class="c1">// 0xFFFFFFF0</span>
      <span class="n">GWL_ID</span> <span class="p">=</span> <span class="p">-</span><span class="m">12</span><span class="p">,</span> <span class="c1">// 0xFFFFFFF4</span>
      <span class="n">GWL_HWNDPARENT</span> <span class="p">=</span> <span class="p">-</span><span class="m">8</span><span class="p">,</span> <span class="c1">// 0xFFFFFFF8</span>
      <span class="n">GWL_HINSTANCE</span> <span class="p">=</span> <span class="p">-</span><span class="m">6</span><span class="p">,</span> <span class="c1">// 0xFFFFFFFA</span>
      <span class="n">GWL_WNDPROC</span> <span class="p">=</span> <span class="p">-</span><span class="m">4</span><span class="p">,</span> <span class="c1">// 0xFFFFFFFC</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>设置两个窗口有关联和 WPF 的设置 Owner 几乎等价，只是这个 win32 方法可以在复杂项目也设置上去</p>

:ET