I"ã5<p>æœ¬æ–‡ç®€å•å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨ Span æ–°çš„åŠŸèƒ½
éœ€è¦çŸ¥é“ Span æ˜¯ 7.2 æ‰æœ‰çš„åŠŸèƒ½ï¼Œå¦‚æœåœ¨æ­£å¼é¡¹ç›®ä½¿ç”¨ï¼Œå»ºè®®å®‰è£… Nuget çš„æ–¹å¼</p>

<!--more-->

<!-- CreateTime:2018/12/2 11:32:46 -->

<p>åœ¨å¯¹å†…å­˜æŒ‡å®šçš„ä¸€æ®µçš„å¤„ç†ï¼ŒåŸæ¥çš„ C# æ˜¯æ¯”è¾ƒå¼±çš„ï¼Œå› ä¸ºæ²¡æœ‰äº† C++ çš„æŒ‡é’ˆï¼Œç‰¹åˆ«æ˜¯å¯¹äºå­—ç¬¦ä¸²çš„åˆ†å‰²ï¼Œéœ€è¦åˆ›å»ºå¤šå‡ ä¸ªå­—ç¬¦ä¸²ã€‚</p>

<p>åƒåœ¾å¾®è½¯ä¸ºäº†æé«˜ C# çš„æ€§èƒ½ï¼Œäºæ˜¯æä¾›äº†æ–°çš„ç±»å‹ Spanï¼Œè¿™ä¸ªç±»å¯ä»¥æ‹¿å‡ºä»»æ„æ•°ç»„çš„ä¸€æ®µï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„ Span åˆ—è¡¨ã€‚è¿™æ ·çš„åº•å±‚å°±æ˜¯æŒ‡é’ˆï¼Œè€Œä¸”æŒ‡é’ˆæ˜¯æœ‰åˆ¤æ–­æ˜¯å¦è¶…è¿‡èŒƒå›´æ¯” C++ å®‰å…¨ã€‚</p>

<p>é¦–å…ˆå®‰è£… Nuget System.Memory åº“ï¼Œè¦æ±‚ dotnet framework 4.5 ä»¥ä¸Šï¼Œåœ¨ UWP 16299 ä»¥ä¸Šï¼Œåœ¨ dotnet core 2.0 ä»¥ä¸Š</p>

<!-- ![](image/C# Span å…¥é—¨/C# Span å…¥é—¨0.png) -->
<p><img src="http://image.acmx.xyz/lindexi%2F20186181120389359.jpg" alt="" /></p>

<p>å…ˆæ¥å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åä½¿ç”¨ Span æŒ‡å®šæ•°ç»„çš„æŸä¸€æ®µ</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">10</span><span class="p">];</span>
            <span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">array</span><span class="p">;</span> 
            <span class="n">bytes</span> <span class="p">=</span> <span class="n">bytes</span><span class="p">.</span><span class="nf">Slice</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="m">5</span><span class="p">);</span>

            <span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="m">2</span><span class="p">]);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°å¯¹ bytes[0] çš„ä¿®æ”¹å°±æ˜¯å¯¹ array[2] çš„ä¿®æ”¹ï¼Œè¿™æ ·å¯ä»¥åšåˆ°æ•°ç»„é‡æ–°è®¡ç®—ã€‚</p>

<p>ä¹Ÿå°±æ˜¯å¯¹æŸä¸ªè®¡ç®—ï¼Œéœ€è¦åŠ ä¸Šæ•°ç»„çš„ç§»åŠ¨ï¼Œå¦‚äºŒç»´æ•°ç»„çš„å›¾ç‰‡è®¡ç®—ï¼Œä¾‹å¦‚è¡Œæ˜¯ w åˆ—æ˜¯ h ï¼Œé‚£ä¹ˆè®¡ç®—ç¬¬ n è¡Œçš„å…ƒç´ ï¼Œåœ¨ä»¥å‰çš„æ—¶å€™ï¼Œå°±éœ€è¦åœ¨æ¯ä¸ªçš„å‰é¢åŠ ä¸Šã€€<code class="language-plaintext highlighter-rouge">w*n</code>ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨ã€€<code class="language-plaintext highlighter-rouge">spanList.Slice(start:w*n, Length:w)</code> è¿™æ ·é‡æ–°æ‹¿åˆ°çš„æ•°ç»„å°±æ˜¯ä¸€è¡Œï¼Œä¸éœ€è¦åœ¨æ¯ä¸ªè®¡ç®—éƒ½éœ€è¦æ·»åŠ å¾ˆå¤šä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">10</span><span class="p">];</span>
            <span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">array</span><span class="p">;</span> 
            <span class="n">bytes</span> <span class="p">=</span> <span class="n">bytes</span><span class="p">.</span><span class="nf">Slice</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="m">5</span><span class="p">);</span>

            <span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="m">2</span><span class="p">]);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">bytes</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">IndexOutOfRangeException</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>æœ‰äº†è¿™ä¸ªç±»å°±ä¸éœ€è¦æ‹…å¿ƒå†™å‡ºè¶…è¿‡èŒƒå›´ä»£ç </p>

<h2 id="stackalloc">stackalloc</h2>

<p>å¦‚æœè¦å’Œ stackalloc éœ€è¦æ‰“å¼€ä¸å®‰å…¨ä»£ç </p>

<!-- ![](image/C# Span å…¥é—¨/C# Span å…¥é—¨1.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F20186181133158630.jpg" alt="" /></p>

<p>ç„¶åç‚¹å‡»ç”Ÿæˆé«˜çº§ï¼Œé€‰æ‹© C# 7.2 ä»¥ä¸Š</p>

<p>ç°åœ¨å¯ä»¥å†™å‡ºè¿™æ ·çš„ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">private</span> <span class="k">static</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">DroosorHotir</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">byte</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
            <span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
            <span class="n">bytes</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥è¾“å‡º 2 å’Œ 3 ï¼Œä½¿ç”¨ stackalloc å¯ä»¥æ¯”ç”³è¯·æ•°ç»„ä½¿ç”¨æ›´å°‘çš„èµ„æºã€‚å› ä¸ºé»˜è®¤ç”³è¯·çš„æ•°ç»„éƒ½åœ¨å †ä¸­ï¼Œä¸ä½¿ç”¨éœ€è¦ gc æ‰å¯ä»¥å›æ”¶ã€‚ä½†æ˜¯ stackalloc å¯ä»¥åœ¨å˜é‡æ‰€åœ¨å‡½æ•°ç»“æŸä¹‹åç›´æ¥å°±å›æ”¶ï¼Œä¸éœ€è¦ç§»åŠ¨å†…å­˜ã€‚</p>

<p>ä½†æ˜¯ stackalloc å®¹æ˜“å‡ºç°å †æ ˆæº¢å‡ºï¼Œè¯·æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œå †æ ˆæº¢å‡ºæ˜¯ catch ä¹Ÿæ— æ³•è®©ä»–ä¸è®©ç¨‹åºç›´æ¥é€€å‡º</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">200000</span><span class="p">];</span>

</code></pre></div></div>

<p>å³ä½¿ä½¿ç”¨ catch ï¼Œè½¯ä»¶ä¹Ÿä¼šç›´æ¥é€€å‡º</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">200000</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
            <span class="p">{</span>
               <span class="c1">// æ¥ä¸ä½</span>
            <span class="p">}</span>
</code></pre></div></div>

<h2 id="allochglobal">AllocHGlobal</h2>

<p>é™¤äº†ä½¿ç”¨ stackalloc ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Marshal.AllocHGlobal</code> ç”³è¯·ä¸€æ®µå†…å­˜</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">IntPtr</span> <span class="n">ptr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;((</span><span class="kt">byte</span><span class="p">*)</span> <span class="n">ptr</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span> <span class="p">{[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">42</span><span class="p">};</span>

                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span>
                <span class="n">Marshal</span><span class="p">.</span><span class="nf">FreeHGlobal</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„ï¼Œç”³è¯·çš„å†…å­˜éƒ½éœ€è¦è‡ªå·±é‡Šæ”¾</p>

<p>è€Œä¸”éœ€è¦æ³¨æ„ï¼Œä¸è¦ä½¿ç”¨æ¯”è‡ªå·±ç”³è¯·çš„å†…å­˜å¤§çš„æ•°ç»„</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">IntPtr</span> <span class="n">ptr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;((</span><span class="kt">byte</span><span class="p">*)</span> <span class="n">ptr</span><span class="p">,</span> <span class="m">1000</span><span class="p">)</span> <span class="p">{[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">42</span><span class="p">};</span>

</code></pre></div></div>

<p>ä¸Šé¢ä»£ç ç”³è¯·äº†å†…å­˜ä¸º 2 ä½†æ˜¯ä¸‹ä¸€å¥ä½¿ç”¨äº†1000é•¿åº¦</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">1000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">25</span><span class="p">;</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ—¶è™½ç„¶å¾ˆå¤šæ¬¡éƒ½å¯ä»¥èµ‹å€¼æˆåŠŸï¼Œä½†æ˜¯è¿è¡Œåˆ°æŸä¸ªæ—¶å€™ï¼Œè½¯ä»¶å°±ç›´æ¥é€€å‡ºã€‚</p>

<p>å‚è€ƒï¼š</p>

<p><a href="https://msdn.microsoft.com/en-us/magazine/mt814808.aspx">C# - All About Span: Exploring a New .NET Mainstay</a></p>

<p><a href="https://www.cnblogs.com/justmine/p/10006621.html">é€šä¿—æ˜“æ‡‚ï¼ŒC#å¦‚ä½•å®‰å…¨ã€é«˜æ•ˆåœ°ç©è½¬ä»»ä½•ç§ç±»çš„å†…å­˜ä¹‹Span(ä¸€)</a></p>

:ET