I"]”<p>æœ¬æ–‡å‘Šè¯‰å¤§å®¶é€šè¿‡ SharpDx ç”»å‡ºç®€å•çš„ 2D ç•Œé¢</p>

<!--more-->

<!-- CreateTime:2019/10/23 21:16:35 -->

<p>æœ¬æ–‡å±äº <a href="https://blog.lindexi.com/post/WPF-%E4%BD%BF%E7%94%A8-SharpDx-%E6%B8%B2%E6%9F%93%E5%8D%9A%E5%AE%A2%E5%AF%BC%E8%88%AA.html">SharpDx ç³»åˆ—</a> åšå®¢ï¼Œå»ºè®®ä»å¤´å¼€å§‹è¯»</p>

<p>æœ¬æ–‡åˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯åˆå§‹åŒ–ï¼Œç¬¬äºŒæ­¥æ‰æ˜¯ç”»ç•Œé¢</p>

<h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h2>

<p>å…ˆåˆ›å»º RenderForm ç”¨æ¥æ˜¾ç¤ºç•Œé¢ï¼Œåœ¨åˆ›å»ºçš„è¿‡ç¨‹éœ€è¦æŒ‡å®šå®½åº¦å’Œé«˜åº¦</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">_renderForm</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RenderForm</span><span class="p">();</span>
            <span class="n">_renderForm</span><span class="p">.</span><span class="n">ClientSize</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Size</span><span class="p">(</span><span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">);</span>

        <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">1280</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">Height</span> <span class="p">=</span> <span class="m">720</span><span class="p">;</span>
</code></pre></div></div>

<p>ä¸Šé¢åˆ›å»ºçš„ä»£ç å¤§éƒ¨åˆ†å‚é˜…äº†<a href="https://blog.csdn.net/lindexi_gd/article/details/82114907">C# ä»é›¶å¼€å§‹å†™ SharpDx åº”ç”¨ åˆå§‹åŒ–dxä¿®æ”¹é¢œè‰²</a>çš„ä»£ç </p>

<p>åœ¨ InitializeDeviceResources å‡½æ•°é‡Œé¢æ›´æ”¹ä¸€äº›å‚æ•°ï¼Œç”¨äºåˆ›å»ºèµ„æºå’Œåˆå§‹åŒ–</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">backBufferDesc</span> <span class="p">=</span>
                <span class="k">new</span> <span class="nf">ModeDescription</span><span class="p">(</span><span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Rational</span><span class="p">(</span><span class="m">60</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">Format</span><span class="p">.</span><span class="n">R8G8B8A8_UNorm</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">swapChainDesc</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SwapChainDescription</span>
            <span class="p">{</span>
                <span class="n">BufferCount</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
                <span class="n">ModeDescription</span> <span class="p">=</span> <span class="n">backBufferDesc</span><span class="p">,</span>
                <span class="n">IsWindowed</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="n">OutputHandle</span> <span class="p">=</span> <span class="n">_renderForm</span><span class="p">.</span><span class="n">Handle</span><span class="p">,</span>
                <span class="n">SampleDescription</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SampleDescription</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
                <span class="n">SwapEffect</span> <span class="p">=</span> <span class="n">SwapEffect</span><span class="p">.</span><span class="n">Discard</span><span class="p">,</span>
                <span class="n">Usage</span> <span class="p">=</span> <span class="n">Usage</span><span class="p">.</span><span class="n">RenderTargetOutput</span>
            <span class="p">};</span>

            <span class="n">Device</span><span class="p">.</span><span class="nf">CreateWithSwapChain</span><span class="p">(</span><span class="n">DriverType</span><span class="p">.</span><span class="n">Hardware</span><span class="p">,</span> <span class="n">DeviceCreationFlags</span><span class="p">.</span><span class="n">BgraSupport</span><span class="p">,</span> <span class="n">swapChainDesc</span><span class="p">,</span>
                <span class="k">out</span> <span class="n">_d3DDevice</span><span class="p">,</span> <span class="k">out</span> <span class="n">_swapChain</span><span class="p">);</span>

            <span class="n">_d3DDeviceContext</span> <span class="p">=</span> <span class="n">_d3DDevice</span><span class="p">.</span><span class="n">ImmediateContext</span><span class="p">;</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">backBuffer</span> <span class="p">=</span> <span class="n">_swapChain</span><span class="p">.</span><span class="n">GetBackBuffer</span><span class="p">&lt;</span><span class="n">Texture2D</span><span class="p">&gt;(</span><span class="m">0</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">_renderTargetView</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RenderTargetView</span><span class="p">(</span><span class="n">_d3DDevice</span><span class="p">,</span> <span class="n">backBuffer</span><span class="p">);</span>

                <span class="n">_viewport</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Viewport</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">);</span>
                <span class="n">_d3DDeviceContext</span><span class="p">.</span><span class="n">Rasterizer</span><span class="p">.</span><span class="nf">SetViewport</span><span class="p">(</span><span class="n">_viewport</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nf">CreateD2DRender</span><span class="p">();</span>
</code></pre></div></div>

<p>ä¸Šé¢å‚æ•°å’Œ<a href="https://blog.csdn.net/lindexi_gd/article/details/82114907">C# ä»é›¶å¼€å§‹å†™ SharpDx åº”ç”¨ åˆå§‹åŒ–dxä¿®æ”¹é¢œè‰²</a>çš„æœ‰ä¸€äº›ä¸ç›¸åŒï¼Œåœ¨ SwapChainDescription é‡Œé¢æ·»åŠ äº† SwapEffect å‚æ•°</p>

<p>åœ¨åˆ›å»ºäº¤æ¢é“¾çš„æ—¶å€™ï¼Œåœ¨ Device.CreateWithSwapChain é‡Œé¢ä¿®æ”¹äº† DeviceCreationFlags å‚æ•°</p>

<p>ä¸Šé¢å†…å®¹è¿˜æ˜¯åœ¨åˆ›å»º 3D å†…å®¹ï¼Œåœ¨ DX é‡Œé¢æ˜¯é€šè¿‡ä¸€ä¸ª 3D çš„å¹³é¢ç”» 2D ç•Œé¢</p>

<p>åœ¨ CreateD2DRender æ–¹æ³•é‡Œé¢æ‰æ˜¯åˆ›å»º 2D çš„ä»£ç </p>

<p>æƒ³è¦ç»˜åˆ¶ç•Œé¢éœ€è¦ <code class="language-plaintext highlighter-rouge">SharpDX.Direct2D1.RenderTarget</code> å¯¹è±¡ï¼Œéœ€è¦å…ˆåˆ›å»ºå·¥å‚ç„¶åé€šè¿‡å·¥å‚å’Œäº¤æ¢é“¾æ‹¿åˆ°å¹³é¢ï¼Œç„¶åå°†è¾“å‡ºå®šå‘åˆ°æ‹¿åˆ°çš„å¹³é¢</p>

<p>åˆ›å»ºå·¥å‚åªéœ€è¦ç›´æ¥åˆ›å»º</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">d2dFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SharpDX</span><span class="p">.</span><span class="n">Direct2D1</span><span class="p">.</span><span class="nf">Factory</span><span class="p">();</span>
</code></pre></div></div>

<p>ä»äº¤æ¢é“¾æ‹¿åˆ°å¹³é¢</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">Texture2D</span> <span class="n">backBuffer</span> <span class="p">=</span> <span class="n">D3D11</span><span class="p">.</span><span class="n">Resource</span><span class="p">.</span><span class="n">FromSwapChain</span><span class="p">&lt;</span><span class="n">Texture2D</span><span class="p">&gt;(</span><span class="n">_swapChain</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="n">Surface</span> <span class="n">surface</span> <span class="p">=</span> <span class="n">backBuffer</span><span class="p">.</span><span class="n">QueryInterface</span><span class="p">&lt;</span><span class="n">Surface</span><span class="p">&gt;();</span>
</code></pre></div></div>

<p>åˆ›å»º RenderTarget ç”¨äºç»˜å›¾</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">d2dRenderTarget</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RenderTarget</span><span class="p">(</span><span class="n">d2dFactory</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span>
                <span class="k">new</span> <span class="nf">RenderTargetProperties</span><span class="p">(</span><span class="k">new</span> <span class="nf">PixelFormat</span><span class="p">(</span><span class="n">Format</span><span class="p">.</span><span class="n">Unknown</span><span class="p">,</span> <span class="n">AlphaMode</span><span class="p">.</span><span class="n">Premultiplied</span><span class="p">)));</span>
</code></pre></div></div>

<p>è¿™é‡Œ CreateD2DRender æ–¹æ³•ä»£ç è¯·çœ‹ä¸‹é¢</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">DeviceContext</span> <span class="p">=</span> <span class="n">SharpDX</span><span class="p">.</span><span class="n">Direct2D1</span><span class="p">.</span><span class="n">DeviceContext</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Factory</span> <span class="p">=</span> <span class="n">SharpDX</span><span class="p">.</span><span class="n">Direct2D1</span><span class="p">.</span><span class="n">Factory</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">CreateD2DRender</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">d2dFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SharpDX</span><span class="p">.</span><span class="n">Direct2D1</span><span class="p">.</span><span class="nf">Factory</span><span class="p">();</span>
            <span class="n">Texture2D</span> <span class="n">backBuffer</span> <span class="p">=</span> <span class="n">D3D11</span><span class="p">.</span><span class="n">Resource</span><span class="p">.</span><span class="n">FromSwapChain</span><span class="p">&lt;</span><span class="n">Texture2D</span><span class="p">&gt;(</span><span class="n">_swapChain</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="n">Surface</span> <span class="n">surface</span> <span class="p">=</span> <span class="n">backBuffer</span><span class="p">.</span><span class="n">QueryInterface</span><span class="p">&lt;</span><span class="n">Surface</span><span class="p">&gt;();</span>
            <span class="kt">var</span> <span class="n">d2dRenderTarget</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RenderTarget</span><span class="p">(</span><span class="n">d2dFactory</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span>
                <span class="k">new</span> <span class="nf">RenderTargetProperties</span><span class="p">(</span><span class="k">new</span> <span class="nf">PixelFormat</span><span class="p">(</span><span class="n">Format</span><span class="p">.</span><span class="n">Unknown</span><span class="p">,</span> <span class="n">AlphaMode</span><span class="p">.</span><span class="n">Premultiplied</span><span class="p">)));</span>
            <span class="n">_d2dFactory</span> <span class="p">=</span> <span class="n">d2dFactory</span><span class="p">;</span>
            <span class="n">_d2dRenderTarget</span> <span class="p">=</span> <span class="n">d2dRenderTarget</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">Factory</span> <span class="n">_d2dFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">RenderTarget</span> <span class="n">_d2dRenderTarget</span><span class="p">;</span>
</code></pre></div></div>

<p>ç°åœ¨æ‹¿åˆ°äº† <code class="language-plaintext highlighter-rouge">_d2dRenderTarget</code> å°±å¯ä»¥ç”¨æ¥ç”» 2D çš„ç•Œé¢äº†ï¼Œå¼€å¯ç»˜åˆ¶å¾ªç¯ä¹‹åè¿›è¡Œç”»ç•Œé¢</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">RenderLoop</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">_renderForm</span><span class="p">,</span> <span class="n">RenderCallback</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RenderCallback</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Draw</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Draw</span><span class="p">()</span>
        <span class="p">{</span>
        	<span class="c1">// åœ¨è¿™é‡Œç»˜åˆ¶</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>ä¸‹é¢å°†ä¼šå‘Šè¯‰å¤§å®¶å¦‚ä½•åœ¨ Draw æ–¹æ³•é‡Œé¢ç»˜åˆ¶ç•Œé¢</p>

<h2 id="ç”»ç•Œé¢">ç”»ç•Œé¢</h2>

<p>åœ¨ Draw æ–¹æ³•é‡Œé¢ï¼Œä½¿ç”¨ä¸‹é¢æ–¹å¼ç”»ç•Œé¢</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">Draw</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">BeginDraw</span><span class="p">();</span>
           
            <span class="c1">// å®é™…ç”»çš„ä»£ç </span>

            <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">EndDraw</span><span class="p">();</span>


            <span class="n">_swapChain</span><span class="p">.</span><span class="nf">Present</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">PresentFlags</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>å…ˆè°ƒç”¨ BeginDraw æ–¹æ³•å¼€å¯ç»˜åˆ¶ï¼Œåœ¨è°ƒç”¨ EndDraw æ–¹æ³•å°†æ‰€æœ‰ç»˜åˆ¶æŒ‡ä»¤å‹ç¼©å¤„ç†ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç›´æ¥ä¼ é€åˆ°æ˜¾å¡æ¸²æŸ“</p>

<p>ç„¶åè°ƒç”¨äº¤æ¢é“¾ <code class="language-plaintext highlighter-rouge">_swapChain</code> å°†åå°ç¼“å­˜å’Œå‰å°æ˜¾ç¤ºäº¤æ¢ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°åˆ·æ–°ç•Œé¢</p>

<p>å…·ä½“ç”»çš„å†…å®¹å¯ä»¥åˆ†ä¸ºåŸºç¡€å›¾å½¢å’Œ 3D ç»˜åˆ¶</p>

<p>åœ¨æ‰€æœ‰å¼€å§‹ç»˜åˆ¶ä¹‹å‰éƒ½éœ€è¦è°ƒç”¨ BeginDraw æ–¹æ³•ï¼Œåœ¨ç»˜åˆ¶å®Œæˆä¹‹åè°ƒç”¨ EndDraw æ–¹æ³•å°†ç»˜åˆ¶çš„å‘½ä»¤å¤„ç†ï¼Œç„¶åå‘é€åˆ°æ˜¾å¡</p>

<h3 id="ç”»çº¿">ç”»çº¿</h3>

<p>ç”»çº¿æ¡éœ€è¦ä¼ å…¥ä¸¤ä¸ªç‚¹ï¼Œç”¨ä¸¤ä¸ªç‚¹ç”»å‡ºä¸€æ¡çº¿æ¡ï¼Œè¿˜æœ‰çº¿æ¡çš„ç¬”åˆ·ã€‚å¯é€‰çš„æ˜¯çº¿æ¡çš„å®½åº¦ï¼Œå’Œæ ·å¼</p>

<p>ä¸‹é¢ä»£ç æ˜¯ä½œä¸ºæ·»åŠ æ‰€æœ‰å‚æ•°çš„ä¾‹å­</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">BeginDraw</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SolidColorBrush</span><span class="p">(</span><span class="n">_d2dRenderTarget</span><span class="p">,</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Bisque</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">styleProperties</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StrokeStyleProperties</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">StartCap</span> <span class="p">=</span> <span class="n">CapStyle</span><span class="p">.</span><span class="n">Square</span><span class="p">,</span>
                <span class="n">EndCap</span> <span class="p">=</span> <span class="n">CapStyle</span><span class="p">.</span><span class="n">Round</span>
            <span class="p">};</span>
            <span class="kt">var</span> <span class="n">strokeStyle</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StrokeStyle</span><span class="p">(</span><span class="n">_d2dFactory</span><span class="p">,</span> <span class="n">styleProperties</span><span class="p">);</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">strokeStyle</span><span class="p">)</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">brush</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">DrawLine</span><span class="p">(</span><span class="k">new</span> <span class="nf">RawVector2</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">),</span> <span class="k">new</span> <span class="nf">RawVector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">),</span>
                    <span class="n">brush</span><span class="p">,</span> <span class="n">strokeWidth</span><span class="p">:</span> <span class="m">5</span><span class="p">,</span> <span class="n">strokeStyle</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">EndDraw</span><span class="p">();</span>
</code></pre></div></div>

<p>è¿è¡Œä»£ç å¯ä»¥çœ‹åˆ°ä¸‹é¢å›¾ç‰‡</p>

<!-- ![](image/C# ä»é›¶å¼€å§‹å†™ SharpDx åº”ç”¨ ç»˜åˆ¶åŸºç¡€å›¾å½¢/C# ä»é›¶å¼€å§‹å†™ SharpDx åº”ç”¨ ç»˜åˆ¶åŸºç¡€å›¾å½¢0.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2019616202452970" alt="" /></p>

<p>è¿™æ®µä»£ç å†™åœ¨ Draw å‡½æ•°é‡Œé¢ï¼Œåœ¨ SharpDx é‡Œé¢åˆ›å»ºçš„èµ„æºï¼Œä¾‹å¦‚ç¬”ç”»å’Œæ ·å¼ç­‰ï¼Œéƒ½éœ€è¦åšæ‰‹åŠ¨çš„é‡Šæ”¾ï¼Œè¿™éƒ¨åˆ†çš„å†™æ³•å’Œ WPF ä¸ç›¸åŒï¼Œéœ€è¦è‡ªå·±å…³æ³¨èµ„æºçš„åˆ›å»ºå’Œé‡Šæ”¾ï¼Œä½†æ˜¯è¿™æ ·åšæ‰èƒ½åšåˆ°æ›´æ”¹çš„æ€§èƒ½</p>

<p>åœ¨ StrokeStyleProperties é‡Œé¢æœ‰å¾ˆå¤šæœ‰è¶£çš„å‚æ•°ï¼Œè¯·å¤§å®¶è‡ªå·±ç©ä¸€ä¸‹</p>

<p>åœ¨ä»£ç é‡Œé¢ç”¨åˆ° ColorToRaw4 æ–¹æ³•ï¼Œå› ä¸ºåœ¨ SharpDx é‡Œé¢çš„é¢œè‰²ä½¿ç”¨çš„èŒƒå›´æ˜¯ 0-1 è€Œä¸æ˜¯ System.Drawing.Color ä½¿ç”¨ 255 èŒƒå›´</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">RawColor4</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span> <span class="n">color</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">float</span> <span class="n">n</span> <span class="p">=</span> <span class="m">255f</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">RawColor4</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">R</span> <span class="p">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">G</span> <span class="p">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">B</span> <span class="p">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">A</span> <span class="p">/</span> <span class="n">n</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡ ColorToRaw4 æ–¹æ³•å¯ä»¥è½¬æ¢é¢œè‰²</p>

<h3 id="çŸ©å½¢">çŸ©å½¢</h3>

<p>é€šè¿‡ DrawRectangle æ–¹æ³•å¯ä»¥ç”»å‡ºçŸ©å½¢ï¼Œåœ¨çŸ©å½¢é‡Œé¢éœ€è¦ä¼ å…¥ RawRectangleF å’Œé¢œè‰²ï¼Œå¯é€‰çº¿æ¡å®½åº¦å’Œæ ·å¼å’Œçº¿æ¡ç›¸åŒ</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SolidColorBrush</span><span class="p">(</span><span class="n">_d2dRenderTarget</span><span class="p">,</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Bisque</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">rect</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RawRectangleF</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">);</span>
           
            <span class="k">using</span> <span class="p">(</span><span class="n">brush</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">DrawRectangle</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>æ³¨æ„ RawRectangleF çš„æ„é€ å‡½æ•°ä¼ å…¥çš„æ˜¯å·¦ä¸Šå³ä¸‹è€Œä¸æ˜¯å·¦ä¸Šè§’çš„ç‚¹å’Œå®½åº¦é«˜åº¦</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">var</span> <span class="n">rect</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RawRectangleF</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">top</span><span class="p">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="m">100</span><span class="p">,</span> <span class="n">bottom</span><span class="p">:</span> <span class="m">100</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨æ²¡æœ‰æŒ‡å®šçº¿æ¡å®½åº¦æ˜¯ä¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">_d2dRenderTarget</code> çš„é»˜è®¤çº¿æ¡å®½åº¦ï¼Œé€šè¿‡ä¸‹é¢ä»£ç å¯ä»¥è®¾ç½®é»˜è®¤çº¿æ¡å®½åº¦</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="n">StrokeWidth</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</code></pre></div></div>

<p>åœ†è§’çŸ©å½¢å¯ä»¥ä½¿ç”¨ DrawRoundedRectangle æ–¹æ³•</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="kt">var</span> <span class="n">roundedRectangle</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RoundedRectangle</span><span class="p">();</span>
                <span class="n">roundedRectangle</span><span class="p">.</span><span class="n">Rect</span> <span class="p">=</span> <span class="n">rect</span><span class="p">;</span>
                <span class="n">roundedRectangle</span><span class="p">.</span><span class="n">RadiusX</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
                <span class="n">roundedRectangle</span><span class="p">.</span><span class="n">RadiusY</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">DrawRoundedRectangle</span><span class="p">(</span><span class="n">roundedRectangle</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„ rect å’Œ brush éƒ½æ˜¯ä¸Šé¢çš„ä»£ç </p>

<p>å¡«å……çŸ©å½¢ä½¿ç”¨ FillRectangle æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åªéœ€è¦ä¼ å…¥çŸ©å½¢å’Œç¬”åˆ·ï¼Œç¨å¾®æ›´æ”¹ä¸Šé¢çš„ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">FillRectangle</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿è¡Œä»£ç ä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¡«å……çš„çŸ©å½¢</p>

<p>å¡«å……çš„åœ†è§’çŸ©å½¢ä½¿ç”¨ FillRoundedRectangle æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¸éœ€è¦ä¼ å…¥çº¿æ¡å®½åº¦ç­‰</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">FillRoundedRectangle</span><span class="p">(</span><span class="n">roundedRectangle</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿è¡Œä¸Šé¢ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¡«å……çš„åœ†è§’çŸ©å½¢</p>

<h3 id="æ¤­åœ†">æ¤­åœ†</h3>

<p>ç”»æ¤­åœ†ä½¿ç”¨ DrawEllipse æ–¹æ³•ï¼Œä¼ å…¥æ¤­åœ†å’Œçº¿æ¡é¢œè‰²ï¼Œå¯é€‰çº¿æ¡å®½åº¦å’Œæ ·å¼</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SolidColorBrush</span><span class="p">(</span><span class="n">_d2dRenderTarget</span><span class="p">,</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Bisque</span><span class="p">));</span>

            <span class="kt">var</span> <span class="n">ellipse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Ellipse</span><span class="p">(</span><span class="k">new</span> <span class="nf">RawVector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">),</span> <span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">brush</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">DrawEllipse</span><span class="p">(</span><span class="n">ellipse</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>è¿è¡Œä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ä¸‹å›¾</p>

<!-- ![](image/C# ä»é›¶å¼€å§‹å†™ SharpDx åº”ç”¨ ç»˜åˆ¶åŸºç¡€å›¾å½¢/C# ä»é›¶å¼€å§‹å†™ SharpDx åº”ç”¨ ç»˜åˆ¶åŸºç¡€å›¾å½¢1.png) -->

<p><img src="http://image.acmx.xyz/lindexi%2F2019616204315473" alt="" /></p>

<p>åˆ›å»ºæ¤­åœ†æ—¶ä¼ å…¥çš„æ˜¯åœ†å¿ƒå’Œä¸¤ä¸ªæ–¹å‘çš„å¤§å°</p>

<p>å¡«å……æ¤­åœ†ä½¿ç”¨ FillEllipse æ–¹æ³•ï¼Œä¼ å…¥çš„æ˜¯ç¬”åˆ·ï¼Œä¸éœ€è¦ä¼ å…¥çº¿æ¡å®½åº¦ç­‰</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SolidColorBrush</span><span class="p">(</span><span class="n">_d2dRenderTarget</span><span class="p">,</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Bisque</span><span class="p">));</span>

            <span class="kt">var</span> <span class="n">ellipse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Ellipse</span><span class="p">(</span><span class="k">new</span> <span class="nf">RawVector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">),</span> <span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">brush</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">FillEllipse</span><span class="p">(</span><span class="n">ellipse</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨ä¸Šé¢ä»£ç å¯ä»¥å¡«å……æ¤­åœ†</p>

<h2 id="å‡ ä½•">å‡ ä½•</h2>

<p>å¤æ‚çš„å‡ ä½•å¯ä»¥ä½¿ç”¨ Geometry ç»˜åˆ¶</p>

<p>ä½¿ç”¨ DrawGeometry æ–¹æ³•ä¼ å…¥ Geometry å’Œé¢œè‰²ï¼Œå¯é€‰çº¿æ¡ç›¸å…³è®¾ç½®</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SolidColorBrush</span><span class="p">(</span><span class="n">_d2dRenderTarget</span><span class="p">,</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Bisque</span><span class="p">));</span>

            <span class="kt">var</span> <span class="n">rect</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RawRectangleF</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">top</span><span class="p">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="m">100</span><span class="p">,</span> <span class="n">bottom</span><span class="p">:</span> <span class="m">100</span><span class="p">);</span>
            <span class="n">Geometry</span> <span class="n">geometry</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RectangleGeometry</span><span class="p">(</span><span class="n">_d2dFactory</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>

            <span class="k">using</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">brush</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">DrawGeometry</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„ Geometry å¯é€‰çš„å¾ˆå¤šï¼Œæœ€æ”¯æŒå®šåˆ¶çš„æ˜¯ PathGeometry æ–¹æ³•</p>

<p>å¦‚ä½¿ç”¨å¾ˆå¤šä»£ç ç”»å‡ºçº¿æ¡</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">geometry</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PathGeometry</span><span class="p">(</span><span class="n">_d2dFactory</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">geometrySink</span> <span class="p">=</span> <span class="n">geometry</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
            <span class="n">geometrySink</span><span class="p">.</span><span class="nf">BeginFigure</span><span class="p">(</span><span class="k">new</span> <span class="nf">RawVector2</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">100</span><span class="p">),</span><span class="n">FigureBegin</span><span class="p">.</span><span class="n">Filled</span> <span class="p">);</span>
            <span class="n">geometrySink</span><span class="p">.</span><span class="nf">AddLine</span><span class="p">(</span><span class="k">new</span> <span class="nf">RawVector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">100</span><span class="p">));</span>
            <span class="n">geometrySink</span><span class="p">.</span><span class="nf">EndFigure</span><span class="p">(</span><span class="n">FigureEnd</span><span class="p">.</span><span class="n">Closed</span><span class="p">);</span>
            <span class="n">geometrySink</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
</code></pre></div></div>

<p>åœ¨ PathGeometry ä½¿ç”¨ Open æ–¹æ³•è¿”å› GeometrySink å¯ä»¥æ”¯æŒå¾ˆå¤šç»˜åˆ¶ï¼ŒåŒ…æ‹¬ç»„åˆå¤šä¸ªå‡ ä½•</p>

<h3 id="æ–‡å­—">æ–‡å­—</h3>

<p>ç»˜åˆ¶æ–‡å­—éœ€è¦ <code class="language-plaintext highlighter-rouge">SharpDX.DirectWrite.Factory</code> éœ€è¦å…ˆåˆ›å»ºæ‰èƒ½ä½¿ç”¨ï¼Œæ³¨æ„å·¥å‚éœ€è¦åªåˆ›å»ºä¸€æ¬¡</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SharpDX</span><span class="p">.</span><span class="n">DirectWrite</span><span class="p">.</span><span class="nf">Factory</span><span class="p">();</span>
</code></pre></div></div>

<p>åˆ›å»ºå·¥å‚å¯ä»¥ç”¨æ¥å®ä¾‹æ–‡æœ¬æ ¼å¼</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">textFormat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TextFormat</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="s">"å®‹ä½“"</span><span class="p">,</span> <span class="m">20</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨ TextFormat æ„é€ å‡½æ•°å¯ä»¥ä¼ å…¥å¾ˆå¤šå‚æ•°ï¼Œç”¨äºç»˜åˆ¶</p>

<p>ç»˜åˆ¶æ–‡æœ¬éœ€è¦ä½¿ç”¨ DrawText æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¼ å…¥éœ€è¦ç»˜åˆ¶çš„å­—ç¬¦ä¸²å’Œæ–‡æœ¬æ ¼å¼ï¼Œå’Œç»˜åˆ¶çš„èŒƒå›´å’Œé¢œè‰²</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="kt">var</span> <span class="n">brush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SolidColorBrush</span><span class="p">(</span><span class="n">_d2dRenderTarget</span><span class="p">,</span> <span class="nf">ColorToRaw4</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Bisque</span><span class="p">));</span>

            <span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SharpDX</span><span class="p">.</span><span class="n">DirectWrite</span><span class="p">.</span><span class="nf">Factory</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">textFormat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TextFormat</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="s">"å®‹ä½“"</span><span class="p">,</span> <span class="m">20</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">rect</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RawRectangleF</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">top</span><span class="p">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="m">100</span><span class="p">,</span> <span class="n">bottom</span><span class="p">:</span> <span class="m">100</span><span class="p">);</span>

            <span class="k">using</span><span class="p">(</span><span class="n">textFormat</span><span class="p">)</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">brush</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_d2dRenderTarget</span><span class="p">.</span><span class="nf">DrawText</span><span class="p">(</span><span class="s">"æ—å¾·ç†™æ˜¯é€—æ¯”"</span><span class="p">,</span> <span class="n">textFormat</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">brush</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>å¯¹äº factory åœ¨å®é™…é¡¹ç›®è¯·å†™åœ¨åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è¿›å…¥ç»˜åˆ¶æ–¹æ³•çš„æ—¶å€™éƒ½åˆ›å»ºï¼Œè¿™ä¸ªä»£ç å°†ä¼šå†…å­˜æ³„éœ²</p>

<p>åœ¨ç”»æ–‡æœ¬éœ€è¦ç”¨åˆ°å¾ˆå¤šå‚æ•°ï¼Œç”¨äºè‡ªå·±å®šåˆ¶ï¼Œè¯·å°ä¼™ä¼´è‡ªå·±ç©ä¸€ä¸‹</p>

<p>æœ‰äº†åŸºç¡€çš„ç”»ç•Œé¢å°±å¯ä»¥åšå‡ºå¥½çœ‹çš„ç•Œé¢ï¼Œå¦‚ä½•æ ¹æ®è¿™äº›ç®€å•çš„æ–¹æ³•ç”»å‡ºå¥½çœ‹çš„ç•Œé¢è¯·çœ‹ <a href="https://blog.lindexi.com/post/WPF-%E6%BA%90%E4%BB%A3%E7%A0%81-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E4%B8%80%E4%B8%AA-UI-%E6%A1%86%E6%9E%B6.html">WPF æºä»£ç  ä»é›¶å¼€å§‹å†™ä¸€ä¸ª UI æ¡†æ¶</a></p>

<p>æ›´å¤šè¯·çœ‹ <a href="https://blog.lindexi.com/post/WPF-%E4%BD%BF%E7%94%A8-SharpDx-%E6%B8%B2%E6%9F%93%E5%8D%9A%E5%AE%A2%E5%AF%BC%E8%88%AA.html">SharpDx ç³»åˆ—</a></p>

<p>ä½¿ç”¨ SharpDx ç»˜åˆ¶å¾ˆåº•å±‚ï¼Œä½†æ˜¯ç»˜åˆ¶æ€§èƒ½è¶…çº§é«˜</p>

:ET