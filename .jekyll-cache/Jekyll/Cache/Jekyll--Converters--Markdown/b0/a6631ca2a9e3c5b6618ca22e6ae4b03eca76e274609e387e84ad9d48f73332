I"K´<p>é»˜è®¤åœ¨ dotnet é‡Œé¢æ¡†æ¶æä¾›äº† Microsoft.Extensions.Logging å¯ä»¥å’Œä¾èµ–æ³¨å…¥åšæ—¥å¿—æ¡†æ¶ï¼Œè€Œæœ‰äº›ä¸šåŠ¡ï¼Œå¦‚éœ€è¦è‡ªå·±å®šåˆ¶æ—¥å¿—è¡Œä¸ºï¼Œæ­¤æ—¶å°±éœ€è¦å®šåˆ¶æ—¥å¿—</p>

<!--more-->

<!-- CreateTime:6/28/2020 7:49:17 PM -->

<p>å½“åˆå†™ä¸€ä¸ªç±»ç»§æ‰¿ ILogger æ˜¯åšä¸åˆ°å®šåˆ¶ï¼Œéœ€è¦å†å†™ä¸€ä¸ªç±»ç»§æ‰¿ ILoggerProvider æ‰å¥½åšå®šåˆ¶</p>

<p>å¦‚ä»¥ä¸‹çš„æ–¹æ³•</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CCloudConsoleLogProvider</span> <span class="p">:</span> <span class="n">ILoggerProvider</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;inheritdoc /&gt;</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="c1">/// &lt;inheritdoc /&gt;</span>
        <span class="k">public</span> <span class="n">ILogger</span> <span class="nf">CreateLogger</span><span class="p">(</span><span class="kt">string</span> <span class="n">categoryName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">CCloudConsoleLogger</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">class</span> <span class="nc">CCloudConsoleLogger</span> <span class="p">:</span> <span class="n">ILogger</span>
        <span class="p">{</span>
        	<span class="c1">// å¿½ç•¥ä»£ç </span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡ DI çš„æ³¨å…¥ï¼Œåœ¨æ³¨å…¥ä¹‹å‰å…ˆå¹²æ‰å…¶ä»–çš„ ILoggerProvider å®ä¾‹</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddLogging</span><span class="p">(</span><span class="n">builder</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">ClearProviders</span><span class="p">();</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">AddProvider</span><span class="p">(</span><span class="k">new</span> <span class="nf">CCloudConsoleLogProvider</span><span class="p">());</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ç°åœ¨æ‰€æœ‰æ‹¿åˆ°çš„ ILogger éƒ½æ˜¯ä» CCloudConsoleLogProvider åˆ›å»ºçš„</p>

<p>ä¸‹é¢æ˜¯æˆ‘å®šåˆ¶çš„ç¬¦åˆ honeycomb log è¾“å‡ºæ ¼å¼çš„æ—¥å¿—ï¼Œè¾“å‡ºå†…å®¹å¦‚ä¸‹</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="m">2099</span><span class="p">-</span><span class="m">10</span><span class="p">-</span><span class="m">19</span> <span class="m">19</span><span class="p">:</span><span class="m">07</span><span class="p">:</span><span class="m">45.456</span><span class="p">][</span><span class="n">threadName</span><span class="p">][</span><span class="n">INFO</span><span class="p">][</span><span class="err">ç±»</span><span class="p">:</span><span class="err">è¡Œæ•°</span><span class="p">][</span><span class="n">_traceId</span><span class="p">:</span><span class="n">realTraceId</span><span class="p">][</span><span class="n">_userId</span><span class="p">:</span><span class="n">realUserId</span><span class="p">][</span><span class="n">tag</span><span class="p">:</span><span class="n">custom</span><span class="p">]</span> <span class="err">ä¸šåŠ¡çš„æ—¥å¿—</span><span class="p">/</span><span class="err">å¼‚å¸¸å †æ ˆ</span>
</code></pre></div></div>

<p>å…¨éƒ¨ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CCloudConsoleLogProvider</span> <span class="p">:</span> <span class="n">ILoggerProvider</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;inheritdoc /&gt;</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="c1">/// &lt;inheritdoc /&gt;</span>
        <span class="k">public</span> <span class="n">ILogger</span> <span class="nf">CreateLogger</span><span class="p">(</span><span class="kt">string</span> <span class="n">categoryName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">CCloudConsoleLogger</span><span class="p">(</span><span class="n">categoryName</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">class</span> <span class="nc">CCloudConsoleLogger</span> <span class="p">:</span> <span class="n">ILogger</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">CCloudConsoleLogger</span><span class="p">(</span><span class="kt">string</span> <span class="n">categoryName</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_categoryName</span> <span class="p">=</span> <span class="n">categoryName</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">class</span> <span class="nc">Empty</span> <span class="p">:</span> <span class="n">IDisposable</span>
            <span class="p">{</span>
                <span class="c1">/// &lt;inheritdoc /&gt;</span>
                <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
                <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">/// &lt;inheritdoc /&gt;</span>
            <span class="k">public</span> <span class="n">IDisposable</span> <span class="n">BeginScope</span><span class="p">&lt;</span><span class="n">TState</span><span class="p">&gt;(</span><span class="n">TState</span> <span class="n">state</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">Empty</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="c1">/// &lt;inheritdoc /&gt;</span>
            <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsEnabled</span><span class="p">(</span><span class="n">LogLevel</span> <span class="n">logLevel</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_categoryName</span><span class="p">;</span>

            <span class="c1">/// &lt;inheritdoc /&gt;</span>
            <span class="k">public</span> <span class="k">void</span> <span class="n">Log</span><span class="p">&lt;</span><span class="n">TState</span><span class="p">&gt;(</span><span class="n">LogLevel</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">EventId</span> <span class="n">eventId</span><span class="p">,</span> <span class="n">TState</span> <span class="n">state</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">exception</span><span class="p">,</span>
                <span class="n">Func</span><span class="p">&lt;</span><span class="n">TState</span><span class="p">,</span> <span class="n">Exception</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">formatter</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// [2099-10-19 19:07:45.456][threadName][INFO][ç±»:è¡Œæ•°][_traceId:realTraceId][_userId:realUserId][tag:custom] ä¸šåŠ¡çš„æ—¥å¿—/å¼‚å¸¸å †æ ˆ</span>
                <span class="kt">string</span> <span class="n">message</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">TState</span><span class="p">)</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CCloudLogInfo</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">logInfo</span> <span class="p">=</span> <span class="n">state</span> <span class="k">as</span> <span class="n">CCloudLogInfo</span><span class="p">;</span>
                    <span class="n">Debug</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="n">logInfo</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">logInfo</span><span class="p">)</span> <span class="p">+</span> <span class="s">" != null"</span><span class="p">);</span>
                    <span class="n">logInfo</span><span class="p">.</span><span class="n">CategoryName</span> <span class="p">=</span> <span class="n">_categoryName</span><span class="p">;</span>
                    <span class="n">message</span> <span class="p">=</span> <span class="nf">formatter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">exception</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// [2099-10-19 19:07:45.456][threadName][INFO][ç±»:è¡Œæ•°][_traceId:realTraceId][_userId:realUserId][tag:custom] ä¸šåŠ¡çš„æ—¥å¿—/å¼‚å¸¸å †æ ˆ</span>
                    <span class="n">message</span> <span class="p">=</span>
                        <span class="s">$"[</span><span class="p">{</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">:</span><span class="n">yyyy</span><span class="p">-</span><span class="n">MM</span><span class="p">-</span><span class="n">dd</span> <span class="n">HH</span><span class="p">:</span><span class="n">mm</span><span class="p">:</span><span class="n">ss</span><span class="p">.</span><span class="n">fff</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">CCloudLogExtension</span><span class="p">.</span><span class="nf">LogLevelToString</span><span class="p">(</span><span class="n">logLevel</span><span class="p">)}</span><span class="s">][</span><span class="p">{</span><span class="n">_categoryName</span><span class="p">}</span><span class="s">][-][-][-][EventId=</span><span class="p">{</span><span class="n">eventId</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">eventId</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">] </span><span class="p">{</span><span class="nf">formatter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">exception</span><span class="p">)}</span><span class="s">"</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">class</span> <span class="nc">CCloudLogInfo</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CategoryName</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">ThreadName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ThreadId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">ClassFile</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">LineNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">TraceId</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">MemberName</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">Tags</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="n">LogLevel</span> <span class="n">LogLevel</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CCloudLogExtension</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Error</span><span class="p">(</span><span class="k">this</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">message</span><span class="p">,</span>
            <span class="n">Exception</span> <span class="n">exception</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">traceId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">userId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerMemberName</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">memberName</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerFilePath</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">sourceFilePath</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerLineNumber</span><span class="p">]</span>
            <span class="kt">int</span> <span class="n">sourceLineNumber</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
            <span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="n">LogLevel</span> <span class="n">logLevel</span> <span class="p">=</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">logInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CCloudLogInfo</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">ClassFile</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">),</span>
                <span class="n">ThreadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">,</span>
                <span class="n">ThreadName</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">LineNumber</span> <span class="p">=</span> <span class="n">sourceLineNumber</span><span class="p">,</span>
                <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">,</span>
                <span class="n">TraceId</span> <span class="p">=</span> <span class="n">traceId</span><span class="p">,</span>
                <span class="n">UserId</span> <span class="p">=</span> <span class="n">userId</span><span class="p">,</span>
                <span class="n">MemberName</span> <span class="p">=</span> <span class="n">memberName</span><span class="p">,</span>
                <span class="n">Tags</span> <span class="p">=</span> <span class="n">tags</span><span class="p">,</span>
                <span class="n">LogLevel</span> <span class="p">=</span> <span class="n">logLevel</span>
            <span class="p">};</span>

            <span class="n">logger</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">logLevel</span><span class="p">,</span> <span class="n">eventId</span><span class="p">:</span> <span class="n">EmptyEventId</span><span class="p">,</span> <span class="n">logInfo</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">Formatter</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Warning</span><span class="p">(</span><span class="k">this</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">message</span><span class="p">,</span>
            <span class="n">Exception</span> <span class="n">exception</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">traceId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">userId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerMemberName</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">memberName</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerFilePath</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">sourceFilePath</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerLineNumber</span><span class="p">]</span>
            <span class="kt">int</span> <span class="n">sourceLineNumber</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
            <span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="n">LogLevel</span> <span class="n">logLevel</span> <span class="p">=</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Warning</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">logInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CCloudLogInfo</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">ClassFile</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">),</span>
                <span class="n">ThreadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">,</span>
                <span class="n">ThreadName</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">LineNumber</span> <span class="p">=</span> <span class="n">sourceLineNumber</span><span class="p">,</span>
                <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">,</span>
                <span class="n">TraceId</span> <span class="p">=</span> <span class="n">traceId</span><span class="p">,</span>
                <span class="n">UserId</span> <span class="p">=</span> <span class="n">userId</span><span class="p">,</span>
                <span class="n">MemberName</span> <span class="p">=</span> <span class="n">memberName</span><span class="p">,</span>
                <span class="n">Tags</span> <span class="p">=</span> <span class="n">tags</span><span class="p">,</span>
                <span class="n">LogLevel</span> <span class="p">=</span> <span class="n">logLevel</span>
            <span class="p">};</span>

            <span class="n">logger</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">logLevel</span><span class="p">,</span> <span class="n">eventId</span><span class="p">:</span> <span class="n">EmptyEventId</span><span class="p">,</span> <span class="n">logInfo</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">Formatter</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ä¸ºä»€ä¹ˆåªæœ‰ Info å¯ä»¥æ·»åŠ  Exception ä¸æ·»åŠ ä¿¡æ¯ï¼Œå› ä¸ºå¦‚æœæ˜¯ Warning å’Œ Error æ¨èå†™æ˜¯å“ªä¸ªæ¨¡å—</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Info</span><span class="p">(</span><span class="k">this</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">,</span>
            <span class="n">Exception</span> <span class="n">exception</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">traceId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">userId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerMemberName</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">memberName</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerFilePath</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">sourceFilePath</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerLineNumber</span><span class="p">]</span>
            <span class="kt">int</span> <span class="n">sourceLineNumber</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
            <span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// ReSharper disable ExplicitCallerInfoArgument</span>
            <span class="nf">Info</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">traceId</span><span class="p">,</span> <span class="n">userId</span><span class="p">,</span> <span class="n">memberName</span><span class="p">,</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">sourceLineNumber</span><span class="p">,</span> <span class="n">tags</span><span class="p">);</span>
            <span class="c1">// ReSharper restore ExplicitCallerInfoArgument</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Info</span><span class="p">(</span><span class="k">this</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">,</span> 
            <span class="kt">string</span> <span class="n">message</span><span class="p">,</span>
            <span class="n">Exception</span> <span class="n">exception</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">traceId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">userId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerMemberName</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">memberName</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerFilePath</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">sourceFilePath</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerLineNumber</span><span class="p">]</span>
            <span class="kt">int</span> <span class="n">sourceLineNumber</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
            <span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// åˆšå¥½åœ¨ Linux ä¸‹æ„å»ºçš„åœ¨ Linux ä¸‹è¿è¡Œï¼Œè€Œåœ¨ Windows æ„å»ºçš„åº“åœ¨ Windows ä¸‹æ‰§è¡Œã€‚æ­¤æ—¶ä½¿ç”¨ GetFileNameWithoutExtension èƒ½ä¿æŒè¾“å…¥è·¯å¾„å’Œè§£æç›¸åŒ</span>
            <span class="c1">// å‡å®šåœ¨ Windows ä¸‹æ„å»ºè€Œåœ¨ Linux ä¸‹æ„å»ºï¼Œåªæ˜¯è®©è·¯å¾„å˜é•¿è€Œå·²ï¼Œæˆ‘ç›¸ä¿¡å’±çš„æ—¥å¿—ç³»ç»Ÿç‚¸ä¸äº†â€¦â€¦ æˆ–è€…è¯´ï¼Œç‚¸äº†å†è¯´</span>
            <span class="c1">// ç‚¸äº†çš„è§£å†³æ–¹æ³•æ˜¯åœ¨ dotnet runtime\src\libraries\System.Private.CoreLib\src\System\IO\Path.cs çš„ GetFileName æ–¹æ³•é‡Œé¢å°† `PathInternal.IsDirectorySeparator(path[i])` æ›¿æ¢ä¸ºå®é™…éœ€è¦çš„ \ æˆ– / ç¬¦å·</span>

            <span class="k">const</span> <span class="n">LogLevel</span> <span class="n">logLevel</span> <span class="p">=</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">logInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CCloudLogInfo</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">ClassFile</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">),</span>
                <span class="n">ThreadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">,</span>
                <span class="n">ThreadName</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">LineNumber</span> <span class="p">=</span> <span class="n">sourceLineNumber</span><span class="p">,</span>
                <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">,</span>
                <span class="n">TraceId</span> <span class="p">=</span> <span class="n">traceId</span><span class="p">,</span>
                <span class="n">UserId</span> <span class="p">=</span> <span class="n">userId</span><span class="p">,</span>
                <span class="n">MemberName</span> <span class="p">=</span> <span class="n">memberName</span><span class="p">,</span>
                <span class="n">Tags</span> <span class="p">=</span> <span class="n">tags</span><span class="p">,</span>
                <span class="n">LogLevel</span> <span class="p">=</span> <span class="n">logLevel</span>
            <span class="p">};</span>

            <span class="n">logger</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">logLevel</span><span class="p">,</span> <span class="n">eventId</span><span class="p">:</span> <span class="n">EmptyEventId</span><span class="p">,</span> <span class="n">logInfo</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">Formatter</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Debug</span><span class="p">(</span><span class="k">this</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">message</span><span class="p">,</span>
            <span class="n">Exception</span> <span class="n">exception</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">traceId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="kt">string</span> <span class="n">userId</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerMemberName</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">memberName</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerFilePath</span><span class="p">]</span>
            <span class="kt">string</span> <span class="n">sourceFilePath</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
            <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">CallerLineNumber</span><span class="p">]</span>
            <span class="kt">int</span> <span class="n">sourceLineNumber</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
            <span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">logInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CCloudLogInfo</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">ClassFile</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">),</span>
                <span class="n">ThreadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">,</span>
                <span class="n">ThreadName</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">LineNumber</span> <span class="p">=</span> <span class="n">sourceLineNumber</span><span class="p">,</span>
                <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">,</span>
                <span class="n">TraceId</span> <span class="p">=</span> <span class="n">traceId</span><span class="p">,</span>
                <span class="n">UserId</span> <span class="p">=</span> <span class="n">userId</span><span class="p">,</span>
                <span class="n">MemberName</span> <span class="p">=</span> <span class="n">memberName</span><span class="p">,</span>
                <span class="n">Tags</span> <span class="p">=</span> <span class="n">tags</span><span class="p">,</span>
                <span class="n">LogLevel</span> <span class="p">=</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Debug</span>
            <span class="p">};</span>

            <span class="n">logger</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">logInfo</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">,</span> <span class="n">eventId</span><span class="p">:</span> <span class="n">EmptyEventId</span><span class="p">,</span> <span class="n">logInfo</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">Formatter</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Formatter</span><span class="p">(</span><span class="n">CCloudLogInfo</span> <span class="n">logInfo</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// honeycomb-log</span>
            <span class="c1">// [2099-10-19 19:07:45.456][threadName][INFO][ç±»:è¡Œæ•°][_traceId:realTraceId][_userId:realUserId][tag:custom] ä¸šåŠ¡çš„æ—¥å¿—/å¼‚å¸¸å †æ ˆ</span>

            <span class="k">const</span> <span class="kt">string</span> <span class="n">empty</span> <span class="p">=</span> <span class="s">"-"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">traceMessage</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">logInfo</span><span class="p">.</span><span class="n">TraceId</span><span class="p">)</span> <span class="p">?</span> <span class="n">empty</span> <span class="p">:</span> <span class="s">$"_traceId:</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">TraceId</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">userMessage</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">logInfo</span><span class="p">.</span><span class="n">UserId</span><span class="p">)</span> <span class="p">?</span> <span class="n">empty</span> <span class="p">:</span> <span class="s">$"_userId:</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">UserId</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">logLevelMessage</span> <span class="p">=</span> <span class="nf">LogLevelToString</span><span class="p">(</span><span class="n">logInfo</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">logInfoMessage</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">logInfo</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span> <span class="p">?</span> <span class="n">exception</span><span class="p">?.</span><span class="n">Message</span> <span class="p">:</span> <span class="n">logInfo</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>

            <span class="k">return</span> <span class="s">$"[</span><span class="p">{</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">:</span><span class="n">yyyy</span><span class="p">-</span><span class="n">MM</span><span class="p">-</span><span class="n">dd</span> <span class="n">HH</span><span class="p">:</span><span class="n">mm</span><span class="p">:</span><span class="n">ss</span><span class="p">.</span><span class="n">sss</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">ThreadName</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">ThreadId</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">logLevelMessage</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">ClassFile</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">CategoryName</span><span class="p">}</span><span class="s">.</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">MemberName</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">logInfo</span><span class="p">.</span><span class="n">LineNumber</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">traceMessage</span><span class="p">}</span><span class="s">][</span><span class="p">{</span><span class="n">userMessage</span><span class="p">}</span><span class="s">][tags:</span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">";"</span><span class="p">,</span> <span class="n">logInfo</span><span class="p">.</span><span class="n">Tags</span><span class="p">)}</span><span class="s">] </span><span class="p">{</span><span class="n">logInfoMessage</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">exception</span><span class="p">?.</span><span class="nf">ToString</span><span class="p">()}</span><span class="s">"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">LogLevelToString</span><span class="p">(</span><span class="n">LogLevel</span> <span class="n">logLevel</span><span class="p">)</span>
            <span class="p">=&gt;</span> <span class="n">logLevel</span> <span class="k">switch</span>
            <span class="p">{</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">Trace</span> <span class="p">=&gt;</span> <span class="s">"TRACE"</span><span class="p">,</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">Debug</span> <span class="p">=&gt;</span> <span class="s">"DEBUG"</span><span class="p">,</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span> <span class="p">=&gt;</span> <span class="s">"INFO"</span><span class="p">,</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">Warning</span> <span class="p">=&gt;</span> <span class="s">"WARNING"</span><span class="p">,</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">Error</span> <span class="p">=&gt;</span> <span class="s">"ERROR"</span><span class="p">,</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">Critical</span> <span class="p">=&gt;</span> <span class="s">"CRITICAL"</span><span class="p">,</span>
                <span class="n">LogLevel</span><span class="p">.</span><span class="n">None</span> <span class="p">=&gt;</span> <span class="s">"NONE"</span><span class="p">,</span>
                <span class="n">_</span> <span class="p">=&gt;</span> <span class="s">"NONE"</span>
            <span class="p">};</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">EventId</span> <span class="n">EmptyEventId</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventId</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

:ET