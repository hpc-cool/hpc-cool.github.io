I"ë'<p>åœ¨ Windows æä¾›å¾ˆåº•å±‚çš„æ–¹æ³•æ¥æ”¶ç¡¬ä»¶è®¾å¤‡çš„è£¸æ•°æ®ï¼Œé€šè¿‡æ¥æ”¶è£¸æ•°æ®å¯ä»¥åšåˆ°æ€§èƒ½æ›´é«˜çš„å…¨å±€é”®ç›˜ï¼Œè¿˜èƒ½æ”¯æŒå¤šä¸ªé¼ æ ‡ã€‚ä½†æ˜¯ç”¨è¿™ä¸ªæ–¹æ³•éœ€è¦è‡ªå·±è§£æè£¸æ•°æ®ï¼ŒåŒæ—¶ä¼šå› ä¸ºæ¥å—åˆ°å¾ˆå¤šæ¶ˆæ¯é™ä½æ€§èƒ½</p>

<!--more-->

<!-- CreateTime:2019/11/23 16:41:52 -->

<!-- csdn -->

<p>åœ¨å¾®è½¯å®˜æ–¹å¾ˆå°‘æœ‰æ–‡æ¡£è¯´å¦‚ä½•ä½¿ç”¨<a href="https://docs.microsoft.com/en-us/windows/win32/inputdev/about-raw-input">Raw Input</a>ä¸è¿‡æˆ‘åœ¨ github ä¸Šæ‰¾åˆ°å°ä¼™ä¼´çš„ <a href="https://github.com/mfakane/rawinput-sharp">rawinput-sharp: C# wrapper library for Raw Input</a> é¡¹ç›®ï¼Œç®€å•é€šè¿‡ NuGet å®‰è£…å°±èƒ½ä½¿ç”¨</p>

<p>ä½¿ç”¨ NuGet å®‰è£… <a href="https://www.nuget.org/packages/RawInput.Sharp">RawInput.Sharp 0.0.2</a> å¦‚æœæ˜¯æ–°é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="p">&lt;</span><span class="n">PackageReference</span> <span class="n">Include</span><span class="p">=</span><span class="s">"RawInput.Sharp"</span> <span class="n">Version</span><span class="p">=</span><span class="s">"0.0.2"</span> <span class="p">/&gt;</span>
</code></pre></div></div>

<p>åœ¨ MainWindows æ³¨å†Œäº‹ä»¶ï¼Œè¯·çœ‹ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">public</span> <span class="nf">MainWindow</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">InitializeComponent</span><span class="p">();</span>

            <span class="n">SourceInitialized</span> <span class="p">+=</span> <span class="n">MainWindow_SourceInitialized</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">MainWindow_SourceInitialized</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">windowInteropHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindowInteropHelper</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">hwnd</span> <span class="p">=</span> <span class="n">windowInteropHelper</span><span class="p">.</span><span class="n">Handle</span><span class="p">;</span>

            <span class="c1">// Get the devices that can be handled with Raw Input.</span>
            <span class="kt">var</span> <span class="n">devices</span> <span class="p">=</span> <span class="n">RawInputDevice</span><span class="p">.</span><span class="nf">GetDevices</span><span class="p">();</span>

            <span class="c1">// register the keyboard device and you can register device which you need like mouse</span>
            <span class="n">RawInputDevice</span><span class="p">.</span><span class="nf">RegisterDevice</span><span class="p">(</span><span class="n">HidUsageAndPage</span><span class="p">.</span><span class="n">Keyboard</span><span class="p">,</span>
                <span class="n">RawInputDeviceFlags</span><span class="p">.</span><span class="n">ExInputSink</span> <span class="p">|</span> <span class="n">RawInputDeviceFlags</span><span class="p">.</span><span class="n">NoLegacy</span><span class="p">,</span> <span class="n">hwnd</span><span class="p">);</span>

            <span class="n">HwndSource</span> <span class="n">source</span> <span class="p">=</span> <span class="n">HwndSource</span><span class="p">.</span><span class="nf">FromHwnd</span><span class="p">(</span><span class="n">hwnd</span><span class="p">);</span>
            <span class="n">source</span><span class="p">.</span><span class="nf">AddHook</span><span class="p">(</span><span class="n">Hook</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡ RawInputDevice.GetDevices å¯ä»¥çŸ¥é“å½“å‰å¯ä»¥æ³¨å†Œçš„è®¾å¤‡æœ‰å“ªäº›ï¼Œä½¿ç”¨ RawInputDevice.RegisterDevice å¯ä»¥æ³¨å†Œäº‹ä»¶ï¼Œè¿™é‡Œæ³¨å†Œçš„æ˜¯é”®ç›˜äº‹ä»¶ï¼Œå°ä¼™ä¼´è‡ªå·±ä¿®æ”¹ HidUsageAndPage çš„å€¼å¯ä»¥æ³¨å†Œä¸åŒçš„äº‹ä»¶</p>

<p>æ³¨å†Œäº‹ä»¶å°±å¯ä»¥åœ¨ Hook å‡½æ•°æ¥æ”¶åˆ° WM_INPUT æ¶ˆæ¯ï¼Œé€šè¿‡è¿™ä¸ªæ¶ˆæ¯è§£æå°±å¯ä»¥æ‹¿åˆ°è£¸æ•°æ®ï¼Œå¯¹è£¸æ•°æ®å¤„ç†å°±å¯ä»¥æ”¶åˆ°è¾“å…¥ï¼Œå¦‚æœéœ€è¦æ¥å…¥ WPF å¯ä»¥ä½¿ç”¨<a href="https://blog.lindexi.com/post/WPF-%E6%A8%A1%E6%8B%9F%E8%A7%A6%E6%91%B8%E8%AE%BE%E5%A4%87.html">WPF æ¨¡æ‹Ÿè§¦æ‘¸è®¾å¤‡</a>å°†æ”¶åˆ°çš„æ¶ˆæ¯æ¨¡æ‹Ÿè§¦æ‘¸</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">private</span> <span class="n">IntPtr</span> <span class="nf">Hook</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hwnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">wparam</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lparam</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">bool</span> <span class="n">handled</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">WM_INPUT</span> <span class="p">=</span> <span class="m">0x00FF</span><span class="p">;</span>

            <span class="c1">// You can read inputs by processing the WM_INPUT message.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="p">==</span> <span class="n">WM_INPUT</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Create an RawInputData from the handle stored in lParam.</span>
                <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">RawInputData</span><span class="p">.</span><span class="nf">FromHandle</span><span class="p">(</span><span class="n">lparam</span><span class="p">);</span>

                <span class="c1">// You can identify the source device using Header.DeviceHandle or just Device.</span>
                <span class="kt">var</span> <span class="n">sourceDeviceHandle</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">DeviceHandle</span><span class="p">;</span>
                <span class="kt">var</span> <span class="n">sourceDevice</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Device</span><span class="p">;</span>

                <span class="c1">// The data will be an instance of either RawInputMouseData, RawInputKeyboardData, or RawInputHidData.</span>
                <span class="c1">// They contain the raw input data in their properties.</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="n">RawInputMouseData</span> <span class="n">mouse</span><span class="p">:</span>
                        <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">mouse</span><span class="p">.</span><span class="n">Mouse</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="n">RawInputKeyboardData</span> <span class="n">keyboard</span><span class="p">:</span>
                        <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">Keyboard</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="n">RawInputHidData</span> <span class="n">hid</span><span class="p">:</span>
                        <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">hid</span><span class="p">.</span><span class="n">Hid</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>ç”¨ RawInput å°±æ˜¯é€šè¿‡ <a href="https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-registerrawinputdevices?redirectedfrom=MSDN">RegisterRawInputDevices</a> å‘Šè¯‰ç³»ç»Ÿå½“å‰è¿›ç¨‹éœ€è¦æ”¯æŒè£¸æ•°æ®ï¼Œç³»ç»Ÿå°†ä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°å°†è£¸æ•°æ®è½¬å‘ç»™åº”ç”¨ã€‚åº”ç”¨åœ¨æ¶ˆæ¯è§£ææ•°æ®æ‹¿åˆ°è£¸æ•°æ®ï¼Œç„¶åæŒ‰ç…§ä¸šåŠ¡è§£æè£¸æ•°æ®ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥è§£å†³ä¸€äº›ç‰¹æ®Šè®¾å¤‡æ”¯æŒï¼Œå› ä¸º HID è®¾å¤‡æ˜¯ç‹¬å è®¾å¤‡ï¼Œåªèƒ½è®©ç³»ç»Ÿç‹¬å ï¼Œå¦‚æœæƒ³è¦åº”ç”¨ä¹Ÿæ¥æ”¶ç¡¬ä»¶å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼Œå°±éœ€è¦é¢å¤–é€šé“ç»™åº”ç”¨ã€‚å¦å¤–åº”ç”¨å¦‚æœéœ€è¦è§£å†³å…¶ä»–åº”ç”¨é’©äº†æ¶ˆæ¯ï¼Œå¯ä»¥æ³¨å†Œè£¸æ•°æ®è§£å†³å…¶ä»–åº”ç”¨å‹¾äº†é”®ç›˜æ¶ˆæ¯</p>

<p>æœ¬æ–‡çš„ä¾‹å­ä»£ç åœ¨ <a href="https://github.com/mfakane/rawinput-sharp/pull/5">github</a> æ¬¢è¿å°ä¼™ä¼´è®¿é—®</p>

<p>ç°åœ¨è¿™ä¸ªé¡¹ç›®åªæ”¯æŒ dotnet standard 2.0 æˆ‘å°†è¿™ä¸ªé¡¹ç›®å‡çº§å…¼å®¹ .NET 4.5 æˆ‘æäº¤äº† MR è¯·çœ‹ <a href="https://github.com/mfakane/rawinput-sharp/pull/3">Pull Request #3 rawinput-sharp</a> å¦‚ä½•åˆå¹¶äº†å°±èƒ½å…¼å®¹</p>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/inputdev/using-raw-input">Using Raw Input</a></p>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/inputdev/about-raw-input">About Raw Input</a></p>

:ET