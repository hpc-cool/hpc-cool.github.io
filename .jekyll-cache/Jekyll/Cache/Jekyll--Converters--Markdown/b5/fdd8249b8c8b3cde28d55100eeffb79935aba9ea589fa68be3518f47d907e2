I"1<p>æœ¬æ–‡å‘Šè¯‰å¤§å®¶å¦‚ä½•åœ¨ MSBuild é‡Œä½¿ç”¨ Copy å¤åˆ¶æ–‡ä»¶</p>

<!--more-->

<!-- CreateTime:2020/1/19 14:56:19 -->

<!-- æ ‡ç­¾ï¼šRoslyn,MSBuild,ç¼–è¯‘å™¨ -->

<p>éœ€è¦çŸ¥é“ Rosyln æ˜¯ MSBuild çš„ dotnet core ç‰ˆæœ¬ã€‚</p>

<p>åœ¨ MSBuild é‡Œå¯ä»¥ä½¿ç”¨å¾ˆå¤šå‘½ä»¤ï¼Œæœ¬æ–‡å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨ Copy è¿™ä¸ª Task æ¥å¤åˆ¶æ–‡ä»¶</p>

<p>åœ¨å¼€å§‹æœ¬æ–‡ä¹‹å‰ï¼Œå¸Œæœ›å¤§å®¶å·²ç»çŸ¥é“äº†ä¸€äº›å…³äº csproj æ–‡ä»¶æ ¼å¼ï¼Œå¦‚æœè¿˜æ˜¯ä¸çŸ¥é“ï¼Œè¯·çœ‹<a href="https://walterlv.github.io/post/understand-the-csproj.html">ç†è§£ C# é¡¹ç›® csproj æ–‡ä»¶æ ¼å¼çš„æœ¬è´¨å’Œç¼–è¯‘æµç¨‹ - walterlv</a></p>

<p>æœ€ç®€å•çš„å¤åˆ¶å‘½ä»¤è¯·çœ‹ä»£ç </p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;Copy</span> <span class="na">SourceFiles=</span><span class="s">"lindexi.txt"</span> <span class="na">DestinationFolder=</span><span class="s">"LetirNuhe\"</span> <span class="nt">&gt;&lt;/Copy&gt;</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„ï¼Œä¸è¦æŠŠ Copy ç›´æ¥å†™åœ¨ Project ä¸‹ï¼Œå¦‚ä¸‹é¢çš„ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
     &lt;!-- å¿½ç•¥ä»£ç  --&gt;
   &lt;Copy SourceFiles="lindexi.txt" DestinationFolder="LetirNuhe\" &gt;&lt;/Copy&gt;
&lt;/Project&gt;

</code></pre></div></div>

<p>å°±ä¼šå‡ºç°ä¸‹é¢å¼‚å¸¸</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">D</span><span class="p">:</span><span class="err">\æ—å¾·ç†™\ä»£ç \æµ‹è¯•ä»£ç \</span><span class="n">CemfeetoQewasXaiki</span><span class="err">\</span><span class="n">CemfeetoQewasXaiki</span><span class="p">.</span><span class="n">csproj</span> <span class="p">:</span> <span class="n">error</span>  <span class="p">:</span> <span class="err">æ— æ³•è¯†åˆ«å…ƒç´ </span> <span class="p">&lt;</span><span class="n">Project</span><span class="p">&gt;</span> <span class="err">ä¸‹é¢çš„å…ƒç´ </span> <span class="p">&lt;</span><span class="n">Copy</span><span class="p">&gt;</span><span class="err">ã€‚</span>  <span class="n">D</span><span class="p">:</span><span class="err">\æ—å¾·ç†™\ä»£ç \æµ‹è¯•ä»£ç \</span><span class="n">CemfeetoQewasXaiki</span>
</code></pre></div></div>

<p>ä¸ºäº†è¿è¡Œ Copy éœ€è¦ä½¿ç”¨ä¸‹é¢ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  &lt;Target Name="Copy" BeforeTargets="CoreCompile"&gt;
    &lt;Copy SourceFiles="LekeexelSurgooHerkassayyayTowjome.txt" DestinationFolder="LetirNuhe\"&gt;&lt;/Copy&gt;
  &lt;/Target&gt;
</code></pre></div></div>

<p>éœ€è¦çŸ¥é“ Target éœ€è¦ç»™ Name å¹¶ä¸”å‘Šè¯‰ä»–åœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œè¿™é‡Œä½¿ç”¨ BeforeTargets å‘Šè¯‰åœ¨å¼€å§‹ç¼–è¯‘å‰ï¼Œä¹Ÿå°±æ˜¯å¤åˆ¶çš„æ–‡ä»¶ä¼šè¢«ç¼–è¯‘ã€‚</p>

<p>å¯¹äºå¤åˆ¶èµ„æºæ–‡ä»¶æˆ–éœ€è¦ç¼–è¯‘çš„èµ„æºï¼Œå°±è®¾ç½® BeforeTargets åœ¨ç¼–è¯‘å‰ï¼Œå¦‚æœæ˜¯ä¸éœ€è¦è¿›è¡Œç¼–è¯‘çš„æ–‡ä»¶ï¼Œå¦‚ dll å°±å¯ä»¥è®¾ç½®åœ¨ç¼–è¯‘åè¿è¡Œã€‚</p>

<p>é‡æ–°ç”Ÿæˆé¡¹ç›®ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶å¤¹å­˜åœ¨æ–‡ä»¶</p>

<p><img src="http://image.acmx.xyz/lindexi%2F2018710103796940.jpg" alt="" /></p>

<p>å¦‚æœåˆšæ‰æ²¡æœ‰åˆ›å»º æ–‡ä»¶ï¼Œå¤åˆ¶æ—¶æ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œå°±ä¼šå‡ºç°åœ¨é‡æ–°ç¼–è¯‘å‡ºç°æ— æ³•ç¼–è¯‘</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">error</span> <span class="n">MSB3030</span><span class="p">:</span> <span class="err">æ— æ³•å¤åˆ¶æ–‡ä»¶â€œ</span><span class="n">lindexi</span><span class="p">.</span><span class="n">txt</span><span class="err">â€ï¼ŒåŸå› æ˜¯æ‰¾ä¸åˆ°è¯¥æ–‡ä»¶</span>
</code></pre></div></div>

<p>å¤åˆ¶æœ‰å¤šä¸ªæ–¹å¼ï¼Œä¸‹é¢è®©æˆ‘æ¥ä¸€ä¸ªä¸ªå’Œå¤§å®¶è¯´</p>

<h2 id="æ–‡ä»¶åˆ°æ–‡ä»¶">æ–‡ä»¶åˆ°æ–‡ä»¶</h2>

<p>ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯æœ€ç®€å•çš„ï¼Œå¤åˆ¶æ–‡ä»¶åˆ°æ–‡ä»¶</p>

<p>ä¾‹å¦‚æˆ‘éœ€è¦å¤åˆ¶ lindiexi.txt åˆ° <code class="language-plaintext highlighter-rouge">LetirNuhe\lindexi</code> ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">&lt;</span><span class="n">Target</span> <span class="n">Name</span><span class="p">=</span><span class="s">"Copy"</span> <span class="n">BeforeTargets</span><span class="p">=</span><span class="s">"CoreCompile"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">Copy</span> <span class="n">SourceFiles</span><span class="p">=</span><span class="s">"lindexi.txt"</span> <span class="n">DestinationFiles</span><span class="p">=</span><span class="s">"LetirNuhe\lindexi.txt"</span><span class="p">&gt;&lt;/</span><span class="n">Copy</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="n">Target</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>é‚£ä¹ˆå¦‚æœéœ€è¦å¤åˆ¶å¤šä¸ªæ–‡ä»¶åˆ°å¤šä¸ªæ–‡ä»¶ï¼Ÿ</p>

<p>å¯ä»¥çœ‹åˆ° SourceFiles æ˜¯å¯ä»¥è¾“å…¥å¤šä¸ªæ–‡ä»¶ï¼Œåªéœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">;</code>ä½œä¸ºå¤šä¸ªæ–‡ä»¶</p>

<p>ä¸‹é¢å¤åˆ¶ <code class="language-plaintext highlighter-rouge">lindexi.txt</code> å’Œ <code class="language-plaintext highlighter-rouge">lindexi.gitee.io.txt</code> åˆ° <code class="language-plaintext highlighter-rouge">LetirNuhe</code> æ–‡ä»¶å¤¹ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;Target Name="Copy" BeforeTargets="CoreCompile"&gt;
    &lt;Copy SourceFiles="lindexi.txt;lindexi.gitee.io.txt" DestinationFiles="LetirNuhe\lindexi.txt;LetirNuhe\lindexi.gitee.io.txt"&gt;&lt;/Copy&gt;
  &lt;/Target&gt;
</code></pre></div></div>

<p>è¿™é‡Œçš„æ–‡ä»¶æ˜¯å¯¹åº”çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯ <code class="language-plaintext highlighter-rouge">lindexi.txt</code>åœ¨ DestinationFiles ä¹Ÿéœ€è¦å†™ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯<code class="language-plaintext highlighter-rouge">lindexi.txt</code>çš„ï¼Œå¦‚æœå†™ä¸º<code class="language-plaintext highlighter-rouge">lindexi2.txt</code> ä¼šè‡ªåŠ¨æŠŠ <code class="language-plaintext highlighter-rouge">lindexi.txt</code> å¤åˆ¶å¹¶ä¸”ä¿®æ”¹åå­—ã€‚ç¬¬ä¸€ä¸ªæ–‡ä»¶å¯¹åº” DestinationFiles å†™çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯é¡¹å¯¹åº”ã€‚</p>

<p>å› ä¸ºä»æ–‡ä»¶å¤åˆ¶åˆ°æ–‡ä»¶çš„ä»£ç å¤ªå¤šäº†ï¼Œå¦‚æœåªæ˜¯éœ€è¦æŠŠæ–‡ä»¶éƒ½æ”¾åœ¨ç›¸åŒçš„æ–‡ä»¶å¤¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•</p>

<h2 id="æ–‡ä»¶åˆ°æ–‡ä»¶å¤¹">æ–‡ä»¶åˆ°æ–‡ä»¶å¤¹</h2>

<p>å¦‚æœéœ€è¦æŠŠæ–‡ä»¶éƒ½å¤åˆ¶åˆ°ç›¸åŒçš„æ–‡ä»¶å¤¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;Target Name="Copy" BeforeTargets="CoreCompile"&gt;
    &lt;Copy SourceFiles="lindexi.txt;lindexi.gitee.io.txt" DestinationFolder="LetirNuhe\"&gt;&lt;/Copy&gt;
  &lt;/Target&gt;
</code></pre></div></div>

<p>ä½¿ç”¨ DestinationFolder æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸å­˜åœ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œåˆšæ‰çš„ä»£ç ä¹Ÿæ˜¯ã€‚</p>

<h2 id="æ–‡ä»¶åˆ—è¡¨åˆ°æ–‡ä»¶å¤¹">æ–‡ä»¶åˆ—è¡¨åˆ°æ–‡ä»¶å¤¹</h2>

<p>å®é™…ä¸Šåˆšæ‰æ˜¯å†™ SourceFiles ï¼Œä½†æ˜¯å®é™…è¿™æ ·å†™æ— æ³•ä½¿ç”¨é€šé…ï¼Œä¹Ÿå°±æ˜¯<code class="language-plaintext highlighter-rouge">*.txt</code>çš„æ–¹æ³•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å°±éœ€è¦ç”¨æ–‡ä»¶åˆ—è¡¨</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Txt</span> <span class="na">Include=</span><span class="s">"*.txt"</span><span class="nt">&gt;&lt;/Txt&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

  <span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"Copy"</span> <span class="na">BeforeTargets=</span><span class="s">"CoreCompile"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Copy</span> <span class="na">SourceFiles=</span><span class="s">"@(Txt)"</span> <span class="na">DestinationFolder=</span><span class="s">"LetirNuhe\"</span><span class="nt">&gt;&lt;/Copy&gt;</span>
  <span class="nt">&lt;/Target&gt;</span>
</code></pre></div></div>

<p>å¤šä¸ªæ–‡ä»¶çš„åˆ—è¡¨æ˜¯åœ¨ ItemGroup é‡Œæ·»åŠ  ä¸€ä¸ªæ–°çš„æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾æ˜¯å¯ä»¥è‡ªå·±å®šä¹‰åå­—çš„ï¼Œæˆ‘è¿™é‡Œå®šä¹‰äº† Txt ï¼Œè®©ä»–åŒ…å«äº† <code class="language-plaintext highlighter-rouge">*.txt</code> ï¼Œç°åœ¨å°±å¯ä»¥åœ¨ SourceFiles ä½¿ç”¨ã€‚ä½¿ç”¨æ•°ç»„çš„æ–¹æ³•æ˜¯ <code class="language-plaintext highlighter-rouge">@(Txt)</code> ï¼Œé€šè¿‡ @ å’Œ æ ‡ç­¾åå°±å¯ä»¥æ‹¿åˆ°æ ‡ç­¾çš„æ–‡ä»¶ã€‚å¦‚æœè¿™æ—¶è¾“å‡º<code class="language-plaintext highlighter-rouge">@(Txt)</code> ä¼šçœ‹åˆ°ä¸‹é¢ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xx</span><span class="err">\</span><span class="n">lindexi</span><span class="p">.</span><span class="n">txt</span><span class="p">;</span><span class="n">xx</span><span class="err">\</span><span class="n">lindexi</span><span class="p">.</span><span class="n">gitee</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></div>

<p>å› ä¸º ItemGroup å¯ä»¥å†™å¤šä¸ªæ ‡ç­¾ï¼Œå¯ä»¥ä¿®æ”¹ä¸‹é¢ä»£ç </p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Txt</span> <span class="na">Include=</span><span class="s">"lindexi.txt"</span><span class="nt">&gt;&lt;/Txt&gt;</span>
    <span class="nt">&lt;Txt</span> <span class="na">Include=</span><span class="s">"lindexi.gitee.io.txt"</span><span class="nt">&gt;&lt;/Txt&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

  <span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"Copy"</span> <span class="na">BeforeTargets=</span><span class="s">"CoreCompile"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Copy</span> <span class="na">SourceFiles=</span><span class="s">"@(Txt)"</span> <span class="na">DestinationFolder=</span><span class="s">"LetirNuhe\"</span><span class="nt">&gt;&lt;/Copy&gt;</span>
  <span class="nt">&lt;/Target&gt;</span>
</code></pre></div></div>

<h2 id="è¾ƒæ–°æ‰å¤åˆ¶">è¾ƒæ–°æ‰å¤åˆ¶</h2>

<p>å¦‚æœä¸æƒ³æ¯æ¬¡ç¼–è¯‘éƒ½å¤åˆ¶ï¼Œå¯ä»¥è®¾ç½®<code class="language-plaintext highlighter-rouge">SkipUnchangedFiles="True"</code> åªæœ‰åœ¨å‘ç°æ–‡ä»¶è¾ƒæ–°æ‰å¤åˆ¶ã€‚</p>

<p>åˆ¤æ–­æ–‡ä»¶è¾ƒæ–°ä½¿ç”¨çš„æ˜¯åˆ¤æ–­ä¸¤ä¸ªæ–‡ä»¶çš„æœ€åæ›´æ”¹æ—¶é—´å’Œæ–‡ä»¶å¤§å°ã€‚</p>

<h2 id="è½¯è¿æ¥">è½¯è¿æ¥</h2>

<p>å¯ä»¥é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">UseHardlinksIfPossible="True"</code>ä¸å¤åˆ¶æ–‡ä»¶ï¼Œè€Œæ˜¯è®¾ç½®æ–‡ä»¶çš„è½¯è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶å¯ä»¥ä¸¤ä¸ªåœ°æ–¹ç”Ÿæ•ˆ</p>

<p>è®¾ç½®è½¯è¿æ¥å¯ä»¥åšåˆ°åœ¨å¤šä¸ªé¡¹ç›®çœ‹èµ·æ¥éƒ½æœ‰è‡ªå·±çš„æ–‡ä»¶ï¼Œä½†æ˜¯å®é™…éƒ½æ˜¯æŒ‡å‘ç›¸åŒçš„æ–‡ä»¶</p>

<p>éœ€è¦è¯´çš„æ˜¯ï¼Œè¿™ä¸ªæ˜¯è½¯è¿æ¥ï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿæ˜¯ç¡¬è¿æ¥æ–¹å¼ã€‚</p>

<h2 id="åˆ¤æ–­æ–‡ä»¶å­˜åœ¨å°±ä¸å¤åˆ¶">åˆ¤æ–­æ–‡ä»¶å­˜åœ¨å°±ä¸å¤åˆ¶</h2>

<p>å¦‚æœéœ€è¦åˆ¤æ–­æ–‡ä»¶å­˜åœ¨å°±ä¸å¤åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Condition</code> åˆ¤æ–­</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;Copy</span> <span class="na">SourceFiles=</span><span class="s">"@(Txt)"</span> <span class="na">DestinationFolder=</span><span class="s">"LetirNuhe\"</span> <span class="na">SkipUnchangedFiles=</span><span class="s">"True"</span> <span class="na">OverwriteReadOnlyFiles=</span><span class="s">"True"</span> <span class="na">Condition=</span><span class="s">"!Exists('LetirNuhe\lindexi.txt')"</span><span class="nt">&gt;&lt;/Copy&gt;</span>
</code></pre></div></div>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">Exists</code> åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±ä¸å¤åˆ¶ã€‚</p>

<p>æ›´å¤š MSBuild ç›¸å…³åšå®¢è¯·çœ‹</p>

<p><a href="https://walterlv.github.io/post/understand-the-csproj.html">ç†è§£ C# é¡¹ç›® csproj æ–‡ä»¶æ ¼å¼çš„æœ¬è´¨å’Œç¼–è¯‘æµç¨‹ - walterlv</a></p>

<p><a href="https://walterlv.github.io/post/create-a-cross-platform-command-based-nuget-tool.html">å¦‚ä½•åˆ›å»ºä¸€ä¸ªåŸºäºå‘½ä»¤è¡Œå·¥å…·çš„è·¨å¹³å°çš„ NuGet å·¥å…·åŒ… - walterlv</a></p>

<p><a href="https://walterlv.github.io/post/exec-task-of-msbuild-target.html">å¦‚ä½•ä½¿ç”¨ MSBuild Targetï¼ˆExecï¼‰ä¸­çš„æ§åˆ¶å°è¾“å‡º - walterlv</a></p>

<p>æ›´å¤šå…³äº Roslyn è¯·çœ‹ <a href="https://lindexi.oschina.io/lindexi/post/roslyn.html">æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Roslyn ä¿®æ”¹ç¼–è¯‘</a></p>

<p>å‚è§ï¼š<a href="https://blog.csdn.net/lindexi_gd/category_7945110.html">Roslyn å…¥é—¨ - CSDNåšå®¢</a></p>

:ET