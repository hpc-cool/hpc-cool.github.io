I"¨5<p>åœ¨å†™ msbuild è„šæœ¬çš„æ—¶å€™ï¼Œæˆ–ä¿®æ”¹é¡¹ç›®æ–‡ä»¶çš„æ—¶å€™ï¼Œå°†ä¼šä½¿ç”¨åˆ°å¾ˆå¤šçš„å¾®è½¯æä¾›çš„ Task å‘½ä»¤ã€‚åœ¨éœ€è¦å¤æ‚çš„ç¼–è¯‘çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è‡ªå·±å®šä¹‰ä¸€ä¸ªä»»åŠ¡ç”¨æ¥å®šä¹‰ç¼–è¯‘</p>

<!--more-->

<!-- CreateTime:2019/7/2 10:43:28 -->

<!-- csdn -->

<p>å¦‚ä½•å…¥é—¨å¼€å‘è¯·çœ‹ <a href="https://blog.walterlv.com/post/create-a-cross-platform-msbuild-task-based-nuget-tool.html">å¦‚ä½•åˆ›å»ºä¸€ä¸ªåŸºäº MSBuild Task çš„è·¨å¹³å°çš„ NuGet å·¥å…·åŒ… - walterlv</a> æœ¬æ–‡åªä¼šè¡¥å……ä¸€äº›å¼€å‘çš„è¿‡ç¨‹ä¼šé‡åˆ°çš„å‘</p>

<h2 id="ç‰ˆæœ¬é€‰æ‹©">ç‰ˆæœ¬é€‰æ‹©</h2>

<p>å¼€å‘çš„ Task éœ€è¦å¼•ç”¨ä»¥ä¸‹ä¸¤ä¸ªåº“</p>

<ul>
  <li>Microsoft.Build.Framework</li>
  <li>Microsoft.Build.Utilities.Core</li>
</ul>

<p>è¿™ä¹Ÿå°±é»˜è®¤è¦æ±‚ä½¿ç”¨ .NET Framework 4.7.2 å’Œ .NET Standard 2.0 ä»¥ä¸Š</p>

<h2 id="åˆ¤æ–­å½“å‰ç¼–è¯‘å™¨å¹³å°">åˆ¤æ–­å½“å‰ç¼–è¯‘å™¨å¹³å°</h2>

<p>åœ¨è·¨å¹³å°çš„å¼€å‘å¯èƒ½ç”¨æˆ·ä½¿ç”¨çš„æ˜¯ dotnet core ç‰ˆæœ¬ï¼Œäºæ˜¯éœ€è¦ä¸€ä¸ª dotnet core ç‰ˆæœ¬çš„ Task è®©ä»–è¿›è¡Œç¼–è¯‘</p>

<p>ä½¿ç”¨ä¸‹é¢ä»£ç å¯ä»¥åˆ¤æ–­å½“å‰ç‚¹ç¼–è¯‘å™¨æ˜¯è¿è¡Œåœ¨å“ªä¸ªå¹³å°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'$(MSBuildRuntimeType)' == 'Core'
</code></pre></div></div>

<p>å¦‚æœä¸Šé¢ä»£ç è¿”å› true é‚£ä¹ˆç¼–è¯‘å™¨æ˜¯ dotnet core å¹³å°</p>

<p>ä»¥ä¸Šé¢ä»£ç åˆ¤æ–­å¯ä»¥å†™å‡ºå¯¹ä½¿ç”¨ dotnet core å’Œ .NET Framework ä¸¤ä¸ªå¹³å°çš„ä¸åŒçš„ç¨‹åºé›†æ–‡ä»¶</p>

<h2 id="è°ƒç”¨æ–¹æ³•">è°ƒç”¨æ–¹æ³•</h2>

<p>å‡å®šåœ¨ç¨‹åºé›† UsingMSBuildCopyOutputFileToFastDebug.dll é‡Œé¢åŒ…å« UsingMSBuildCopyOutputFileToFastDebug.SafeOutputFileCopyTask ç±»ï¼Œè¿™ä¸ªç±»ç»§æ‰¿ Task ç±»</p>

<p>è€Œ UsingMSBuildCopyOutputFileToFastDebug.dll å­˜æ”¾åœ¨ NuGet åŒ…çš„ AssemblyFile å±æ€§ä¸‹ï¼Œè¿™ä¸ªå±æ€§çš„å®šä¹‰è¯·çœ‹ä»£ç </p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;PropertyGroup&gt;</span>
        <span class="c">&lt;!-- æˆ‘ä»¬ä½¿ç”¨ $(MSBuildRuntimeType) æ¥åˆ¤æ–­ç¼–è¯‘å™¨æ˜¯ .NET Core çš„è¿˜æ˜¯ .NET Framework çš„ã€‚
         ç„¶åé€‰ç”¨å¯¹åº”çš„æ–‡ä»¶å¤¹ã€‚--&gt;</span>
        <span class="nt">&lt;NuGetUsingMSBuildCopyOutputFileToFastDebugTaskFolder</span> <span class="na">Condition=</span><span class="s">" '$(MSBuildRuntimeType)' == 'Core'"</span><span class="nt">&gt;</span>$(MSBuildThisFileDirectory)..\tools\netcoreapp2.2\<span class="nt">&lt;/NuGetUsingMSBuildCopyOutputFileToFastDebugTaskFolder&gt;</span>
        <span class="nt">&lt;NuGetUsingMSBuildCopyOutputFileToFastDebugTaskFolder</span> <span class="na">Condition=</span><span class="s">" '$(MSBuildRuntimeType)' != 'Core'"</span><span class="nt">&gt;</span>$(MSBuildThisFileDirectory)..\tools\net48\<span class="nt">&lt;/NuGetUsingMSBuildCopyOutputFileToFastDebugTaskFolder&gt;</span>
        <span class="nt">&lt;AssemblyFile&gt;</span>$(NuGetUsingMSBuildCopyOutputFileToFastDebugTaskFolder)\UsingMSBuildCopyOutputFileToFastDebug.dll<span class="nt">&lt;/AssemblyFile&gt;</span>
    <span class="nt">&lt;/PropertyGroup&gt;</span>
</code></pre></div></div>

<p>åœ¨è°ƒç”¨ä¹‹å‰éœ€è¦å…ˆå¼•ç”¨</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">&lt;</span><span class="n">UsingTask</span> <span class="n">TaskName</span><span class="p">=</span><span class="s">"UsingMSBuildCopyOutputFileToFastDebug.SafeOutputFileCopyTask"</span> 
               <span class="n">AssemblyFile</span><span class="p">=</span><span class="s">"$(AssemblyFile)"</span> <span class="p">/&gt;</span>
</code></pre></div></div>

<p>ä¹‹åå¯ä»¥åœ¨ Target é‡Œé¢ä½¿ç”¨ SafeOutputFileCopyTask ç±»å</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">&lt;</span><span class="n">Target</span> <span class="n">Name</span><span class="p">=</span><span class="s">"CopyOutputLibToFastDebug"</span> <span class="n">AfterTargets</span><span class="p">=</span><span class="s">"AfterBuild"</span>
            <span class="n">Condition</span><span class="p">=</span><span class="s">"$(MainProjectPath)!=''"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="n">ItemGroup</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="n">OutputFileToCopy</span> <span class="n">Include</span><span class="p">=</span><span class="s">"$(OutputPath)$(AssemblyName).dll"</span><span class="p">&gt;&lt;/</span><span class="n">OutputFileToCopy</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="n">OutputFileToCopy</span> <span class="n">Include</span><span class="p">=</span><span class="s">"$(OutputPath)$(AssemblyName).pdb"</span><span class="p">&gt;&lt;/</span><span class="n">OutputFileToCopy</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="n">ItemGroup</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="n">SafeOutputFileCopyTask</span> <span class="n">SourceFiles</span><span class="p">=</span><span class="s">"@(OutputFileToCopy)"</span> <span class="n">DestinationFolder</span><span class="p">=</span><span class="s">"$(MainProjectPath)"</span><span class="p">&gt;&lt;/</span><span class="n">SafeOutputFileCopyTask</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="n">Target</span><span class="p">&gt;</span>
</code></pre></div></div>

<h2 id="å¦‚ä½•æ·»åŠ å±æ€§">å¦‚ä½•æ·»åŠ å±æ€§</h2>

<p>åœ¨ç»§æ‰¿ Microsoft.Build.Utilities.Task çš„ç±»é‡Œé¢æ·»åŠ å±æ€§å°±å¯ä»¥åœ¨ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æˆ‘æ·»åŠ äº† DestinationFolder å’Œ SourceFiles å±æ€§</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">SafeOutputFileCopyTask</span> <span class="p">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Build</span><span class="p">.</span><span class="n">Utilities</span><span class="p">.</span><span class="n">Task</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">SourceFiles</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">DestinationFolder</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Execute</span><span class="p">()</span>
        <span class="p">{</span>
        	<span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Task é‡Œé¢æ·»åŠ åˆ—è¡¨æ•°ç»„çš„æ–¹æ³•ä½¿ç”¨çš„æ˜¯æ•°ç»„ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯åˆ—è¡¨é‚£ä¹ˆåœ¨ç¼–è¯‘æ—¶å°†ä¼šæç¤º</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">lindexi</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">io</span><span class="err">\</span><span class="p">.</span><span class="n">nuget</span><span class="err">\</span><span class="n">packages</span><span class="err">\</span><span class="n">dotnetcampus</span><span class="p">.</span><span class="n">usingmsbuildcopyoutputfiletofastdebug</span><span class="err">\</span><span class="m">1.1</span><span class="p">.</span><span class="m">352</span><span class="err">\</span><span class="n">Build</span><span class="err">\</span><span class="n">dotnetCampus</span><span class="p">.</span><span class="n">UsingMSBuildCopyOutputFileToFastDebug</span><span class="p">.</span><span class="nf">targets</span><span class="p">(</span><span class="m">18</span><span class="p">,</span><span class="m">33</span><span class="p">):</span> <span class="n">error</span> <span class="n">MSB4069</span><span class="p">:</span> <span class="n">MSBuild</span> <span class="err">ä¸æ”¯æŒâ€œ</span><span class="n">SafeOutputFileCopyTask</span><span class="err">â€ä»»åŠ¡çš„â€œ</span><span class="n">SourceFiles</span><span class="err">â€å‚æ•°çš„â€œ</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="n">List</span><span class="err">`</span><span class="m">1</span><span class="p">[[</span><span class="n">System</span><span class="p">.</span><span class="n">String</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">,</span> <span class="n">Version</span><span class="p">=</span><span class="m">4.0</span><span class="p">.</span><span class="m">0.0</span><span class="p">,</span> <span class="n">Culture</span><span class="p">=</span><span class="n">neutral</span><span class="p">,</span> <span class="n">PublicKeyToken</span><span class="p">=</span><span class="m">7</span><span class="n">cec85d7bea7798e</span><span class="p">]]</span><span class="err">â€ç±»å‹ã€‚</span>
         <span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">lindexi</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">io</span><span class="err">\</span><span class="p">.</span><span class="n">nuget</span><span class="err">\</span><span class="n">packages</span><span class="err">\</span><span class="n">dotnetcampus</span><span class="p">.</span><span class="n">usingmsbuildcopyoutputfiletofastdebug</span><span class="err">\</span><span class="m">1.1</span><span class="p">.</span><span class="m">352</span><span class="err">\</span><span class="n">Build</span><span class="err">\</span><span class="n">dotnetCampus</span><span class="p">.</span><span class="n">UsingMSBuildCopyOutputFileToFastDebug</span><span class="p">.</span><span class="nf">targets</span><span class="p">(</span><span class="m">18</span><span class="p">,</span><span class="m">33</span><span class="p">):</span> <span class="n">error</span> <span class="n">MSB4026</span><span class="p">:</span> <span class="err">â€œ</span><span class="n">SafeOutputFileCopyTask</span><span class="err">â€ä»»åŠ¡çš„â€œ</span><span class="n">SourceFiles</span><span class="p">=</span><span class="err">@</span><span class="p">(</span><span class="n">OutputFileToCopy</span><span class="p">)</span><span class="err">â€å‚æ•°æ— æ•ˆã€‚</span> <span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="err">\</span><span class="n">temp</span><span class="err">\</span><span class="n">HogalcageBeganeqeale</span><span class="err">\</span><span class="n">HogalcageBeganeqeale</span><span class="p">.</span><span class="n">csproj</span><span class="p">]</span>
         <span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">lindexi</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">io</span><span class="err">\</span><span class="p">.</span><span class="n">nuget</span><span class="err">\</span><span class="n">packages</span><span class="err">\</span><span class="n">dotnetcampus</span><span class="p">.</span><span class="n">usingmsbuildcopyoutputfiletofastdebug</span><span class="err">\</span><span class="m">1.1</span><span class="p">.</span><span class="m">352</span><span class="err">\</span><span class="n">Build</span><span class="err">\</span><span class="n">dotnetCampus</span><span class="p">.</span><span class="n">UsingMSBuildCopyOutputFileToFastDebug</span><span class="p">.</span><span class="nf">targets</span><span class="p">(</span><span class="m">18</span><span class="p">,</span><span class="m">9</span><span class="p">):</span> <span class="n">error</span> <span class="n">MSB4063</span><span class="p">:</span> <span class="err">æœªèƒ½ä½¿ç”¨â€œ</span><span class="n">SafeOutputFileCopyTask</span><span class="err">â€ä»»åŠ¡çš„è¾“å…¥å‚æ•°åˆå§‹åŒ–è¯¥ä»»åŠ¡ã€‚</span>
</code></pre></div></div>

<h2 id="è¾“å‡ºæ¶ˆæ¯">è¾“å‡ºæ¶ˆæ¯</h2>

<p>è¾“å‡ºæ¶ˆæ¯è¯·ä½¿ç”¨ Console.WriteLine å°±å¯ä»¥è¾“å‡º</p>

<p>è¾“å‡ºè­¦å‘Šå’Œé”™è¯¯ä¹Ÿä½¿ç”¨ Console.WriteLine æ–¹æ³•ï¼Œåªæ˜¯éœ€è¦æ·»åŠ å‰ç¼€ <code class="language-plaintext highlighter-rouge">warning</code> å¦‚ä¸‹é¢ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"warning: ç”¨æˆ·æ²¡æœ‰ä¼ å…¥éœ€è¦å¤åˆ¶çš„æ–‡ä»¶"</span><span class="p">);</span>
</code></pre></div></div>

<p>æ›´å¤šè¯·çœ‹ <a href="https://blog.walterlv.com/post/standard-error-warning-format.html">å¦‚ä½•åœ¨ MSBuild Targetï¼ˆExecï¼‰ä¸­æŠ¥å‘Šç¼–è¯‘é”™è¯¯å’Œç¼–è¯‘è­¦å‘Š - walterlv</a></p>

<p>æœ¬æ–‡ç”¨åˆ°çš„ä»£ç å¼€æºåœ¨ Github æ¬¢è¿å…³æ³¨ <a href="https://github.com/dotnet-campus/UsingMSBuildCopyOutputFileToFastDebug">UsingMSBuildCopyOutputFileToFastDebug</a> å¦‚æœ‰é—®é¢˜æ¬¢è¿è®¨è®º</p>

:ET