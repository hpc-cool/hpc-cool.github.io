I"ôD<p>å¦‚æœè¦ä»ä¸€ä¸ªåˆ—è¡¨é‡Œé¢åˆ é™¤ä¸€äº›å…ƒç´ ï¼Œå¦‚ä½•åšæ‰èƒ½è®©æ€§èƒ½æ¯”è¾ƒé«˜ï¼Ÿç­”æ¡ˆæ˜¯ä»åˆ—è¡¨çš„åé¢å¼€å§‹åˆ èµ·ï¼Œä»ååˆ°å‰åˆ é™¤</p>

<!--more-->

<!-- CreateTime:6/13/2020 3:05:27 PM -->

<p>åœ¨ dotnet ä¸­çš„åˆ—è¡¨å­˜æ”¾çš„åº•å±‚æ˜¯ä¸€ä¸ªè¿ç»­çš„æ•°ç»„ã€‚è€Œåˆ—è¡¨åœ¨åˆ é™¤å…ƒç´ çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç§»åŠ¨æ•°ç»„çš„æ–¹å¼è®©æ•´ä¸ªåˆ—è¡¨çš„å…ƒç´ åœ¨å†…å­˜ä¸­ä¾ç„¶æ˜¯è¿ç»­çš„</p>

<p>å‡è®¾æˆ‘æœ‰ä¸€ä¸ªå¤§çš„åˆ—è¡¨ï¼Œæ­¤æ—¶æˆ‘åˆ é™¤äº†ç¬¬ä¸€é¡¹ï¼ŒæŒ‰ç…§ä¸Šé¢çš„è¯´æ³•ï¼Œåˆ—è¡¨å°±éœ€è¦å°†åé¢çš„æ‰€æœ‰é¡¹ç§»åŠ¨ä¸€æ¬¡ï¼Œè¾¾åˆ°è®©æ•´ä¸ªåˆ—è¡¨çš„å…ƒç´ åœ¨å†…å­˜æ˜¯è¿ç»­</p>

<p>è€Œå¦‚æœæ˜¯ä»åå‘å‰å¼€å§‹åˆ é™¤å‘¢ï¼Ÿæ­¤æ—¶åˆ—è¡¨å¯èƒ½å°±ä¸éœ€è¦åšç§»åŠ¨äº†ï¼Œå› ä¸ºä»ååˆ°å‰åˆ é™¤ï¼Œå¦‚æœåˆšå¥½åé¢æ¯ä¸€é¡¹éƒ½éœ€è¦åˆ é™¤ï¼Œæ­¤æ—¶çš„æ•´ä¸ªåˆ—è¡¨æ— éœ€é‡æ–°ç§»åŠ¨å…ƒç´ ã€‚è€Œå¦‚æœä¸æ˜¯æ¯ä¸€é¡¹éƒ½éœ€è¦åˆ é™¤ï¼ŒåŒæ—¶è¿™ä¸ªåˆ—è¡¨ä¸å…³æ³¨å…ƒç´ æœ¬èº«çš„é¡ºåºï¼Œé‚£ä¹ˆä¾ç„¶è¿˜å¯ä»¥ä¼˜åŒ–ï¼Œä¼˜åŒ–æ–¹æ³•æ˜¯æ‰‹åŠ¨ç§»åŠ¨å…ƒç´ </p>

<p>å‡å®šæˆ‘æ˜¯ä»åå‘å‰å¼€å§‹åˆ é™¤å…ƒç´ ï¼Œè¿™ä¸ªåˆ—è¡¨é‡Œé¢çš„å…ƒç´ ä¸å…³æ³¨å…ƒç´ æ‰€åœ¨åˆ—è¡¨çš„é¡ºåº</p>

<p>æ­¤æ—¶æˆ‘å¯ä»¥é€šè¿‡å°†æœ€åä¸€é¡¹ç§»åŠ¨åˆ°å½“å‰å‡†å¤‡åˆ é™¤çš„å…ƒç´ ä¸‹æ ‡ä¸Šï¼Œç„¶ååˆ é™¤æœ€åä¸€é¡¹çš„æ–¹æ³•ï¼Œè®©æ•´ä¸ªåˆ—è¡¨æ— éœ€ç§»åŠ¨å…ƒç´ </p>

<p>ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š</p>

<p>å‡è®¾æˆ‘æœ‰åˆ—è¡¨é‡Œé¢åŒ…å«å…ƒç´ æ˜¯ 1 2 3 ä¸‰ä¸ªå…ƒç´ </p>

<p>æ­¤æ—¶æˆ‘ä»ååˆ°å‰éå†ï¼Œå‡†å¤‡åˆ é™¤å…ƒç´ å€¼æ˜¯ 2 çš„å…ƒç´ ã€‚æ­¤æ—¶æˆ‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªå…ƒç´  3 ä¸æ»¡è¶³ï¼Œæ‰¾åˆ°ç¬¬äºŒä¸ªå…ƒç´  2 åˆšå¥½æ»¡è¶³ã€‚æ­¤æ—¶æˆ‘ä¸æ˜¯ç›´æ¥åˆ é™¤ç¬¬äºŒä¸ªå…ƒç´ ï¼Œè€Œæ˜¯å°†æœ€åä¸€ä¸ªå…ƒç´ ä¹Ÿå°±æ˜¯ 3 ç§»åŠ¨åˆ°ç¬¬äºŒä¸ªå…ƒç´ ä¸Šã€‚ç„¶ååˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ ã€‚ä¼ªä»£ç å¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var lastIndex = 2;
// å°†æœ€åä¸€ä¸ªå…ƒç´ æ›¿æ¢æ‰å‡†å¤‡ç§»é™¤çš„å…ƒç´ 
list[1] = list[lastIndex];
list.RemoveAt(lastIndex);
</code></pre></div></div>

<p>å› ä¸ºæå‰å°†æœ€åä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™å‡†å¤‡åˆ é™¤çš„å…ƒç´ ï¼Œå› æ­¤å‡†å¤‡åˆ é™¤çš„å…ƒç´ å°±æ²¡æœ‰åœ¨åˆ—è¡¨ä¸­è¢«è®°å½•ï¼Œè€Œæœ€åä¸€ä¸ªå…ƒç´ åœ¨åˆ—è¡¨ä¸­è¢«è®°å½•äº†ä¸¤æ¬¡ã€‚æ­¤æ—¶åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ å°±å¯ä»¥è®©æœ€åä¸€ä¸ªå…ƒç´ åœ¨åˆ—è¡¨ä¸­åªè®°å½•ä¸€æ¬¡ï¼Œåˆšå¥½åœ¨åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œåˆ—è¡¨ä¸éœ€è¦ç§»åŠ¨å…ƒç´ å°±èƒ½è®©åˆ—è¡¨é‡Œé¢æ‰€æœ‰å…ƒç´ ä¾ç„¶æ˜¯è¿ç»­åœ¨å†…å­˜å­˜å‚¨çš„</p>

<p>è¿™å°±æ˜¯ä»åå‘å‰åˆ é™¤åˆ—è¡¨å…ƒç´ çš„åŸç†</p>

<p>åœ¨æ•´ä¸ª dotnet çš„è¿è¡Œæ—¶åº•å±‚æœ‰å¾ˆå¤šè¿™æ ·çš„é€»è¾‘ï¼Œå¦‚<a href="https://github.com/dotnet/runtime/blob/1dca350210cbbe3333261d3c823cbbacc3d59758/src/mono/netcore/System.Private.CoreLib/src/System/Threading/TimerQueue.Browser.cs#L65-L87">è¿™æ®µä»£ç </a> å°±æ˜¯ä»åå‘å‰å¼€å§‹åˆ é™¤ï¼Œä¸‹é¢æ˜¯æˆ‘ç®€åŒ–çš„ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">timers</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="p">--</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">TimerQueue</span> <span class="n">timer</span> <span class="p">=</span> <span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="kt">long</span> <span class="n">waitDurationMs</span> <span class="p">=</span> <span class="n">timer</span><span class="p">.</span><span class="n">_scheduledDueTimeMs</span> <span class="p">-</span> <span class="n">currentTimeMs</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">waitDurationMs</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">lastIndex</span> <span class="p">=</span> <span class="n">timers</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">!=</span> <span class="n">lastIndex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">timers</span><span class="p">[</span><span class="n">lastIndex</span><span class="p">];</span>
                    <span class="p">}</span>
                    <span class="n">timers</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="n">lastIndex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>å’±ä½¿ç”¨ <a href="https://benchmarkdotnet.org/Guides/ChoosingRunStrategy.htm">BenchmarkDotNet</a> è¿›è¡Œæµ‹è¯•å¯¹æ¯”</p>

<p>å…ˆå®‰è£… <a href="https://benchmarkdotnet.org/Guides/ChoosingRunStrategy.htm">BenchmarkDotNet</a> åº“ï¼Œç„¶åç¼–å†™ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œä»£ç æ¯”è¾ƒé•¿ï¼Œæ”¾åœ¨æœ¬æ–‡æœ€å</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;ItemGroup&gt;</span>
        <span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">"BenchmarkDotNet"</span> <span class="na">Version=</span><span class="s">"0.12.1"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/ItemGroup&gt;</span>
</code></pre></div></div>

<p>å¤§æ¦‚çš„æµ‹è¯•æ•ˆæœå¦‚ä¸‹</p>

<p>ä» dotnet çš„æºä»£ç å¯ä»¥çœ‹åˆ°åˆ é™¤çš„é€»è¾‘å¤§æ¦‚å¦‚ä¸‹ï¼Œä¸‹é¢ä»£ç æœ‰åˆ å‡</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveAt</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_size</span><span class="p">--;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="n">_size</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">_items</span><span class="p">,</span> <span class="n">index</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">_items</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">_size</span> <span class="p">-</span> <span class="n">index</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">_items</span><span class="p">[</span><span class="n">_size</span><span class="p">]</span> <span class="p">=</span> <span class="k">default</span><span class="p">!;</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°å¦‚æœ index å°äº <code class="language-plaintext highlighter-rouge">_size</code> å°±è¡¨ç¤ºåˆ é™¤çš„ä¸æ˜¯æœ€åä¸€é¡¹ï¼Œå°±éœ€è¦é€šè¿‡ Array.Copy æ–¹æ³•å¤åˆ¶ä¸€æ¬¡ï¼Œè®©å­˜æ”¾çš„å…ƒç´ ä¾ç„¶è¿ç»­</p>

<p>è¿™æ˜¯æœ¬æ–‡çš„æµ‹è¯•ä»£ç </p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//var listRemoveTest = new ListRemoveTest();</span>
            <span class="c1">//var list = listRemoveTest.GetArgumentList().First();</span>
            <span class="c1">//listRemoveTest.RemoveFromEnd(list);</span>

            <span class="c1">//if (list.All(temp =&gt; temp.N &lt;= ListRemoveTest.MaxCount / 2))</span>
            <span class="c1">//{</span>

            <span class="c1">//}</span>

            <span class="n">BenchmarkRunner</span><span class="p">.</span><span class="n">Run</span><span class="p">&lt;</span><span class="n">ListRemoveTest</span><span class="p">&gt;();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">ListRemoveTest</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Benchmark</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">ArgumentsSource</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">GetArgumentList</span><span class="p">))]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveAll</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">list</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="n">temp</span> <span class="p">=&gt;</span> <span class="n">temp</span><span class="p">.</span><span class="n">N</span> <span class="p">&gt;</span> <span class="n">MaxCount</span> <span class="p">/</span> <span class="m">2</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Benchmark</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">ArgumentsSource</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">GetArgumentList</span><span class="p">))]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveFromStart</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">N</span> <span class="p">&gt;</span> <span class="n">MaxCount</span> <span class="p">/</span> <span class="m">2</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">list</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                    <span class="n">i</span><span class="p">--;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Benchmark</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">ArgumentsSource</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">GetArgumentList</span><span class="p">))]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveFromEnd</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">N</span> <span class="p">&gt;</span> <span class="n">MaxCount</span> <span class="p">/</span> <span class="m">2</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">lastIndex</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">!=</span> <span class="n">lastIndex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// å‡è®¾åˆ—è¡¨æœ‰å€¼æ˜¯ 1 10 5 è€Œå½“å‰ i = 1 è€Œ lastIndex = 2 è¦ç§»é™¤å…ƒç´  10 å¯ä»¥å…ˆå°†æœ€åä¸€ä¸ªå€¼èµ‹å€¼ç»™å½“å‰çš„å…ƒç´ </span>
                        <span class="c1">// list[1] = list[lastIndex=2] = 5</span>
                        <span class="c1">// èµ‹å€¼ä¹‹åçš„åˆ—è¡¨æ˜¯ 1 5 5 ä¹Ÿå°±æ˜¯å®é™…ä¸Šå¹²æ‰äº† 10 è¿™ä¸ªå…ƒç´ äº†</span>
                        <span class="c1">// æœ€åå†åˆ é™¤å¤šä½™çš„æœ€åä¸€ä¸ªå…ƒç´ å°±å¯ä»¥äº†</span>
                        <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">list</span><span class="p">[</span><span class="n">lastIndex</span><span class="p">];</span>
                    <span class="p">}</span>

                    <span class="n">list</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="n">lastIndex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MaxCount</span> <span class="p">=</span> <span class="m">20000000</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;&gt;</span> <span class="nf">GetArgumentList</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="n">MaxCount</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">MaxCount</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Foo</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">N</span> <span class="p">=</span> <span class="n">i</span>
                <span class="p">});</span>
                <span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Foo</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">N</span> <span class="p">=</span> <span class="n">MaxCount</span> <span class="p">-</span> <span class="n">i</span>
                <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">yield</span> <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">N</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

:ET